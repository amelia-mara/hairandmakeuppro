<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Script Breakdown - AI Enhanced</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="script-processor.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-dark: #0a0908;
            --bg-medium: rgba(18, 16, 14, 0.85);
            --card-bg: rgba(28, 25, 22, 0.5);
            --text-light: #e8e6e3;
            --text-muted: #9a8f7f;
            --accent-gold: #d4af7a;
            --accent-gold-hover: #e0c08f;
            --glass-border: rgba(255, 255, 255, 0.06);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --success: #52c186;
            --error: #ff6b6b;
            --tag-makeup: #ff6b9d;
            --tag-hair: #c084fc;
            --tag-sfx: #38bdf8;
            --tag-cast: #fbbf24;
            --tag-wardrobe: #34d399;
            --tag-props: #fb923c;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(13, 11, 10, 0.4); }
        ::-webkit-scrollbar-thumb { background: rgba(138, 127, 115, 0.3); border-radius: 4px; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #050404 0%, #0f0d0c 50%, #050404 100%);
            color: var(--text-light);
            height: 100vh;
            overflow: hidden;
        }
        .app-layout { display: flex; height: 100vh; flex-direction: column; }
        
        /* Top Bar */
        .top-bar {
            height: 60px;
            background: linear-gradient(135deg, rgba(212, 175, 122, 0.08) 0%, rgba(18, 16, 14, 0.85) 50%, rgba(212, 175, 122, 0.05) 100%);
            backdrop-filter: blur(24px);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }
        .back-link { display: flex; align-items: center; gap: 8px; color: var(--text-muted); cursor: pointer; font-size: 0.875em; }
        .back-link:hover { color: var(--accent-gold); }
        .page-title { font-size: 1.125em; font-weight: 600; }
        .toolbar-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8125em;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .toolbar-btn:hover { border-color: var(--accent-gold); color: var(--accent-gold); }
        .toolbar-btn.primary { background: var(--accent-gold); border-color: var(--accent-gold); color: #0a0908; font-weight: 600; }
        .toolbar-btn.ai { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-color: #667eea; color: white; font-weight: 600; }
        
        /* Layout */
        .main-content { display: flex; flex: 1; overflow: hidden; }
        .left-sidebar, .right-sidebar {
            width: 300px;
            background: linear-gradient(135deg, rgba(212, 175, 122, 0.06) 0%, rgba(18, 16, 14, 0.85) 50%, rgba(212, 175, 122, 0.03) 100%);
            backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .right-sidebar { width: 380px; }
        
        /* Sidebar Elements */
        .sidebar-header { padding: 16px 20px; border-bottom: 1px solid var(--glass-border); }
        .sidebar-title { font-size: 0.875em; font-weight: 600; text-transform: uppercase; color: var(--text-muted); margin-bottom: 12px; }
        .scene-search {
            width: 100%;
            padding: 10px 14px;
            background: rgba(10, 9, 8, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 0.8125em;
        }
        .scene-search:focus { outline: none; border-color: var(--accent-gold); }
        .scene-list { flex: 1; overflow-y: auto; padding: 12px; }
        .scene-item {
            background: rgba(28, 25, 22, 0.5);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .scene-item:hover { border-color: var(--accent-gold); transform: translateX(4px); }
        .scene-item.active { border-color: var(--accent-gold); background: rgba(201, 169, 97, 0.15); }
        .scene-number {
            width: 28px;
            height: 28px;
            background: var(--accent-gold);
            color: #0a0908;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.8125em;
            margin-bottom: 8px;
        }
        .scene-heading { font-size: 0.8125em; font-weight: 600; line-height: 1.3; }
        
        /* Center Panel */
        .center-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .script-toolbar {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 20px;
            background: var(--bg-medium);
            border-bottom: 1px solid var(--glass-border);
        }
        .tag-legend { display: flex; gap: 16px; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.75em; color: var(--text-muted); }
        .legend-color { width: 12px; height: 12px; border-radius: 3px; }
        .script-viewer { flex: 1; overflow-y: auto; padding: 40px; background: rgba(232, 230, 227, 0.03); }
        .script-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(248, 246, 240, 0.98);
            padding: 60px 80px;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }
        .script-content { font-family: 'Courier Prime', monospace; font-size: 12pt; line-height: 1.5; color: #000; user-select: text; }
        .script-scene { margin-bottom: 24px; }
        .script-scene-heading { font-weight: 700; text-transform: uppercase; margin-bottom: 12px; color: #000; }
        .script-action { margin-bottom: 12px; color: #000; }
        .script-character { margin: 12px 0 4px; text-align: center; text-transform: uppercase; color: #000; }
        .script-dialogue { margin-bottom: 12px; width: 70%; margin-left: 15%; color: #000; }
        .script-parenthetical { margin-bottom: 4px; width: 60%; margin-left: 20%; color: #000; }
        .script-transition { text-align: right; margin: 20px 0; font-weight: 600; color: #000; }
        
        /* Debug Panel */
        .debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 16px;
            max-width: 400px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }
        .debug-panel.active { display: block; }
        .debug-title { font-weight: 600; margin-bottom: 8px; color: var(--accent-gold); }
        .debug-info { font-size: 0.75em; font-family: monospace; color: var(--text-muted); }
        
        /* Loading State */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 9, 8, 0.9);
            backdrop-filter: blur(12px);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }
        .loading-overlay.active { display: flex; }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(212, 175, 122, 0.2);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--glass-border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin: 20px;
            background: var(--card-bg);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: var(--accent-gold);
            background: rgba(201, 169, 97, 0.05);
        }
        .upload-area.dragover {
            border-color: var(--accent-gold);
            background: rgba(201, 169, 97, 0.1);
        }
        
        /* Error State */
        .error-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
        }
        .error-icon { font-size: 4em; margin-bottom: 20px; }
        .error-message { font-size: 1.125em; font-weight: 600; margin-bottom: 8px; }
        .error-hint { font-size: 0.875em; color: var(--text-muted); margin-bottom: 20px; line-height: 1.6; max-width: 600px; }
    </style>
</head>
<body>
    <div class="app-layout">
        <div class="top-bar">
            <div style="display: flex; align-items: center; gap: 24px;">
                <div onclick="goBack()" class="back-link">‚Üê Dashboard</div>
                <h1 class="page-title" id="projectTitle">Script Breakdown</h1>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="toolbar-btn" onclick="toggleDebug()">üêõ Debug</button>
                <button class="toolbar-btn" onclick="reloadScript()">üîÑ Reload Script</button>
                <button class="toolbar-btn" onclick="uploadNewScript()">üì§ Upload Script</button>
                <button class="toolbar-btn ai" onclick="runAIAnalysis()">ü§ñ AI Auto-Tag</button>
                <button class="toolbar-btn primary" onclick="generateBreakdown()">‚ú® Generate</button>
            </div>
        </div>
        <div class="main-content">
            <div class="left-sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">Scenes (<span id="sceneCount">0</span>)</div>
                    <input type="text" class="scene-search" placeholder="Search scenes..." id="sceneSearch">
                </div>
                <div class="scene-list" id="sceneList">
                    <div class="error-state">
                        <div class="error-icon">üìÑ</div>
                        <div class="error-message">No scenes found</div>
                    </div>
                </div>
            </div>
            <div class="center-panel">
                <div class="script-toolbar">
                    <div class="tag-legend">
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-makeup)"></div>Makeup</div>
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-hair)"></div>Hair</div>
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-sfx)"></div>SFX</div>
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-cast)"></div>Cast</div>
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-wardrobe)"></div>Wardrobe</div>
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-props)"></div>Props</div>
                    </div>
                </div>
                <div class="script-viewer">
                    <div class="script-container">
                        <div class="script-content" id="scriptContent">
                            <div id="uploadArea" class="upload-area">
                                <div class="error-icon">üìú</div>
                                <div class="error-message">Drop Script Here</div>
                                <div class="error-hint">
                                    Drag and drop a script file here, or click to browse<br>
                                    Supported formats: .txt, .fountain, .fdx, .pdf
                                </div>
                                <input type="file" id="fileInput" accept=".txt,.fountain,.fdx,.pdf" style="display: none;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="right-sidebar">
                <!-- Tags panel would go here -->
            </div>
        </div>
    </div>
    
    <!-- Debug Panel -->
    <div class="debug-panel" id="debugPanel">
        <div class="debug-title">üêõ Debug Info</div>
        <div class="debug-info" id="debugInfo"></div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div style="color: var(--text-light); font-weight: 600;" id="loadingText">Processing script...</div>
    </div>

    <script>
        // Initialize PDF.js
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // Global variables
        let currentProject = null;
        let scriptProcessor = null;
        let parsedScript = null;
        let currentScene = 0;

        // Initialize
        async function init() {
            console.log('üöÄ Initializing Script Breakdown...');
            
            // Initialize processor
            scriptProcessor = new ScriptProcessor();
            
            // Load current project
            currentProject = JSON.parse(localStorage.getItem('currentProject') || 'null');
            
            if (!currentProject) {
                console.error('‚ùå No project found');
                showError('No project selected', 'Please return to the projects page and select a project');
                return;
            }
            
            console.log('‚úÖ Project loaded:', currentProject.title);
            document.getElementById('projectTitle').textContent = currentProject.title + ' - Script Breakdown';
            
            // Try to load processed script first
            const projectId = currentProject.title.replace(/\s+/g, '_').toLowerCase();
            const processedScript = scriptProcessor.loadScriptData(projectId);
            
            if (processedScript) {
                console.log('‚úÖ Found processed script in storage');
                parsedScript = processedScript;
                displayScript();
            } else if (currentProject.scriptContent) {
                console.log('üìÑ Found raw script content, processing...');
                processScript(currentProject.scriptContent);
            } else {
                console.log('‚ö†Ô∏è No script content found');
                setupUploadArea();
            }
            
            // Setup event listeners
            document.getElementById('sceneSearch').addEventListener('input', handleSceneSearch);
        }

        // Setup upload area
        function setupUploadArea() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            if (!uploadArea) return;
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', async (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const file = e.dataTransfer.files[0];
                if (file) {
                    await handleFileUpload(file);
                }
            });
            
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    await handleFileUpload(file);
                }
            });
        }

        // Handle file upload
        async function handleFileUpload(file) {
            console.log('üìÅ Uploading file:', file.name);
            showLoading('Reading file...');
            
            try {
                let scriptText = '';
                
                if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
                    showLoading('Extracting text from PDF...');
                    scriptText = await scriptProcessor.extractPDFText(file);
                } else {
                    scriptText = await file.text();
                }
                
                // Save to current project
                currentProject.scriptContent = scriptText;
                currentProject.scriptName = file.name;
                localStorage.setItem('currentProject', JSON.stringify(currentProject));
                
                // Process the script
                processScript(scriptText);
                
            } catch (error) {
                console.error('Upload error:', error);
                hideLoading();
                alert('Error reading file: ' + error.message);
            }
        }

        // Process script text
        function processScript(scriptText) {
            showLoading('Parsing screenplay...');
            updateDebug(`Processing ${scriptText.length} characters...`);
            
            try {
                // Parse the script
                parsedScript = scriptProcessor.parseScreenplay(scriptText);
                
                if (parsedScript.scenes.length === 0) {
                    hideLoading();
                    showError(
                        'No scenes detected',
                        'The script parser couldn\'t find any scene headings. Please ensure your script uses standard formatting.'
                    );
                    return;
                }
                
                // Save processed script
                const projectId = currentProject.title.replace(/\s+/g, '_').toLowerCase();
                scriptProcessor.saveScriptData(projectId, parsedScript);
                
                // Display the script
                displayScript();
                hideLoading();
                
                updateDebug(`‚úÖ Found ${parsedScript.scenes.length} scenes`);
                
            } catch (error) {
                console.error('Processing error:', error);
                hideLoading();
                showError('Processing Error', error.message);
            }
        }

        // Display parsed script
        function displayScript() {
            if (!parsedScript || !parsedScript.scenes) return;
            
            // Update scene count
            document.getElementById('sceneCount').textContent = parsedScript.scenes.length;
            
            // Generate scene list
            const sceneList = document.getElementById('sceneList');
            sceneList.innerHTML = '';
            
            parsedScript.scenes.forEach((scene, index) => {
                const sceneItem = document.createElement('div');
                sceneItem.className = 'scene-item';
                if (index === 0) sceneItem.classList.add('active');
                sceneItem.onclick = () => scrollToScene(index);
                
                sceneItem.innerHTML = `
                    <div class="scene-number">${index + 1}</div>
                    <div class="scene-heading">${scene.text}</div>
                `;
                
                sceneList.appendChild(sceneItem);
            });
            
            // Generate script HTML
            const scriptHTML = scriptProcessor.formatScriptHTML(parsedScript);
            document.getElementById('scriptContent').innerHTML = scriptHTML;
            
            // Update characters in metadata
            if (parsedScript.metadata.characters.length > 0) {
                updateDebug(`Characters: ${parsedScript.metadata.characters.slice(0, 5).join(', ')}...`);
            }
        }

        // Scroll to scene
        function scrollToScene(sceneIndex) {
            currentScene = sceneIndex;
            
            // Update active state
            document.querySelectorAll('.scene-item').forEach((item, index) => {
                if (index === sceneIndex) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // Scroll to scene
            const sceneElement = document.getElementById(`scene-${sceneIndex + 1}`);
            if (sceneElement) {
                sceneElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Handle scene search
        function handleSceneSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            const sceneItems = document.querySelectorAll('.scene-item');
            
            sceneItems.forEach((item, index) => {
                const heading = parsedScript.scenes[index].text.toLowerCase();
                if (heading.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Upload new script
        function uploadNewScript() {
            document.getElementById('fileInput').click();
        }

        // Reload script
        function reloadScript() {
            if (currentProject && currentProject.scriptContent) {
                processScript(currentProject.scriptContent);
            } else {
                alert('No script to reload');
            }
        }

        // Debug functions
        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            panel.classList.toggle('active');
        }

        function updateDebug(info) {
            const debugInfo = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.innerHTML = `[${timestamp}] ${info}<br>` + debugInfo.innerHTML;
        }

        // UI Helper functions
        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function showError(title, message) {
            document.getElementById('scriptContent').innerHTML = `
                <div class="error-state">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <div class="error-message">${title}</div>
                    <div class="error-hint">${message}</div>
                    <button class="toolbar-btn primary" onclick="uploadNewScript()">Upload Script</button>
                </div>
            `;
        }

        function goBack() {
            window.location.href = 'dashboard.html';
        }

        function generateBreakdown() {
            if (!parsedScript) {
                alert('Please load a script first');
                return;
            }
            alert(`Ready to generate breakdown for ${parsedScript.scenes.length} scenes`);
        }

        async function runAIAnalysis() {
            if (!parsedScript) {
                alert('Please load a script first');
                return;
            }
            alert('AI analysis would run here');
        }

        // Initialize on page load
        init();
    </script>
</body>
</html>
