<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master H&MU Breakdown</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0d0b0a;
            --bg-medium: rgba(26, 22, 18, 0.7);
            --card-bg: #242019;
            --text-light: #e8e6e3;
            --text-muted: #8a7f73;
            --accent-gold: #c9a961;
            --border: rgba(45, 41, 37, 0.5);
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0d0b0a 0%, #1a1612 50%, #0d0b0a 100%);
            color: var(--text-light);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Top Bar */
        .top-bar {
            height: 60px;
            background: var(--bg-medium);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 100;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-link {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.875em;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--accent-gold);
        }

        .page-title {
            font-size: 1.125em;
            font-weight: 600;
        }

        .project-name {
            color: var(--accent-gold);
            font-size: 0.875em;
            margin-left: 8px;
        }

        .top-bar-right {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8125em;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
            color: var(--bg-dark);
        }

        .btn-primary:hover {
            background: #d4b16d;
        }

        /* Toolbar */
        .toolbar {
            height: 48px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 24px;
            gap: 8px;
        }

        .toolbar-separator {
            width: 1px;
            height: 24px;
            background: var(--border);
            margin: 0 8px;
        }

        .toolbar-label {
            color: var(--text-muted);
            font-size: 0.8125em;
            margin-right: 8px;
        }

        .toolbar-select {
            padding: 6px 12px;
            background: var(--bg-medium);
            border: 1px solid var(--glass-border);
            border-radius: 4px;
            color: var(--text-light);
            font-size: 0.8125em;
            cursor: pointer;
        }

        /* Sheet Container */
        .sheet-container {
            flex: 1;
            overflow: auto;
            background: var(--card-bg);
            position: relative;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 1.25em;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-light);
        }

        .empty-state-desc {
            font-size: 0.875em;
            margin-bottom: 24px;
        }

        /* Spreadsheet Table */
        .breakdown-sheet {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8125em;
            table-layout: fixed;
        }

        .breakdown-sheet th,
        .breakdown-sheet td {
            border: 1px solid var(--border);
            padding: 8px 10px;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .breakdown-sheet th {
            background: var(--bg-medium);
            backdrop-filter: blur(20px);
            font-weight: 600;
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Row number column */
        .row-num {
            width: 40px;
            background: var(--bg-medium);
            text-align: center;
            cursor: pointer;
            user-select: none;
            color: var(--text-muted);
            font-size: 0.75em;
        }

        .row-num:hover {
            background: rgba(201, 169, 97, 0.2);
        }

        /* Column widths */
        .col-scene { width: 60px; }
        .col-character { width: 130px; }
        .col-category { width: 90px; }
        .col-day { width: 70px; }
        .col-time { width: 80px; }
        .col-int-ext { width: 70px; }
        .col-location { width: 150px; }
        .col-synopsis { width: 200px; }
        .col-look-arc { width: 120px; background: rgba(201, 169, 97, 0.05); }
        .col-hair { width: 150px; background: rgba(168, 85, 247, 0.05); }
        .col-makeup { width: 150px; background: rgba(236, 72, 153, 0.05); }
        .col-eye-bags { width: 100px; background: rgba(236, 72, 153, 0.05); }
        .col-lesions { width: 100px; background: rgba(239, 68, 68, 0.05); }
        .col-beard { width: 100px; background: rgba(168, 85, 247, 0.05); }
        .col-wounds { width: 150px; background: rgba(239, 68, 68, 0.05); }
        .col-notes { width: 200px; }

        /* Editable cells */
        .breakdown-sheet td {
            background: var(--card-bg);
        }

        .breakdown-sheet td[contenteditable="true"] {
            cursor: text;
        }

        .breakdown-sheet td[contenteditable="true"]:hover {
            background: rgba(201, 169, 97, 0.05);
        }

        .breakdown-sheet td[contenteditable="true"]:focus {
            outline: 2px solid var(--accent-gold);
            background: rgba(201, 169, 97, 0.08);
            white-space: normal;
        }

        /* Scene grouping */
        tr.scene-header {
            background: rgba(201, 169, 97, 0.1);
        }

        tr.scene-header td {
            font-weight: 600;
            background: rgba(201, 169, 97, 0.1);
            white-space: normal;
        }

        /* Selected rows */
        tr.selected {
            background: rgba(201, 169, 97, 0.2) !important;
        }

        tr.selected td {
            background: rgba(201, 169, 97, 0.2) !important;
        }

        /* Badges */
        .scene-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: 600;
        }

        .int-day { background: rgba(255, 193, 7, 0.2); color: #fbbf24; }
        .int-night { background: rgba(63, 81, 181, 0.2); color: #5c6bc0; }
        .ext-day { background: rgba(76, 175, 80, 0.2); color: #66bb6a; }
        .ext-night { background: rgba(103, 58, 183, 0.2); color: #9575cd; }

        .category-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: 600;
        }

        .category-badge.lead { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .category-badge.supporting { background: rgba(201, 169, 97, 0.2); color: var(--accent-gold); }
        .category-badge.day_player { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .category-badge.background { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }

        /* Status bar */
        .status-bar {
            height: 32px;
            background: var(--bg-medium);
            border-top: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            padding: 0 24px;
            font-size: 0.75em;
            color: var(--text-muted);
            gap: 16px;
        }

        /* Export Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
        }

        .modal-title {
            font-size: 1.25em;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .modal-section {
            margin-bottom: 16px;
        }

        .modal-label {
            display: block;
            font-size: 0.875em;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }

        .export-option {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-option:hover {
            background: rgba(201, 169, 97, 0.1);
            border-color: var(--accent-gold);
        }

        .export-option-icon {
            font-size: 24px;
            margin-right: 12px;
        }

        .export-option-info {
            flex: 1;
        }

        .export-option-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .export-option-desc {
            font-size: 0.8125em;
            color: var(--text-muted);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(13, 11, 10, 0.4);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(138, 127, 115, 0.4);
            border-radius: 5px;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 80px;
            right: 24px;
            padding: 12px 24px;
            background: var(--card-bg);
            border: 1px solid var(--accent-gold);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 0.875em;
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="top-bar-left">
                <a href="script-breakdown.html" class="back-link">Back to Script</a>
                <h1 class="page-title">Master H&MU Breakdown</h1>
                <span class="project-name" id="projectName"></span>
            </div>
            <div class="top-bar-right">
                <button class="btn" onclick="refreshData()">Refresh</button>
                <button class="btn" onclick="saveBreakdown()">Save</button>
                <button class="btn btn-primary" onclick="showExportModal()">Export</button>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <span class="toolbar-label">Filter by Character:</span>
            <select class="toolbar-select" id="characterFilter" onchange="filterByCharacter()">
                <option value="all">All Characters</option>
            </select>

            <div class="toolbar-separator"></div>

            <span class="toolbar-label">Filter by Category:</span>
            <select class="toolbar-select" id="categoryFilter" onchange="filterByCategory()">
                <option value="all">All Categories</option>
                <option value="LEAD">Lead Roles</option>
                <option value="SUPPORTING">Supporting</option>
                <option value="DAY_PLAYER">Day Players</option>
            </select>

            <div class="toolbar-separator"></div>

            <span class="toolbar-label">Story Day:</span>
            <select class="toolbar-select" id="dayFilter" onchange="filterByDay()">
                <option value="all">All Days</option>
            </select>

            <div class="toolbar-separator"></div>

            <button class="btn" onclick="collapseAllScenes()">Collapse All</button>
            <button class="btn" onclick="expandAllScenes()">Expand All</button>
        </div>

        <!-- Spreadsheet Container -->
        <div class="sheet-container" id="sheetContainer">
            <div class="empty-state" id="emptyState">
                <div class="empty-state-icon">ðŸ“‹</div>
                <div class="empty-state-title">No Breakdown Data</div>
                <div class="empty-state-desc">Import a script and confirm characters to generate the breakdown</div>
                <a href="script-breakdown.html" class="btn btn-primary">Go to Script Import</a>
            </div>

            <table class="breakdown-sheet" id="breakdownTable" style="display: none;">
                <thead>
                    <tr>
                        <th class="row-num">#</th>
                        <th class="col-scene">Scene</th>
                        <th class="col-character">Character</th>
                        <th class="col-category">Category</th>
                        <th class="col-day">Story Day</th>
                        <th class="col-time">Time</th>
                        <th class="col-int-ext">INT/EXT</th>
                        <th class="col-location">Location</th>
                        <th class="col-synopsis">Synopsis</th>
                        <th class="col-look-arc">Look Arc</th>
                        <th class="col-hair">Hair</th>
                        <th class="col-makeup">Makeup Base</th>
                        <th class="col-eye-bags">Eye Bags</th>
                        <th class="col-lesions">Lesions</th>
                        <th class="col-beard">Beard</th>
                        <th class="col-wounds">Wounds/Blood/SFX</th>
                        <th class="col-notes">Notes</th>
                    </tr>
                </thead>
                <tbody id="breakdownBody">
                </tbody>
            </table>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <span id="statusText">Ready</span>
            <span>|</span>
            <span id="rowCount">0 rows</span>
            <span>|</span>
            <span id="characterCount">0 characters</span>
            <span>|</span>
            <span id="sceneCount">0 scenes</span>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-title">Export Breakdown</div>

            <div class="modal-section">
                <div class="export-option" onclick="exportToTSV()">
                    <span class="export-option-icon">ðŸ“Š</span>
                    <div class="export-option-info">
                        <div class="export-option-title">Export as TSV</div>
                        <div class="export-option-desc">Tab-separated values for Google Sheets</div>
                    </div>
                </div>

                <div class="export-option" onclick="exportToCSV()">
                    <span class="export-option-icon">ðŸ“ˆ</span>
                    <div class="export-option-info">
                        <div class="export-option-title">Export as CSV</div>
                        <div class="export-option-desc">Comma-separated values for Excel</div>
                    </div>
                </div>

                <div class="export-option" onclick="exportToPDF()">
                    <span class="export-option-icon">ðŸ“„</span>
                    <div class="export-option-info">
                        <div class="export-option-title">Export as PDF</div>
                        <div class="export-option-desc">Printable document format</div>
                    </div>
                </div>

                <div class="export-option" onclick="copyToClipboard()">
                    <span class="export-option-icon">ðŸ“‹</span>
                    <div class="export-option-info">
                        <div class="export-option-title">Copy to Clipboard</div>
                        <div class="export-option-desc">Quick paste into any application</div>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn" onclick="closeExportModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let breakdownData = [];
        let scenes = [];
        let characters = {};
        let characterCategories = {};
        let masterContext = null;
        let storyTimeline = null;

        // ============================================================================
        // INITIALIZATION
        // ============================================================================

        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });

        function loadData() {
            console.log('Loading breakdown data...');

            // Load master context
            const masterContextStr = localStorage.getItem('masterContext') ||
                                    localStorage.getItem('scriptMasterContext');
            if (masterContextStr) {
                try {
                    masterContext = JSON.parse(masterContextStr);
                    console.log('Master context loaded:', masterContext);
                } catch (e) {
                    console.error('Failed to parse master context:', e);
                }
            }

            // Load scenes
            const currentProject = localStorage.getItem('currentProject');
            if (currentProject) {
                try {
                    const project = JSON.parse(currentProject);
                    document.getElementById('projectName').textContent = project.name || 'Untitled Project';
                } catch (e) {}
            }

            // Try to load from checksHappyBreakdown (saved breakdown data)
            const savedBreakdown = localStorage.getItem('checksHappyBreakdown');
            if (savedBreakdown) {
                try {
                    breakdownData = JSON.parse(savedBreakdown);
                    console.log('Loaded saved breakdown:', breakdownData.length, 'rows');
                } catch (e) {
                    console.error('Failed to parse saved breakdown:', e);
                }
            }

            // If no saved breakdown, generate from master context
            if (breakdownData.length === 0 && masterContext) {
                generateBreakdownFromContext();
            }

            if (breakdownData.length > 0) {
                populateFilters();
                renderBreakdownTable();
                updateStatusBar();
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('breakdownTable').style.display = 'table';
            }
        }

        // ============================================================================
        // BREAKDOWN GENERATION
        // ============================================================================

        function generateBreakdownFromContext() {
            if (!masterContext) {
                console.warn('No master context available');
                return;
            }

            console.log('Generating breakdown from master context...');

            breakdownData = [];
            characters = masterContext.characters || {};
            storyTimeline = masterContext.storyStructure?.timeline || [];

            // Get confirmed characters
            const confirmedChars = Object.keys(characters);
            if (confirmedChars.length === 0) {
                console.warn('No characters in master context');
                return;
            }

            // Build story day lookup
            const sceneToDay = {};
            storyTimeline.forEach(day => {
                if (day.scenes) {
                    day.scenes.forEach(sceneNum => {
                        sceneToDay[sceneNum] = day.story_day || day.day;
                    });
                }
            });

            // Get all scenes from localStorage
            const scenesStr = localStorage.getItem('checksHappyScenes');
            if (scenesStr) {
                try {
                    scenes = JSON.parse(scenesStr);
                } catch (e) {}
            }

            // If no scenes in storage, create from master context
            if (scenes.length === 0) {
                scenes = Array.from({ length: masterContext.totalScenes || 0 }, (_, i) => ({
                    number: i + 1,
                    heading: '',
                    content: ''
                }));
            }

            // Generate breakdown rows for each scene/character combination
            scenes.forEach((scene, sceneIndex) => {
                const sceneNum = scene.number || (sceneIndex + 1);
                const heading = scene.heading || '';

                // Parse scene heading
                const intExt = /^(INT|EXT|INT\.\/EXT)/i.exec(heading)?.[0] || '';
                const timeMatch = heading.match(/\b(DAY|NIGHT|MORNING|AFTERNOON|EVENING|DAWN|DUSK)\b/i);
                const timeOfDay = timeMatch ? timeMatch[0].toUpperCase() : '';
                const location = extractLocation(heading);
                const storyDay = sceneToDay[sceneNum] || null;

                // Find characters in this scene
                confirmedChars.forEach(charName => {
                    const charData = characters[charName];
                    const scenesPresent = charData.scenesPresent ||
                                         charData.storyPresence?.scenesPresent || [];

                    // Check if character is in this scene
                    if (scenesPresent.includes(sceneNum) ||
                        (charData.firstAppearance <= sceneNum && charData.lastAppearance >= sceneNum)) {

                        const category = charData.category ||
                                        charData.characterAnalysis?.role?.toUpperCase() ||
                                        'SUPPORTING';

                        breakdownData.push({
                            rowId: `${sceneNum}-${charName}`,
                            sceneNum: sceneNum,
                            sceneHeading: heading,
                            character: charName,
                            category: category,
                            storyDay: storyDay,
                            timeOfDay: timeOfDay,
                            intExt: intExt,
                            location: location,
                            synopsis: scene.synopsis || '',
                            lookArc: '',
                            hair: '',
                            makeupBase: '',
                            eyeBags: '',
                            lesions: '',
                            beard: '',
                            woundsSFX: '',
                            notes: ''
                        });
                    }
                });
            });

            // Sort by scene number then character
            breakdownData.sort((a, b) => {
                if (a.sceneNum !== b.sceneNum) return a.sceneNum - b.sceneNum;
                return a.character.localeCompare(b.character);
            });

            console.log('Generated breakdown:', breakdownData.length, 'rows');
        }

        function extractLocation(heading) {
            if (!heading) return '';
            // Remove INT/EXT and time indicators
            let loc = heading.replace(/^(INT|EXT|INT\.\/EXT)\.?\s*/i, '');
            loc = loc.replace(/\s*-\s*(DAY|NIGHT|MORNING|AFTERNOON|EVENING|DAWN|DUSK|CONTINUOUS|SAME|LATER|MOMENTS LATER).*$/i, '');
            return loc.trim();
        }

        // ============================================================================
        // RENDERING
        // ============================================================================

        function renderBreakdownTable() {
            const tbody = document.getElementById('breakdownBody');
            if (!tbody) return;

            let html = '';
            let currentScene = null;
            let rowNum = 0;

            breakdownData.forEach((row, index) => {
                // Add scene header if new scene
                if (row.sceneNum !== currentScene) {
                    currentScene = row.sceneNum;
                    rowNum++;
                    html += `
                        <tr class="scene-header" data-scene="${row.sceneNum}">
                            <td class="row-num">${rowNum}</td>
                            <td>${row.sceneNum}</td>
                            <td colspan="15"><strong>${row.sceneHeading || `Scene ${row.sceneNum}`}</strong></td>
                        </tr>
                    `;
                }

                rowNum++;
                const badgeClass = getBadgeClass(row.intExt, row.timeOfDay);
                const categoryClass = row.category.toLowerCase().replace('_', '-');

                html += `
                    <tr data-row="${index}" data-scene="${row.sceneNum}" data-character="${row.character}" data-category="${row.category}">
                        <td class="row-num">${rowNum}</td>
                        <td></td>
                        <td>${row.character}</td>
                        <td><span class="category-badge ${categoryClass}">${formatCategory(row.category)}</span></td>
                        <td contenteditable="true" data-field="storyDay">${row.storyDay || ''}</td>
                        <td>${row.timeOfDay || ''}</td>
                        <td><span class="scene-badge ${badgeClass}">${row.intExt}</span></td>
                        <td>${row.location || ''}</td>
                        <td contenteditable="true" data-field="synopsis">${row.synopsis || ''}</td>
                        <td contenteditable="true" data-field="lookArc">${row.lookArc || ''}</td>
                        <td contenteditable="true" data-field="hair">${row.hair || ''}</td>
                        <td contenteditable="true" data-field="makeupBase">${row.makeupBase || ''}</td>
                        <td contenteditable="true" data-field="eyeBags">${row.eyeBags || ''}</td>
                        <td contenteditable="true" data-field="lesions">${row.lesions || ''}</td>
                        <td contenteditable="true" data-field="beard">${row.beard || ''}</td>
                        <td contenteditable="true" data-field="woundsSFX">${row.woundsSFX || ''}</td>
                        <td contenteditable="true" data-field="notes">${row.notes || ''}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;

            // Setup cell editing listeners
            setupCellEditing();
        }

        function getBadgeClass(intExt, timeOfDay) {
            const isInt = /INT/i.test(intExt);
            const isNight = /NIGHT|EVENING|DUSK/i.test(timeOfDay);

            if (isInt && isNight) return 'int-night';
            if (isInt) return 'int-day';
            if (isNight) return 'ext-night';
            return 'ext-day';
        }

        function formatCategory(category) {
            const formats = {
                'LEAD': 'Lead',
                'SUPPORTING': 'Supporting',
                'DAY_PLAYER': 'Day Player',
                'BACKGROUND': 'Background'
            };
            return formats[category] || category;
        }

        function setupCellEditing() {
            const cells = document.querySelectorAll('td[contenteditable="true"]');
            cells.forEach(cell => {
                cell.addEventListener('blur', function() {
                    const row = this.closest('tr');
                    const rowIndex = parseInt(row.dataset.row);
                    const field = this.dataset.field;

                    if (rowIndex >= 0 && field && breakdownData[rowIndex]) {
                        breakdownData[rowIndex][field] = this.textContent.trim();
                        saveBreakdown();
                    }
                });
            });
        }

        // ============================================================================
        // FILTERS
        // ============================================================================

        function populateFilters() {
            // Character filter
            const charFilter = document.getElementById('characterFilter');
            const uniqueChars = [...new Set(breakdownData.map(r => r.character))].sort();
            uniqueChars.forEach(char => {
                const option = document.createElement('option');
                option.value = char;
                option.textContent = char;
                charFilter.appendChild(option);
            });

            // Day filter
            const dayFilter = document.getElementById('dayFilter');
            const uniqueDays = [...new Set(breakdownData.map(r => r.storyDay).filter(d => d))].sort((a, b) => a - b);
            uniqueDays.forEach(day => {
                const option = document.createElement('option');
                option.value = day;
                option.textContent = `Day ${day}`;
                dayFilter.appendChild(option);
            });
        }

        function filterByCharacter() {
            const value = document.getElementById('characterFilter').value;
            applyFilters();
        }

        function filterByCategory() {
            const value = document.getElementById('categoryFilter').value;
            applyFilters();
        }

        function filterByDay() {
            const value = document.getElementById('dayFilter').value;
            applyFilters();
        }

        function applyFilters() {
            const charFilter = document.getElementById('characterFilter').value;
            const catFilter = document.getElementById('categoryFilter').value;
            const dayFilter = document.getElementById('dayFilter').value;

            const rows = document.querySelectorAll('#breakdownBody tr');
            let visibleScenes = new Set();

            rows.forEach(row => {
                if (row.classList.contains('scene-header')) {
                    row.style.display = 'none'; // Hide all headers initially
                    return;
                }

                const char = row.dataset.character;
                const cat = row.dataset.category;
                const scene = row.dataset.scene;

                // Get story day from row
                const rowIndex = parseInt(row.dataset.row);
                const day = breakdownData[rowIndex]?.storyDay;

                let show = true;

                if (charFilter !== 'all' && char !== charFilter) show = false;
                if (catFilter !== 'all' && cat !== catFilter) show = false;
                if (dayFilter !== 'all' && day != dayFilter) show = false;

                row.style.display = show ? '' : 'none';

                if (show) {
                    visibleScenes.add(scene);
                }
            });

            // Show scene headers for visible scenes
            rows.forEach(row => {
                if (row.classList.contains('scene-header')) {
                    const scene = row.dataset.scene;
                    row.style.display = visibleScenes.has(scene) ? '' : 'none';
                }
            });

            updateStatusBar();
        }

        // ============================================================================
        // SCENE EXPANSION
        // ============================================================================

        function collapseAllScenes() {
            const rows = document.querySelectorAll('#breakdownBody tr:not(.scene-header)');
            rows.forEach(row => row.style.display = 'none');
        }

        function expandAllScenes() {
            const rows = document.querySelectorAll('#breakdownBody tr');
            rows.forEach(row => row.style.display = '');
        }

        // ============================================================================
        // DATA MANAGEMENT
        // ============================================================================

        function refreshData() {
            loadData();
            showToast('Data refreshed');
        }

        function saveBreakdown() {
            localStorage.setItem('checksHappyBreakdown', JSON.stringify(breakdownData));
            updateStatus('Saved');
        }

        function updateStatusBar() {
            const visibleRows = document.querySelectorAll('#breakdownBody tr:not(.scene-header):not([style*="display: none"])');
            const uniqueChars = new Set(breakdownData.map(r => r.character));
            const uniqueScenes = new Set(breakdownData.map(r => r.sceneNum));

            document.getElementById('rowCount').textContent = `${visibleRows.length} rows`;
            document.getElementById('characterCount').textContent = `${uniqueChars.size} characters`;
            document.getElementById('sceneCount').textContent = `${uniqueScenes.size} scenes`;
        }

        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
            setTimeout(() => {
                document.getElementById('statusText').textContent = 'Ready';
            }, 3000);
        }

        // ============================================================================
        // EXPORT FUNCTIONS
        // ============================================================================

        function showExportModal() {
            document.getElementById('exportModal').style.display = 'flex';
        }

        function closeExportModal() {
            document.getElementById('exportModal').style.display = 'none';
        }

        function getExportData() {
            const headers = [
                'Scene', 'Character', 'Category', 'Story Day', 'Time', 'INT/EXT',
                'Location', 'Synopsis', 'Look Arc', 'Hair', 'Makeup Base',
                'Eye Bags', 'Lesions', 'Beard', 'Wounds/Blood/SFX', 'Notes'
            ];

            const rows = breakdownData.map(row => [
                row.sceneNum,
                row.character,
                formatCategory(row.category),
                row.storyDay || '',
                row.timeOfDay || '',
                row.intExt || '',
                row.location || '',
                row.synopsis || '',
                row.lookArc || '',
                row.hair || '',
                row.makeupBase || '',
                row.eyeBags || '',
                row.lesions || '',
                row.beard || '',
                row.woundsSFX || '',
                row.notes || ''
            ]);

            return { headers, rows };
        }

        function exportToTSV() {
            const { headers, rows } = getExportData();
            const tsv = [headers.join('\t'), ...rows.map(r => r.join('\t'))].join('\n');

            downloadFile(tsv, 'breakdown.tsv', 'text/tab-separated-values');
            closeExportModal();
            showToast('Exported as TSV');
        }

        function exportToCSV() {
            const { headers, rows } = getExportData();

            const escapeCSV = (val) => {
                val = String(val || '');
                if (val.includes(',') || val.includes('"') || val.includes('\n')) {
                    return `"${val.replace(/"/g, '""')}"`;
                }
                return val;
            };

            const csv = [
                headers.map(escapeCSV).join(','),
                ...rows.map(r => r.map(escapeCSV).join(','))
            ].join('\n');

            downloadFile(csv, 'breakdown.csv', 'text/csv');
            closeExportModal();
            showToast('Exported as CSV');
        }

        function exportToPDF() {
            // Create a printable version
            const { headers, rows } = getExportData();

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>H&MU Breakdown</title>
                    <style>
                        body { font-family: Arial, sans-serif; font-size: 10px; }
                        h1 { font-size: 16px; margin-bottom: 10px; }
                        table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid #ccc; padding: 4px 6px; text-align: left; }
                        th { background: #f0f0f0; font-weight: bold; }
                        tr:nth-child(even) { background: #f9f9f9; }
                        @media print {
                            @page { size: landscape; margin: 0.5in; }
                        }
                    </style>
                </head>
                <body>
                    <h1>Hair & Makeup Breakdown</h1>
                    <table>
                        <thead>
                            <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}
                        </tbody>
                    </table>
                    <script>window.onload = function() { window.print(); }</script>
                </body>
                </html>
            `);
            printWindow.document.close();

            closeExportModal();
            showToast('Opening print dialog...');
        }

        function copyToClipboard() {
            const { headers, rows } = getExportData();
            const tsv = [headers.join('\t'), ...rows.map(r => r.join('\t'))].join('\n');

            navigator.clipboard.writeText(tsv).then(() => {
                closeExportModal();
                showToast('Copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showToast('Failed to copy to clipboard');
            });
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ============================================================================
        // UTILITIES
        // ============================================================================

        function showToast(message) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 3000);
        }

        console.log('Breakdown sheet loaded');
    </script>
</body>
</html>
