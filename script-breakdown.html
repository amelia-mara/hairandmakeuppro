<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Script Breakdown - Checks Happy</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">

    <!-- External Stylesheet -->
    <link rel="stylesheet" href="/css/script-breakdown.css">
</head>
<body>
    <div class="app-layout">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="nav-section">
                <a href="/" class="back-link">‚Üê Dashboard</a>
                <h1 class="page-title" id="projectTitle">Script Breakdown</h1>
            </div>
            <div class="toolbar">
                <button class="toolbar-btn" onclick="openMergeCharactersModal()">üîó Merge Characters</button>
                <button class="toolbar-btn" onclick="generateAllSynopses()">‚ú® Generate All Synopses</button>
                <button class="toolbar-btn" onclick="autoTagScript()">üè∑Ô∏è Auto Tag Script</button>
                <button class="toolbar-btn" onclick="openSettingsModal()">‚öôÔ∏è AI Settings</button>
                <button class="toolbar-btn" onclick="exportData()">Export Data</button>
                <button class="toolbar-btn" onclick="openImportModal()">Import Script</button>
                <div id="auto-save-indicator" class="auto-save-indicator" style="display: none;">
                    <span class="save-icon">‚úì</span>
                    <span class="save-text">Saved</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Sidebar - Scenes -->
            <div class="left-sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">
                        <span>SCENES</span>
                        <span class="scene-count" id="scene-count">0</span>
                    </div>
                    <input type="text" class="scene-search" placeholder="Search scenes..." id="scene-search">
                </div>
                <div class="scene-list" id="scene-list">
                    <div class="empty-state">
                        <div class="empty-icon">üé¨</div>
                        <div class="empty-desc">No scenes yet</div>
                    </div>
                </div>
            </div>

            <!-- Center Panel - Script & Character Tabs -->
            <div class="center-panel">
                <!-- Tab Bar -->
                <div class="center-tabs">
                    <div class="center-tab active" data-tab="script" onclick="switchCenterTab('script')">
                        üìÑ Script
                    </div>
                    <!-- Character tabs generated dynamically -->
                </div>

                <!-- Tab Content Container -->
                <div class="center-tab-content">
                    <!-- Script Tab -->
                    <div class="center-tab-panel active" id="script-tab-panel">
                        <div class="script-toolbar">
                            <div class="color-legend">
                                <span class="legend-item"><span class="legend-color" style="background: #fbbf24;"></span>Cast</span>
                                <span class="legend-item"><span class="legend-color" style="background: #a855f7;"></span>Hair</span>
                                <span class="legend-item"><span class="legend-color" style="background: #ec4899;"></span>Makeup</span>
                                <span class="legend-item"><span class="legend-color" style="background: #ef4444;"></span>SFX</span>
                                <span class="legend-item"><span class="legend-color" style="background: #f59e0b;"></span>Health</span>
                                <span class="legend-item"><span class="legend-color" style="background: #dc2626;"></span>Injuries</span>
                                <span class="legend-item"><span class="legend-color" style="background: #f97316;"></span>Stunts</span>
                                <span class="legend-item"><span class="legend-color" style="background: #38bdf8;"></span>Weather</span>
                                <span class="legend-item"><span class="legend-color" style="background: #34d399;"></span>Wardrobe</span>
                                <span class="legend-item"><span class="legend-color" style="background: #9ca3af;"></span>Extras</span>
                            </div>
                            <div class="view-controls">
                                <button class="view-btn" id="zoom-in" onclick="zoomIn()">Zoom In</button>
                                <button class="view-btn" id="zoom-out" onclick="zoomOut()">Zoom Out</button>
                            </div>
                        </div>

                        <div class="script-viewer" id="script-viewer">
                            <div class="script-container">
                                <div class="script-content" id="script-content">
                                    <div class="empty-state">
                                        <div class="empty-icon">üìÑ</div>
                                        <div class="empty-title">No Script Loaded</div>
                                        <div class="empty-desc">Import your screenplay to begin</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Character Tab Panels (generated dynamically) -->
                </div>
            </div>

            <!-- Right Sidebar - Scene Breakdown -->
            <div class="right-sidebar">
                <div class="workspace-header">
                    <div class="workspace-title">SCENE BREAKDOWN</div>
                </div>

                <div class="workspace-content">
                    <div class="tab-panel active" id="breakdown-panel">
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <div class="empty-title">Select a Scene</div>
                            <div class="empty-desc">Choose a scene to view and edit its breakdown</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================================================ -->
    <!-- MODALS -->
    <!-- ============================================================================ -->

    <!-- Add Element Modal -->
    <div class="modal" id="add-element-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-title">Add Element</div>
            <input type="text" class="modal-input" id="element-input" placeholder="Enter element name...">
            <div class="modal-actions">
                <button class="modal-btn" onclick="closeAddElementModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmAddElement()">Add</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="import-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-title">Import Screenplay</div>
            <textarea class="modal-textarea" id="script-input" rows="20" placeholder="Paste your screenplay here..."></textarea>
            <div class="modal-actions">
                <button class="modal-btn" onclick="closeImportModal()">Cancel</button>
                <button class="modal-btn primary" onclick="processScript()">Import & Analyze</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settings-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-title">AI Settings</div>

            <div class="modal-section">
                <label class="modal-label">AI Provider</label>
                <select class="modal-select" id="ai-provider">
                    <option value="openai">OpenAI</option>
                    <option value="anthropic">Anthropic</option>
                </select>
            </div>

            <div class="modal-section">
                <label class="modal-label">API Key (for local testing only)</label>
                <input type="password" class="modal-input" id="api-key" placeholder="Enter API key...">
                <div class="modal-note">‚ö†Ô∏è API key will be stored in localStorage. Use serverless deployment for production.</div>
            </div>

            <div class="modal-section">
                <label class="modal-label">OpenAI Model</label>
                <select class="modal-select" id="openai-model">
                    <option value="gpt-4o">GPT-4o</option>
                    <option value="gpt-4">GPT-4</option>
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                </select>
            </div>

            <div class="modal-actions">
                <button class="modal-btn" onclick="closeSettingsModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div class="modal" id="progress-modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-title" id="progress-title">Processing...</div>

            <div class="modal-section">
                <div class="progress-message" id="progress-message">Starting batch processing...</div>

                <div class="continuity-progress" style="margin: 20px 0;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
                    </div>
                    <div class="progress-label" id="progress-label">0 / 0</div>
                </div>

                <div class="progress-details" id="progress-details" style="font-size: 0.85em; color: var(--text-muted); margin-top: 8px;">
                    <!-- Details shown here -->
                </div>
            </div>

            <div class="modal-actions">
                <button class="modal-btn" id="progress-cancel-btn" onclick="cancelBatchProcessing()">Cancel</button>
                <button class="modal-btn primary" id="progress-done-btn" style="display: none;" onclick="closeProgressModal()">Done</button>
            </div>
        </div>
    </div>

    <!-- Tag Popup (for creating tags from text selection) -->
    <div class="tag-popup" id="tag-popup">
        <div class="tag-popup-header">
            <div class="tag-popup-title">Create Tag</div>
            <button class="tag-popup-close" onclick="closeTagPopup()">√ó</button>
        </div>
        <div class="tag-popup-body">
            <div class="tag-field">
                <label>Selected Text</label>
                <div class="tag-selected-text" id="tag-selected-text"></div>
            </div>
            <div class="tag-field">
                <label>Category</label>
                <select id="tag-category" onchange="handleCategoryChange()">
                    <option value="cast">Cast Member</option>
                    <option value="hair">Hair</option>
                    <option value="makeup">Makeup</option>
                    <option value="sfx">SFX</option>
                    <option value="health">Health/Illness</option>
                    <option value="injuries">Injuries</option>
                    <option value="stunts">Stunts/Action</option>
                    <option value="weather">Weather</option>
                    <option value="wardrobe">Wardrobe</option>
                    <option value="extras">Extras</option>
                </select>
            </div>
            <div class="tag-field" id="tag-character-field">
                <label>Character</label>
                <select id="tag-character">
                    <option value="">Auto-detect</option>
                </select>
            </div>
        </div>
        <div class="tag-popup-footer">
            <button class="modal-btn" onclick="closeTagPopup()">Cancel</button>
            <button class="modal-btn primary" onclick="saveTag()">Create Tag</button>
        </div>
    </div>

    <!-- Tag Context Menu (right-click on tags) -->
    <div class="tag-context-menu" id="tag-context-menu" style="display: none;">
        <div class="context-menu-item" onclick="editTagFromContext()">‚úèÔ∏è Edit</div>
        <div class="context-menu-item" onclick="removeTagFromContext()">üóëÔ∏è Delete</div>
        <div class="context-menu-item" onclick="linkToContinuityFromContext()">üîó Link to Event</div>
        <div class="context-menu-item" onclick="jumpToTagsTab()">‚Üí Go to Tags</div>
    </div>

    <!-- Tag Tooltip (hover on tags) -->
    <div class="tag-tooltip" id="tag-tooltip" style="display: none;"></div>

    <!-- ============================================================================ -->
    <!-- JAVASCRIPT MODULES -->
    <!-- ============================================================================ -->

    <!-- Load modules in correct order -->
    <script type="module">
        // Import and initialize the application
        import './js/script-breakdown/main.js';

        // Note: main.js handles all other module imports and initialization
        // The init() function is called automatically when main.js loads
    </script>

    <!-- Legacy global function exposure for HTML onclick handlers -->
    <!-- These are exposed in each module via window.functionName = ... -->
</body>
</html>
