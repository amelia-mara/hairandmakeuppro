<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Script Breakdown</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0d0b0a;
            --bg-medium: rgba(26, 22, 18, 0.7);
            --card-bg: rgba(36, 32, 25, 0.6);
            --text-light: #e8e6e3;
            --text-muted: #8a7f73;
            --accent-gold: #c9a961;
            --border: rgba(45, 41, 37, 0.5);
            --divider: rgba(54, 51, 48, 0.5);
            --glass-border: rgba(255, 255, 255, 0.08);
            --success: #52c186;
            --warning: #fbbf24;
            --error: #ff6b6b;
            
            /* Tag Colors */
            --tag-makeup: #ff6b9d;
            --tag-hair: #c084fc;
            --tag-sfx: #38bdf8;
            --tag-cast: #fbbf24;
            --tag-wardrobe: #34d399;
            --tag-props: #fb923c;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(13, 11, 10, 0.4);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(138, 127, 115, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(138, 127, 115, 0.5);
        }

        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(138, 127, 115, 0.3) rgba(13, 11, 10, 0.4);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0d0b0a 0%, #1a1612 50%, #0d0b0a 100%);
            color: var(--text-light);
            height: 100vh;
            overflow: hidden;
        }

        /* Layout */
        .app-layout {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        /* Top Bar */
        .top-bar {
            height: 60px;
            background: var(--bg-medium);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            flex-shrink: 0;
        }

        .back-link {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.875em;
            transition: color 0.2s ease;
            cursor: pointer;
        }

        .back-link:hover {
            color: var(--accent-gold);
        }

        .page-title {
            font-size: 1.125em;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .workflow-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: rgba(36, 32, 25, 0.4);
            border-radius: 8px;
            font-size: 0.8125em;
        }

        .workflow-step {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-muted);
        }

        .workflow-step.active {
            color: var(--accent-gold);
            font-weight: 600;
        }

        .workflow-step.completed {
            color: var(--success);
        }

        .workflow-arrow {
            color: var(--text-muted);
            opacity: 0.3;
        }

        .top-bar-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .toolbar-btn {
            padding: 8px 14px;
            background: transparent;
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8125em;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }

        .toolbar-btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
            background: rgba(201, 169, 97, 0.05);
        }

        .toolbar-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .toolbar-btn.primary {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
            color: var(--bg-dark);
        }

        .toolbar-btn.primary:hover:not(:disabled) {
            background: #d4b16d;
        }

        .toolbar-btn.success {
            background: var(--success);
            border-color: var(--success);
            color: var(--bg-dark);
        }

        /* Main Content Area */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ============================================ */
        /* SCENE REVIEW MODE STYLES */
        /* ============================================ */

        .review-layout {
            display: flex;
            width: 100%;
            gap: 24px;
            padding: 24px;
            overflow: hidden;
        }

        .review-sidebar {
            width: 350px;
            background: var(--bg-medium);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .review-sidebar h2 {
            font-size: 1.125em;
            margin-bottom: 8px;
        }

        .review-stats {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--glass-border);
        }

        .review-stat {
            text-align: center;
        }

        .review-stat-number {
            font-size: 2em;
            font-weight: 700;
            color: var(--accent-gold);
        }

        .review-stat-label {
            font-size: 0.75em;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .scene-list-container {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 16px;
        }

        .scene-list-item {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .scene-list-item:hover {
            border-color: var(--accent-gold);
            transform: translateX(4px);
        }

        .scene-list-item.active {
            border-color: var(--accent-gold);
            background: rgba(201, 169, 97, 0.15);
        }

        .scene-number {
            display: inline-block;
            width: 32px;
            height: 32px;
            background: var(--accent-gold);
            color: var(--bg-dark);
            border-radius: 6px;
            text-align: center;
            line-height: 32px;
            font-weight: 700;
            margin-right: 8px;
            font-size: 0.875em;
        }

        .scene-heading-preview {
            font-size: 0.875em;
            color: var(--text-light);
            font-weight: 500;
        }

        .review-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .script-viewer {
            flex: 1;
            background: var(--bg-medium);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 40px;
            overflow-y: auto;
        }

        .script-content {
            background: rgba(232, 230, 227, 0.95);
            padding: 60px 80px;
            border-radius: 8px;
            font-family: 'Courier Prime', 'Courier New', monospace;
            font-size: 12pt;
            line-height: 1.6;
            color: #000;
            min-height: 100%;
        }

        .script-line {
            margin-bottom: 12px;
            position: relative;
            padding-left: 40px;
        }

        .script-line:hover .add-scene-btn {
            opacity: 1;
        }

        .add-scene-btn {
            position: absolute;
            left: 0;
            top: 0;
            width: 32px;
            height: 32px;
            background: var(--accent-gold);
            border: none;
            border-radius: 4px;
            color: var(--bg-dark);
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-scene-btn:hover {
            background: #d4b16d;
        }

        .detected-scene {
            background: rgba(201, 169, 97, 0.2);
            border-left: 4px solid var(--accent-gold);
            padding: 16px 16px 16px 36px;
            margin: 24px 0;
            border-radius: 4px;
            position: relative;
        }

        .scene-badge {
            position: absolute;
            left: -16px;
            top: 12px;
            width: 32px;
            height: 32px;
            background: var(--accent-gold);
            color: var(--bg-dark);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875em;
        }

        .scene-heading-input {
            width: 100%;
            padding: 8px 12px;
            background: white;
            border: 2px solid var(--accent-gold);
            border-radius: 6px;
            font-family: 'Courier Prime', monospace;
            font-size: 12pt;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 8px;
            color: #000;
        }

        .scene-heading-input:focus {
            outline: none;
            border-color: #d4b16d;
        }

        .scene-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .scene-action-btn {
            padding: 6px 12px;
            background: rgba(201, 169, 97, 0.2);
            border: 1px solid var(--accent-gold);
            border-radius: 4px;
            color: #000;
            cursor: pointer;
            font-size: 0.75em;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
        }

        .scene-action-btn:hover {
            background: var(--accent-gold);
        }

        .scene-action-btn.delete {
            background: rgba(255, 107, 107, 0.2);
            border-color: var(--error);
        }

        .scene-action-btn.delete:hover {
            background: var(--error);
            color: white;
        }

        /* ============================================ */
        /* BREAKDOWN MODE STYLES */
        /* ============================================ */

        .breakdown-layout {
            display: none; /* Hidden until scenes are confirmed */
            width: 100%;
            height: 100%;
        }

        .breakdown-layout.active {
            display: flex;
        }

        /* Left Sidebar - Scene Navigation */
        .left-sidebar {
            width: 300px;
            background: var(--bg-medium);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--glass-border);
        }

        .sidebar-title {
            font-size: 0.875em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .scene-search {
            width: 100%;
            padding: 8px 12px;
            background: rgba(13, 11, 10, 0.5);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            color: var(--text-light);
            font-size: 0.8125em;
        }

        .scene-search:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .scene-nav-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .scene-nav-item {
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(36, 32, 25, 0.4);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .scene-nav-item:hover {
            border-color: var(--accent-gold);
            background: rgba(201, 169, 97, 0.1);
        }

        .scene-nav-item.active {
            border-color: var(--accent-gold);
            background: rgba(201, 169, 97, 0.15);
        }

        .scene-nav-number {
            font-size: 0.75em;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .scene-nav-heading {
            font-size: 0.8125em;
            font-weight: 600;
            color: var(--text-light);
            line-height: 1.3;
        }

        .scene-nav-tags {
            display: flex;
            gap: 4px;
            margin-top: 6px;
            flex-wrap: wrap;
        }

        .mini-tag {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* Center Panel - Scene Viewer */
        .center-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .scene-display {
            flex: 1;
            overflow-y: auto;
            padding: 32px 48px;
        }

        .scene-header-display {
            margin-bottom: 32px;
        }

        .scene-number-large {
            font-size: 0.875em;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }

        .scene-heading-large {
            font-size: 1.75em;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 16px;
            line-height: 1.2;
        }

        .scene-script-content {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 32px;
            font-family: 'Courier Prime', monospace;
            font-size: 12pt;
            line-height: 1.8;
            white-space: pre-wrap;
        }

        /* Right Sidebar - Tagging Panel */
        .right-sidebar {
            width: 380px;
            background: var(--bg-medium);
            backdrop-filter: blur(20px);
            border-left: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tagging-panel {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .tag-section {
            margin-bottom: 24px;
        }

        .tag-section-title {
            font-size: 0.875em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tag-color-indicator {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .add-tag-btn {
            width: 100%;
            padding: 10px;
            background: rgba(201, 169, 97, 0.1);
            border: 1px dashed var(--glass-border);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8125em;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .add-tag-btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
            background: rgba(201, 169, 97, 0.15);
        }

        .tag-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .tag-item {
            background: rgba(36, 32, 25, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .tag-item:hover {
            border-color: var(--accent-gold);
        }

        .tag-description {
            font-size: 0.8125em;
            color: var(--text-light);
            flex: 1;
        }

        .tag-remove-btn {
            width: 24px;
            height: 24px;
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid var(--error);
            border-radius: 4px;
            color: var(--error);
            cursor: pointer;
            font-size: 0.875em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .tag-remove-btn:hover {
            background: var(--error);
            color: white;
        }

        .notes-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--glass-border);
        }

        .notes-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            background: rgba(13, 11, 10, 0.5);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            color: var(--text-light);
            font-size: 0.8125em;
            font-family: 'Inter', sans-serif;
            resize: vertical;
        }

        .notes-textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 48px;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 1.25em;
            margin-bottom: 8px;
            color: var(--text-light);
        }

        .empty-state p {
            color: var(--text-muted);
            font-size: 0.875em;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 11, 10, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-medium);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 1.25em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .modal-subtitle {
            font-size: 0.875em;
            color: var(--text-muted);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.875em;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .form-input,
        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            background: rgba(13, 11, 10, 0.5);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            color: var(--text-light);
            font-size: 0.875em;
            font-family: 'Inter', sans-serif;
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .modal-btn {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            color: var(--text-light);
            cursor: pointer;
            font-size: 0.875em;
            transition: all 0.2s ease;
        }

        .modal-btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .modal-btn.primary {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
            color: var(--bg-dark);
        }

        .modal-btn.primary:hover {
            background: #d4b16d;
        }

        /* Utility */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Top Bar -->
        <div class="top-bar">
            <div onclick="goBack()" class="back-link">
                <span>‚Üê</span>
                <span>Back to Projects</span>
            </div>

            <div class="workflow-indicator">
                <div class="workflow-step" id="stepReview">
                    <span>1</span>
                    <span>Review Scenes</span>
                </div>
                <span class="workflow-arrow">‚Üí</span>
                <div class="workflow-step" id="stepBreakdown">
                    <span>2</span>
                    <span>Breakdown & Tag</span>
                </div>
            </div>

            <div class="top-bar-actions">
                <button class="toolbar-btn" onclick="redetectScenes()" id="redetectBtn">
                    üîÑ Re-detect Scenes
                </button>
                <button class="toolbar-btn primary" onclick="confirmScenesAndContinue()" id="confirmBtn" disabled>
                    ‚úì Confirm Scenes & Continue
                </button>
                <button class="toolbar-btn hidden" onclick="backToReview()" id="backToReviewBtn">
                    ‚Üê Back to Scene Review
                </button>
                <button class="toolbar-btn primary hidden" onclick="exportBreakdown()" id="exportBtn">
                    ‚¨á Export
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- SCENE REVIEW MODE -->
            <div class="review-layout" id="reviewMode">
                <!-- Sidebar with Scene List -->
                <div class="review-sidebar">
                    <h2>Detected Scenes</h2>
                    <p style="color: var(--text-muted); font-size: 0.875em; margin-bottom: 16px;">
                        Review and edit scene headings before continuing to breakdown.
                    </p>

                    <div class="review-stats">
                        <div class="review-stat">
                            <div class="review-stat-number" id="reviewSceneCount">0</div>
                            <div class="review-stat-label">Scenes</div>
                        </div>
                        <div class="review-stat">
                            <div class="review-stat-number" id="reviewLineCount">0</div>
                            <div class="review-stat-label">Lines</div>
                        </div>
                    </div>

                    <div class="scene-list-container" id="reviewSceneList">
                        <p style="color: var(--text-muted); font-size: 0.875em;">
                            Loading scenes...
                        </p>
                    </div>

                    <div class="review-actions">
                        <button class="toolbar-btn" onclick="redetectScenes()" style="width: 100%;">
                            üîÑ Re-detect All Scenes
                        </button>
                    </div>
                </div>

                <!-- Script Viewer -->
                <div class="script-viewer">
                    <div class="script-content" id="reviewScriptContent">
                        <p style="text-align: center; color: #666;">Loading script...</p>
                    </div>
                </div>
            </div>

            <!-- BREAKDOWN MODE -->
            <div class="breakdown-layout" id="breakdownMode">
                <!-- Left Sidebar - Scene Navigation -->
                <div class="left-sidebar">
                    <div class="sidebar-header">
                        <div class="sidebar-title">Scenes</div>
                        <input type="text" class="scene-search" placeholder="Search scenes..." id="sceneSearch">
                    </div>
                    <div class="scene-nav-list" id="sceneNavList">
                        <!-- Scene navigation items will be inserted here -->
                    </div>
                </div>

                <!-- Center Panel - Scene Content -->
                <div class="center-panel">
                    <div class="scene-display" id="sceneDisplay">
                        <div class="empty-state">
                            <div class="empty-state-icon">üé¨</div>
                            <h3>Select a Scene</h3>
                            <p>Choose a scene from the left sidebar to start tagging</p>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar - Tagging Panel -->
                <div class="right-sidebar">
                    <div class="tagging-panel" id="taggingPanel">
                        <div class="empty-state">
                            <div class="empty-state-icon">üè∑Ô∏è</div>
                            <h3>No Scene Selected</h3>
                            <p>Select a scene to add tags</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Tag Modal -->
    <div class="modal" id="addTagModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Add Tag</div>
                <div class="modal-subtitle" id="modalSubtitle">Add a new item to this scene</div>
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" id="tagDescription" placeholder="Describe the item..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="modal-btn" onclick="closeTagModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveTag()">Add Tag</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // GLOBAL STATE
        // ============================================

        let currentProject = null;
        let scriptText = '';
        let scenes = [];
        let currentSceneIndex = 0;
        let sceneTags = {}; // { sceneNumber: [{ category, description }] }
        let sceneNotes = {}; // { sceneNumber: 'notes' }
        let currentMode = 'review'; // 'review' or 'breakdown'
        let currentTagCategory = '';

        // ============================================
        // INITIALIZATION
        // ============================================

        function loadProjectScript() {
            currentProject = JSON.parse(localStorage.getItem('currentProject') || 'null');
            
            if (!currentProject) {
                alert('No project loaded');
                window.location.href = 'index.html';
                return;
            }

            if (!currentProject.scriptContent) {
                alert('No script content found in project');
                window.location.href = 'index.html';
                return;
            }

            scriptText = currentProject.scriptContent;
            
            // Check if scenes were already confirmed
            if (currentProject.scenes && currentProject.scenesConfirmed) {
                scenes = currentProject.scenes;
                sceneTags = currentProject.sceneTags || {};
                sceneNotes = currentProject.sceneNotes || {};
                switchToBreakdownMode();
            } else if (currentProject.scenes) {
                // Scenes exist but not confirmed yet
                scenes = currentProject.scenes;
                startReviewMode();
            } else {
                // No scenes yet, detect them
                detectScenes();
                startReviewMode();
            }

            console.log('Loaded project:', currentProject.title);
            console.log('Script length:', scriptText.length);
            console.log('Scenes:', scenes.length);
        }

        // ============================================
        // SCENE DETECTION
        // ============================================

        function detectScenes() {
            scenes = [];
            const lines = scriptText.split('\n');
            
            console.log('Detecting scenes from', lines.length, 'lines');
            
            // Multiple detection patterns
            const patterns = [
                /^\s*\d*\s*\d*\s*(INT|EXT|INT\/EXT|I\/E)[\.\s]+/i,  // Standard with optional numbers
                /^(INT|EXT|INT\/EXT|I\/E)[\.\s]+/i,                  // Clean format
                /^\d+\s*\.\s*(INT|EXT)[.\s]+/i,                      // Numbered scenes
            ];
            
            lines.forEach((line, index) => {
                const trimmed = line.trim();
                
                // Check each pattern
                for (let pattern of patterns) {
                    if (pattern.test(trimmed)) {
                        // Clean up the heading
                        let cleanHeading = trimmed
                            .replace(/^\s*\d+\s*\d*\s*/, '')  // Remove leading numbers
                            .replace(/\s+/g, ' ')              // Normalize spaces
                            .trim();
                        
                        scenes.push({
                            id: Date.now() + index,
                            lineIndex: index,
                            heading: cleanHeading,
                            originalText: trimmed
                        });
                        
                        console.log('Detected scene:', cleanHeading);
                        break;
                    }
                }
            });
            
            console.log('Total scenes detected:', scenes.length);
        }

        function redetectScenes() {
            if (!confirm('This will reset all manual scene edits. Continue?')) return;
            
            detectScenes();
            startReviewMode();
        }

        // ============================================
        // REVIEW MODE
        // ============================================

        function startReviewMode() {
            currentMode = 'review';
            
            // Show review mode, hide breakdown mode
            document.getElementById('reviewMode').style.display = 'flex';
            document.getElementById('breakdownMode').classList.remove('active');
            
            // Update workflow indicator
            document.getElementById('stepReview').classList.add('active');
            document.getElementById('stepReview').classList.remove('completed');
            document.getElementById('stepBreakdown').classList.remove('active');
            
            // Update buttons
            document.getElementById('confirmBtn').classList.remove('hidden');
            document.getElementById('confirmBtn').disabled = scenes.length === 0;
            document.getElementById('redetectBtn').classList.remove('hidden');
            document.getElementById('backToReviewBtn').classList.add('hidden');
            document.getElementById('exportBtn').classList.add('hidden');
            
            // Render review content
            renderReviewSidebar();
            renderReviewScript();
            updateReviewStats();
        }

        function renderReviewSidebar() {
            const sidebar = document.getElementById('reviewSceneList');
            
            if (scenes.length === 0) {
                sidebar.innerHTML = '<p style="color: var(--text-muted); font-size: 0.875em;">No scenes detected. Upload a script or adjust detection settings.</p>';
                return;
            }
            
            let html = '';
            scenes.forEach((scene, index) => {
                html += `
                    <div class="scene-list-item" onclick="scrollToReviewScene(${scene.id})">
                        <span class="scene-number">${index + 1}</span>
                        <span class="scene-heading-preview">${scene.heading}</span>
                    </div>
                `;
            });
            
            sidebar.innerHTML = html;
        }

        function renderReviewScript() {
            const lines = scriptText.split('\n');
            const scriptContent = document.getElementById('reviewScriptContent');
            
            let html = '';
            
            lines.forEach((line, lineIndex) => {
                const trimmed = line.trim();
                
                // Check if this line is a scene
                const sceneMatch = scenes.find(s => s.lineIndex === lineIndex);
                
                if (sceneMatch) {
                    const sceneNumber = scenes.indexOf(sceneMatch) + 1;
                    html += `
                        <div class="detected-scene" data-scene-id="${sceneMatch.id}">
                            <div class="scene-badge">${sceneNumber}</div>
                            <input 
                                type="text" 
                                class="scene-heading-input" 
                                value="${escapeHtml(sceneMatch.heading)}"
                                onchange="updateSceneHeading(${sceneMatch.id}, this.value)"
                            />
                            <div class="scene-actions">
                                <button class="scene-action-btn" onclick="scrollToReviewSceneInList(${sceneNumber})">Jump to Scene</button>
                                <button class="scene-action-btn delete" onclick="deleteScene(${sceneMatch.id})">Delete Scene</button>
                            </div>
                        </div>
                    `;
                } else if (trimmed) {
                    // Regular line with add scene button
                    html += `
                        <div class="script-line" data-line-index="${lineIndex}">
                            <button class="add-scene-btn" onclick="addSceneAtLine(${lineIndex})" title="Mark as scene">+</button>
                            ${escapeHtml(line)}
                        </div>
                    `;
                }
            });
            
            scriptContent.innerHTML = html;
        }

        function updateReviewStats() {
            document.getElementById('reviewSceneCount').textContent = scenes.length;
            document.getElementById('reviewLineCount').textContent = scriptText.split('\n').filter(l => l.trim()).length;
        }

        function scrollToReviewScene(sceneId) {
            const sceneElement = document.querySelector(`[data-scene-id="${sceneId}"]`);
            if (sceneElement) {
                sceneElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                sceneElement.style.boxShadow = '0 0 20px rgba(201, 169, 97, 0.5)';
                setTimeout(() => {
                    sceneElement.style.boxShadow = '';
                }, 2000);
            }
        }

        function scrollToReviewSceneInList(sceneNumber) {
            const listItems = document.querySelectorAll('.scene-list-item');
            if (listItems[sceneNumber - 1]) {
                listItems[sceneNumber - 1].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function addSceneAtLine(lineIndex) {
            const lines = scriptText.split('\n');
            const lineText = lines[lineIndex].trim();
            
            const heading = prompt('Enter scene heading (e.g., INT. KITCHEN - DAY):', lineText);
            
            if (!heading) return;
            
            const newScene = {
                id: Date.now(),
                lineIndex: lineIndex,
                heading: heading.toUpperCase(),
                originalText: lineText
            };
            
            scenes.push(newScene);
            
            // Sort scenes by line index
            scenes.sort((a, b) => a.lineIndex - b.lineIndex);
            
            renderReviewScript();
            renderReviewSidebar();
            updateReviewStats();
            
            // Enable confirm button
            document.getElementById('confirmBtn').disabled = false;
            
            console.log('Added scene:', heading);
        }

        function updateSceneHeading(sceneId, newHeading) {
            const scene = scenes.find(s => s.id === sceneId);
            if (scene) {
                scene.heading = newHeading.toUpperCase();
                renderReviewSidebar();
                console.log('Updated scene heading:', newHeading);
            }
        }

        function deleteScene(sceneId) {
            if (!confirm('Delete this scene?')) return;
            
            scenes = scenes.filter(s => s.id !== sceneId);
            
            renderReviewScript();
            renderReviewSidebar();
            updateReviewStats();
            
            // Disable confirm button if no scenes
            document.getElementById('confirmBtn').disabled = scenes.length === 0;
            
            console.log('Deleted scene');
        }

        function confirmScenesAndContinue() {
            if (scenes.length === 0) {
                alert('Please add at least one scene before continuing.');
                return;
            }
            
            // Mark scenes as confirmed
            currentProject.scenes = scenes;
            currentProject.sceneCount = scenes.length;
            currentProject.scenesConfirmed = true;
            
            localStorage.setItem('currentProject', JSON.stringify(currentProject));
            
            // Also update in projects list
            const projects = JSON.parse(localStorage.getItem('checksHappyProjects') || '[]');
            const projectIndex = projects.findIndex(p => p.code === currentProject.code);
            if (projectIndex !== -1) {
                projects[projectIndex].scenes = scenes;
                projects[projectIndex].sceneCount = scenes.length;
                projects[projectIndex].scenesConfirmed = true;
                localStorage.setItem('checksHappyProjects', JSON.stringify(projects));
            }
            
            console.log('Confirmed', scenes.length, 'scenes');
            
            // Switch to breakdown mode
            switchToBreakdownMode();
        }

        // ============================================
        // BREAKDOWN MODE
        // ============================================

        function switchToBreakdownMode() {
            currentMode = 'breakdown';
            
            // Hide review mode, show breakdown mode
            document.getElementById('reviewMode').style.display = 'none';
            document.getElementById('breakdownMode').classList.add('active');
            
            // Update workflow indicator
            document.getElementById('stepReview').classList.remove('active');
            document.getElementById('stepReview').classList.add('completed');
            document.getElementById('stepBreakdown').classList.add('active');
            
            // Update buttons
            document.getElementById('confirmBtn').classList.add('hidden');
            document.getElementById('redetectBtn').classList.add('hidden');
            document.getElementById('backToReviewBtn').classList.remove('hidden');
            document.getElementById('exportBtn').classList.remove('hidden');
            
            // Render breakdown content
            renderSceneNavigation();
            
            // Load first scene
            if (scenes.length > 0) {
                selectScene(0);
            }
        }

        function backToReview() {
            if (!confirm('Return to scene review? Any unsaved changes will be kept.')) return;
            
            // Don't unmark as confirmed, just go back to review mode
            startReviewMode();
        }

        function renderSceneNavigation() {
            const navList = document.getElementById('sceneNavList');
            
            if (scenes.length === 0) {
                navList.innerHTML = '<p style="color: var(--text-muted); padding: 20px; text-align: center;">No scenes</p>';
                return;
            }
            
            let html = '';
            scenes.forEach((scene, index) => {
                const tags = sceneTags[index + 1] || [];
                const tagsHtml = tags.map(tag => {
                    const color = {
                        'makeup': '#ff6b9d',
                        'hair': '#c084fc',
                        'sfx': '#38bdf8',
                        'cast': '#fbbf24',
                        'wardrobe': '#34d399',
                        'props': '#fb923c'
                    }[tag.category] || '#999';
                    return `<div class="mini-tag" style="background: ${color}"></div>`;
                }).join('');
                
                html += `
                    <div class="scene-nav-item ${index === currentSceneIndex ? 'active' : ''}" onclick="selectScene(${index})">
                        <div class="scene-nav-number">Scene ${index + 1}</div>
                        <div class="scene-nav-heading">${scene.heading}</div>
                        ${tags.length > 0 ? `<div class="scene-nav-tags">${tagsHtml}</div>` : ''}
                    </div>
                `;
            });
            
            navList.innerHTML = html;
        }

        function selectScene(index) {
            currentSceneIndex = index;
            
            // Update navigation
            renderSceneNavigation();
            
            // Display scene
            displayScene(index);
            
            // Update tagging panel
            displayTaggingPanel(index);
        }

        function displayScene(index) {
            const scene = scenes[index];
            const sceneNumber = index + 1;
            
            // Get script content for this scene
            const lines = scriptText.split('\n');
            const startLine = scene.lineIndex;
            
            // Find end line (next scene or end of script)
            let endLine = lines.length;
            if (index < scenes.length - 1) {
                endLine = scenes[index + 1].lineIndex;
            }
            
            const sceneContent = lines.slice(startLine + 1, endLine).join('\n');
            
            const display = document.getElementById('sceneDisplay');
            display.innerHTML = `
                <div class="scene-header-display">
                    <div class="scene-number-large">Scene ${sceneNumber}</div>
                    <div class="scene-heading-large">${scene.heading}</div>
                </div>
                <div class="scene-script-content">${escapeHtml(sceneContent)}</div>
            `;
        }

        function displayTaggingPanel(index) {
            const sceneNumber = index + 1;
            const tags = sceneTags[sceneNumber] || [];
            const notes = sceneNotes[sceneNumber] || '';
            
            const panel = document.getElementById('taggingPanel');
            
            const tagSections = [
                { category: 'makeup', title: 'Makeup', color: '#ff6b9d' },
                { category: 'hair', title: 'Hair', color: '#c084fc' },
                { category: 'sfx', title: 'SFX', color: '#38bdf8' },
                { category: 'cast', title: 'Cast', color: '#fbbf24' },
                { category: 'wardrobe', title: 'Wardrobe', color: '#34d399' },
                { category: 'props', title: 'Props', color: '#fb923c' }
            ];
            
            let html = '';
            
            tagSections.forEach(section => {
                const categoryTags = tags.filter(t => t.category === section.category);
                
                html += `
                    <div class="tag-section">
                        <div class="tag-section-title">
                            <div class="tag-color-indicator" style="background: ${section.color}"></div>
                            ${section.title}
                        </div>
                        ${categoryTags.length > 0 ? `
                            <div class="tag-list">
                                ${categoryTags.map((tag, i) => `
                                    <div class="tag-item">
                                        <div class="tag-description">${tag.description}</div>
                                        <button class="tag-remove-btn" onclick="removeTag(${sceneNumber}, '${section.category}', ${i})">√ó</button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        <button class="add-tag-btn" onclick="openTagModal('${section.category}', '${section.title}')">
                            + Add ${section.title}
                        </button>
                    </div>
                `;
            });
            
            html += `
                <div class="notes-section">
                    <div class="tag-section-title">üìù Scene Notes</div>
                    <textarea 
                        class="notes-textarea" 
                        placeholder="Add notes about this scene..."
                        onchange="saveSceneNotes(${sceneNumber}, this.value)"
                    >${escapeHtml(notes)}</textarea>
                </div>
            `;
            
            panel.innerHTML = html;
        }

        // ============================================
        // TAGGING FUNCTIONALITY
        // ============================================

        function openTagModal(category, title) {
            currentTagCategory = category;
            document.getElementById('modalTitle').textContent = `Add ${title}`;
            document.getElementById('modalSubtitle').textContent = `Add a ${title.toLowerCase()} item to this scene`;
            document.getElementById('tagDescription').value = '';
            document.getElementById('addTagModal').classList.add('active');
            document.getElementById('tagDescription').focus();
        }

        function closeTagModal() {
            document.getElementById('addTagModal').classList.remove('active');
            currentTagCategory = '';
        }

        function saveTag() {
            const description = document.getElementById('tagDescription').value.trim();
            
            if (!description) {
                alert('Please enter a description');
                return;
            }
            
            const sceneNumber = currentSceneIndex + 1;
            
            if (!sceneTags[sceneNumber]) {
                sceneTags[sceneNumber] = [];
            }
            
            sceneTags[sceneNumber].push({
                category: currentTagCategory,
                description: description
            });
            
            // Save to project
            saveProjectData();
            
            // Update UI
            displayTaggingPanel(currentSceneIndex);
            renderSceneNavigation();
            
            closeTagModal();
            
            console.log('Added tag:', currentTagCategory, description);
        }

        function removeTag(sceneNumber, category, tagIndex) {
            if (!confirm('Remove this tag?')) return;
            
            const categoryTags = sceneTags[sceneNumber].filter(t => t.category === category);
            const tagToRemove = categoryTags[tagIndex];
            
            sceneTags[sceneNumber] = sceneTags[sceneNumber].filter(t => t !== tagToRemove);
            
            // Save to project
            saveProjectData();
            
            // Update UI
            displayTaggingPanel(currentSceneIndex);
            renderSceneNavigation();
            
            console.log('Removed tag');
        }

        function saveSceneNotes(sceneNumber, notes) {
            sceneNotes[sceneNumber] = notes;
            saveProjectData();
            console.log('Saved notes for scene', sceneNumber);
        }

        function saveProjectData() {
            currentProject.sceneTags = sceneTags;
            currentProject.sceneNotes = sceneNotes;
            
            localStorage.setItem('currentProject', JSON.stringify(currentProject));
            
            // Also update in projects list
            const projects = JSON.parse(localStorage.getItem('checksHappyProjects') || '[]');
            const projectIndex = projects.findIndex(p => p.code === currentProject.code);
            if (projectIndex !== -1) {
                projects[projectIndex].sceneTags = sceneTags;
                projects[projectIndex].sceneNotes = sceneNotes;
                localStorage.setItem('checksHappyProjects', JSON.stringify(projects));
            }
        }

        // ============================================
        // SEARCH FUNCTIONALITY
        // ============================================

        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('sceneSearch');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const navItems = document.querySelectorAll('.scene-nav-item');
                    
                    navItems.forEach(item => {
                        const heading = item.querySelector('.scene-nav-heading').textContent.toLowerCase();
                        if (heading.includes(searchTerm)) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }
        });

        // ============================================
        // EXPORT FUNCTIONALITY
        // ============================================

        function exportBreakdown() {
            const options = [
                '1. Export to CSV (Scene breakdown with tags)',
                '2. Export to JSON (Complete data)',
                '3. Export Scene List (Simple list)',
                '4. Cancel'
            ];
            
            const choice = prompt(options.join('\n\n') + '\n\nEnter your choice (1-4):');
            
            switch(choice) {
                case '1':
                    exportToCSV();
                    break;
                case '2':
                    exportToJSON();
                    break;
                case '3':
                    exportSceneList();
                    break;
            }
        }

        function exportToCSV() {
            let csv = 'Scene,Heading,Makeup,Hair,SFX,Cast,Wardrobe,Props,Notes\n';
            
            scenes.forEach((scene, index) => {
                const sceneNum = index + 1;
                const tags = sceneTags[sceneNum] || [];
                const notes = sceneNotes[sceneNum] || '';
                
                const makeup = tags.filter(t => t.category === 'makeup').map(t => t.description).join('; ');
                const hair = tags.filter(t => t.category === 'hair').map(t => t.description).join('; ');
                const sfx = tags.filter(t => t.category === 'sfx').map(t => t.description).join('; ');
                const cast = tags.filter(t => t.category === 'cast').map(t => t.description).join('; ');
                const wardrobe = tags.filter(t => t.category === 'wardrobe').map(t => t.description).join('; ');
                const props = tags.filter(t => t.category === 'props').map(t => t.description).join('; ');
                
                csv += `"${sceneNum}","${scene.heading}","${makeup}","${hair}","${sfx}","${cast}","${wardrobe}","${props}","${notes.replace(/"/g, '""')}"\n`;
            });
            
            downloadFile(csv, `${currentProject?.code || 'script'}-breakdown.csv`, 'text/csv');
        }

        function exportToJSON() {
            const data = {
                project: currentProject,
                scenes: scenes,
                tags: sceneTags,
                notes: sceneNotes,
                exportDate: new Date().toISOString()
            };
            
            const json = JSON.stringify(data, null, 2);
            downloadFile(json, `${currentProject?.code || 'script'}-breakdown.json`, 'application/json');
        }

        function exportSceneList() {
            let text = `${currentProject?.title || 'Script'} - Scene List\n`;
            text += `Generated: ${new Date().toLocaleString()}\n`;
            text += `${'='.repeat(60)}\n\n`;
            
            scenes.forEach((scene, index) => {
                const sceneNum = index + 1;
                const tags = sceneTags[sceneNum] || [];
                const notes = sceneNotes[sceneNum];
                
                text += `Scene ${sceneNum}: ${scene.heading}\n`;
                
                if (tags.length > 0) {
                    text += `Tags: ${tags.length}\n`;
                    tags.forEach(tag => {
                        text += `  ‚Ä¢ ${tag.category}: ${tag.description}\n`;
                    });
                }
                
                if (notes) {
                    text += `Notes: ${notes}\n`;
                }
                
                text += '\n';
            });
            
            downloadFile(text, `${currentProject?.code || 'script'}-scenes.txt`, 'text/plain');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`Exported: ${filename}`);
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function goBack() {
            if (confirm('Are you sure? Any unsaved changes will be lost.')) {
                window.location.href = 'index.html';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // INITIALIZE
        // ============================================

        loadProjectScript();
    </script>
</body>
</html>
