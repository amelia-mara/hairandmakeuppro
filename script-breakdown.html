<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Script Breakdown - AI Enhanced</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-dark: #0a0908;
            --bg-medium: rgba(18, 16, 14, 0.85);
            --card-bg: rgba(28, 25, 22, 0.5);
            --text-light: #e8e6e3;
            --text-muted: #9a8f7f;
            --accent-gold: #d4af7a;
            --accent-gold-hover: #e0c08f;
            --accent-blue: #667eea;
            --glass-border: rgba(255, 255, 255, 0.06);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --success: #52c186;
            --error: #ff6b6b;
            --warning: #e8a87c;
            --tag-makeup: #ff6b9d;
            --tag-hair: #c084fc;
            --tag-sfx: #38bdf8;
            --tag-cast: #fbbf24;
            --tag-wardrobe: #34d399;
            --tag-props: #fb923c;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(13, 11, 10, 0.4); }
        ::-webkit-scrollbar-thumb { background: rgba(138, 127, 115, 0.3); border-radius: 4px; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #050404 0%, #0f0d0c 50%, #050404 100%);
            color: var(--text-light);
            height: 100vh;
            overflow: hidden;
        }
        .app-layout { display: flex; height: 100vh; flex-direction: column; }
        
        /* Top Bar */
        .top-bar {
            height: 60px;
            background: linear-gradient(135deg, rgba(212, 175, 122, 0.08) 0%, rgba(18, 16, 14, 0.85) 50%, rgba(212, 175, 122, 0.05) 100%);
            backdrop-filter: blur(24px);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }
        .back-link { display: flex; align-items: center; gap: 8px; color: var(--text-muted); cursor: pointer; font-size: 0.875em; }
        .back-link:hover { color: var(--accent-gold); }
        .page-title { font-size: 1.125em; font-weight: 600; }
        .toolbar-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8125em;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .toolbar-btn:hover { border-color: var(--accent-gold); color: var(--accent-gold); }
        .toolbar-btn.primary { background: var(--accent-gold); border-color: var(--accent-gold); color: #0a0908; font-weight: 600; }
        .toolbar-btn.ai { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-color: #667eea; color: white; font-weight: 600; }
        .toolbar-btn.import { background: linear-gradient(135deg, rgba(201, 169, 97, 0.2), rgba(184, 150, 81, 0.2)); border-color: var(--accent-gold); color: var(--accent-gold); }
        
        /* Layout */
        .main-content { display: flex; flex: 1; overflow: hidden; }
        .left-sidebar, .right-sidebar {
            width: 300px;
            background: linear-gradient(135deg, rgba(212, 175, 122, 0.06) 0%, rgba(18, 16, 14, 0.85) 50%, rgba(212, 175, 122, 0.03) 100%);
            backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .right-sidebar { width: 380px; }
        
        /* Sidebar Elements */
        .sidebar-header { padding: 16px 20px; border-bottom: 1px solid var(--glass-border); }
        .sidebar-title { font-size: 0.875em; font-weight: 600; text-transform: uppercase; color: var(--text-muted); margin-bottom: 12px; }
        .scene-search {
            width: 100%;
            padding: 10px 14px;
            background: rgba(10, 9, 8, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 0.8125em;
        }
        .scene-search:focus { outline: none; border-color: var(--accent-gold); }
        .scene-list { flex: 1; overflow-y: auto; padding: 12px; }
        .scene-item {
            background: rgba(28, 25, 22, 0.5);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .scene-item:hover { border-color: var(--accent-gold); transform: translateX(4px); }
        .scene-item.active { border-color: var(--accent-gold); background: rgba(201, 169, 97, 0.15); }
        .scene-number {
            width: 28px;
            height: 28px;
            background: var(--accent-gold);
            color: #0a0908;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.8125em;
            margin-bottom: 8px;
        }
        .scene-heading { font-size: 0.8125em; font-weight: 600; line-height: 1.3; }
        
        /* Center Panel */
        .center-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .script-toolbar {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 20px;
            background: var(--bg-medium);
            border-bottom: 1px solid var(--glass-border);
        }
        .tag-legend { display: flex; gap: 16px; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.75em; color: var(--text-muted); }
        .legend-color { width: 12px; height: 12px; border-radius: 3px; }
        
        /* Script Viewer */
        .script-viewer { flex: 1; overflow-y: auto; padding: 40px; background: rgba(232, 230, 227, 0.03); }
        .script-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(248, 246, 240, 0.98);
            padding: 60px 80px;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }
        .script-content { font-family: 'Courier Prime', monospace; font-size: 12pt; line-height: 1.5; color: #000; user-select: text; }
        
        /* No Script State */
        .no-script-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
        }
        .no-script-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        .no-script-title {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-light);
        }
        .no-script-desc {
            font-size: 0.875em;
            color: var(--text-muted);
            margin-bottom: 24px;
            max-width: 400px;
        }
        .import-actions {
            display: flex;
            gap: 12px;
        }
        
        /* Script Elements */
        .script-scene { margin-bottom: 24px; page-break-inside: avoid; }
        .script-scene-heading { font-weight: 700; text-transform: uppercase; margin-bottom: 12px; color: #000; }
        .script-action { margin-bottom: 12px; color: #000; }
        .script-character { margin: 12px 0 4px; text-align: center; text-transform: uppercase; color: #000; }
        .script-dialogue { margin-bottom: 12px; width: 70%; margin-left: 15%; color: #000; }
        .script-parenthetical { margin-bottom: 4px; width: 60%; margin-left: 20%; color: #000; }
        .script-transition { text-align: right; margin: 20px 0; font-weight: 600; color: #000; }
        
        /* Right Sidebar - Tags Panel */
        .sidebar-tabs { display: flex; border-bottom: 1px solid var(--glass-border); }
        .sidebar-tab {
            flex: 1;
            padding: 16px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8125em;
            border-bottom: 2px solid transparent;
        }
        .sidebar-tab.active { color: var(--accent-gold); border-bottom-color: var(--accent-gold); }
        .tab-content { display: none; flex: 1; flex-direction: column; overflow: hidden; }
        .tab-content.active { display: flex; }
        
        /* Tagging Panel */
        .tagging-panel { flex: 1; overflow-y: auto; padding: 20px; }
        .ai-banner {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 0.8125em;
        }
        .tag-section { margin-bottom: 24px; }
        .tag-section-title {
            font-size: 0.875em;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tag-count { 
            background: rgba(201, 169, 97, 0.2); 
            padding: 2px 8px; 
            border-radius: 10px; 
            font-size: 0.75em; 
        }
        .tag-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
        .tag-item {
            background: rgba(28, 25, 22, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8125em;
        }
        .tag-item.ai-suggested { 
            border-color: rgba(102, 126, 234, 0.5); 
            background: rgba(102, 126, 234, 0.1); 
        }
        .tag-badge { 
            font-size: 0.65em; 
            padding: 3px 8px; 
            border-radius: 4px; 
            background: rgba(102, 126, 234, 0.2); 
            color: #667eea; 
            margin-right: 8px; 
        }
        .tag-actions { display: flex; gap: 4px; }
        .tag-action-btn {
            width: 24px;
            height: 24px;
            background: transparent;
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tag-action-btn.accept { border-color: var(--success); color: var(--success); }
        .tag-action-btn.reject { border-color: var(--error); color: var(--error); }
        .add-tag-btn {
            width: 100%;
            padding: 10px;
            background: rgba(28, 25, 22, 0.4);
            border: 1px dashed var(--glass-border);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8125em;
        }
        
        /* Notes Tab */
        .notes-content { flex: 1; padding: 20px; overflow-y: auto; }
        .notes-textarea {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            background: rgba(10, 9, 8, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 0.875em;
            font-family: 'Inter', sans-serif;
            resize: vertical;
        }
        
        /* Import Modal */
        .import-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 9, 8, 0.85);
            backdrop-filter: blur(12px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .import-modal.active { display: flex; }
        .import-modal-content {
            background: rgba(18, 16, 14, 0.95);
            backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .import-modal-title { font-size: 1.25em; font-weight: 600; margin-bottom: 20px; }
        .import-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        .import-option {
            padding: 20px;
            background: rgba(28, 25, 22, 0.4);
            border: 2px dashed var(--glass-border);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }
        .import-option:hover {
            border-color: var(--accent-gold);
            background: rgba(201, 169, 97, 0.1);
            border-style: solid;
        }
        .import-option-icon { font-size: 2em; margin-bottom: 8px; }
        .import-option-text { font-size: 0.875em; color: var(--text-muted); }
        
        .script-paste-area {
            display: none;
            margin-top: 20px;
        }
        .script-paste-area.active { display: block; }
        .script-textarea {
            width: 100%;
            min-height: 300px;
            padding: 12px;
            background: rgba(10, 9, 8, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-light);
            font-family: 'Courier New', monospace;
            font-size: 0.875em;
            resize: vertical;
        }
        .import-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        .modal-btn { 
            padding: 10px 20px; 
            border: 1px solid var(--glass-border); 
            border-radius: 8px; 
            cursor: pointer; 
            background: transparent; 
            color: var(--text-light);
            font-size: 0.875em;
        }
        .modal-btn.primary { 
            background: var(--accent-gold); 
            border-color: var(--accent-gold); 
            color: #0a0908; 
            font-weight: 600; 
        }
        
        /* Loading */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 9, 8, 0.9);
            backdrop-filter: blur(12px);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }
        .loading-overlay.active { display: flex; }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(212, 175, 122, 0.2);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            color: var(--text-muted);
            padding: 40px;
            font-size: 0.875em;
        }
        
        /* Status Messages */
        .status-msg {
            padding: 10px 16px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 0.875em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-msg.info {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            color: var(--accent-blue);
        }
        .status-msg.success {
            background: rgba(82, 193, 134, 0.1);
            border: 1px solid rgba(82, 193, 134, 0.3);
            color: var(--success);
        }
        .status-msg.warning {
            background: rgba(232, 168, 124, 0.1);
            border: 1px solid rgba(232, 168, 124, 0.3);
            color: var(--warning);
        }
        .status-msg.error {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            color: var(--error);
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <div class="top-bar">
            <div style="display: flex; align-items: center; gap: 24px;">
                <div onclick="goBack()" class="back-link">‚Üê Dashboard</div>
                <h1 class="page-title" id="projectTitle">Script Breakdown</h1>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="toolbar-btn import" onclick="openImportModal()">üìÑ Import Script</button>
                <button class="toolbar-btn" onclick="reprocessScript()">üîÑ Reprocess</button>
                <button class="toolbar-btn ai" onclick="runAIAnalysis()">ü§ñ AI Auto-Tag</button>
                <button class="toolbar-btn primary" onclick="generateBreakdown()">‚ú® Generate Report</button>
            </div>
        </div>
        <div class="main-content">
            <div class="left-sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">SCENES (<span id="sceneCount">0</span>)</div>
                    <input type="text" class="scene-search" placeholder="Search scenes..." id="sceneSearch">
                </div>
                <div class="scene-list" id="sceneList">
                    <div class="empty-state">No scenes yet</div>
                </div>
            </div>
            <div class="center-panel">
                <div class="script-toolbar">
                    <div class="tag-legend">
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-makeup)"></div>Makeup</div>
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-hair)"></div>Hair</div>
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-sfx)"></div>SFX</div>
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-cast)"></div>Cast</div>
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-wardrobe)"></div>Wardrobe</div>
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-props)"></div>Props</div>
                    </div>
                </div>
                <div class="script-viewer">
                    <div class="script-container" id="scriptContainer">
                        <div class="script-content" id="scriptContent">
                            <div class="no-script-state">
                                <div class="no-script-icon">üìÑ</div>
                                <div class="no-script-title">No Script Loaded</div>
                                <div class="no-script-desc">Import a screenplay to begin breaking down scenes, characters, and production elements.</div>
                                <div class="import-actions">
                                    <button class="toolbar-btn import" onclick="openImportModal()">
                                        üìÅ Upload File
                                    </button>
                                    <button class="toolbar-btn" onclick="openImportWizard()">
                                        üé¨ Import Wizard
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="right-sidebar">
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" onclick="switchTab('tags')">üè∑Ô∏è Tags</button>
                    <button class="sidebar-tab" onclick="switchTab('notes')">üìù Notes</button>
                </div>
                <div class="tab-content active" id="tagsTab">
                    <div class="tagging-panel" id="taggingPanel">
                        <div class="empty-state">Select a scene to view tags</div>
                    </div>
                </div>
                <div class="tab-content" id="notesTab">
                    <div class="notes-content">
                        <textarea class="notes-textarea" id="notesTextarea" placeholder="Enter scene notes..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Import Modal -->
    <div class="import-modal" id="importModal">
        <div class="import-modal-content">
            <div class="import-modal-title">Import Script</div>
            <div class="import-options">
                <div class="import-option" onclick="selectImportOption('file')">
                    <div class="import-option-icon">üìÅ</div>
                    <div class="import-option-text">Upload File</div>
                </div>
                <div class="import-option" onclick="selectImportOption('paste')">
                    <div class="import-option-icon">üìã</div>
                    <div class="import-option-text">Paste Text</div>
                </div>
                <div class="import-option" onclick="selectImportOption('wizard')">
                    <div class="import-option-icon">üé¨</div>
                    <div class="import-option-text">Import Wizard</div>
                </div>
                <div class="import-option" onclick="selectImportOption('sample')">
                    <div class="import-option-icon">üìù</div>
                    <div class="import-option-text">Use Sample</div>
                </div>
            </div>
            
            <input type="file" id="fileInput" accept=".txt,.fountain,.fdx,.pdf" style="display: none;">
            
            <div class="script-paste-area" id="pasteArea">
                <textarea class="script-textarea" id="scriptTextarea" placeholder="Paste your screenplay here...

INT. COFFEE SHOP - DAY

JANE sits alone at a corner table.

JANE
This better work..."></textarea>
            </div>
            
            <div id="importStatus"></div>
            
            <div class="import-modal-actions">
                <button class="modal-btn" onclick="closeImportModal()">Cancel</button>
                <button class="modal-btn primary" onclick="processImport()">Import Script</button>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div style="color: var(--text-light); font-weight: 600;" id="loadingText">Processing...</div>
    </div>

    <script>
        // Global variables
        let currentProject = null;
        let parsedScript = null;
        let currentScene = 0;
        let sceneTags = {};
        let sceneNotes = {};
        let selectedImportMethod = null;

        // Initialize
        async function init() {
            console.log('üöÄ Initializing Script Breakdown...');
            
            // Load current project
            currentProject = JSON.parse(localStorage.getItem('currentProject') || 'null');
            
            if (!currentProject) {
                console.error('‚ùå No project found');
                showStatus('error', 'No project selected. Please return to projects page.');
                return;
            }
            
            console.log('‚úÖ Project loaded:', currentProject.title);
            document.getElementById('projectTitle').textContent = currentProject.title + ' - Script Breakdown';
            
            // Load tags and notes if they exist
            sceneTags = currentProject.sceneTags || {};
            sceneNotes = currentProject.sceneNotes || {};
            
            // Check for script content
            if (currentProject.scriptContent) {
                console.log('üìÑ Found script content, processing...');
                processScript(currentProject.scriptContent);
            } else {
                console.log('‚ö†Ô∏è No script content found');
                // Show import options
            }
            
            // Setup event listeners
            document.getElementById('sceneSearch').addEventListener('input', handleSceneSearch);
        }

        // Process script text
        function processScript(scriptText) {
            if (!scriptText || !scriptText.trim()) {
                showStatus('error', 'No script text to process');
                return;
            }
            
            showLoading('Parsing screenplay...');
            
            try {
                // Parse the script
                parsedScript = parseScreenplay(scriptText);
                
                console.log(`Found ${parsedScript.scenes.length} scenes`);
                
                if (parsedScript.scenes.length === 0) {
                    hideLoading();
                    showStatus('warning', 'No scenes detected. The script may need formatting.');
                    
                    // Show the script anyway
                    document.getElementById('scriptContent').innerHTML = `
                        <div style="white-space: pre-wrap; font-family: 'Courier New', monospace;">
                            ${escapeHtml(scriptText)}
                        </div>
                    `;
                    return;
                }
                
                // Display the script
                displayScript();
                hideLoading();
                
                // Save to project
                currentProject.scenes = parsedScript.scenes.length;
                currentProject.characters = parsedScript.characters.length;
                saveProjectData();
                
            } catch (error) {
                console.error('Processing error:', error);
                hideLoading();
                showStatus('error', 'Error processing script: ' + error.message);
            }
        }

        // Parse screenplay
        function parseScreenplay(scriptText) {
            const lines = scriptText.split('\n');
            const scenes = [];
            const characters = new Set();
            let currentScene = null;
            let sceneNumber = 0;
            
            // Scene heading patterns
            const scenePatterns = [
                /^(INT\.|EXT\.|INT\/EXT\.|I\/E\.).*$/i,
                /^\d+[\.\s]+(INT\.|EXT\.).*$/i,
                /^(INTERIOR|EXTERIOR).*$/i
            ];
            
            lines.forEach((line, index) => {
                const trimmed = line.trim();
                
                // Check if it's a scene heading
                let isSceneHeading = false;
                for (let pattern of scenePatterns) {
                    if (pattern.test(trimmed)) {
                        isSceneHeading = true;
                        break;
                    }
                }
                
                if (isSceneHeading) {
                    // Save previous scene
                    if (currentScene) {
                        scenes.push(currentScene);
                    }
                    
                    // Start new scene
                    sceneNumber++;
                    currentScene = {
                        number: sceneNumber,
                        heading: trimmed,
                        lines: [],
                        startLine: index
                    };
                } else if (currentScene) {
                    // Add line to current scene
                    currentScene.lines.push(line);
                    
                    // Check for character names (uppercase lines)
                    if (trimmed && trimmed === trimmed.toUpperCase() && 
                        trimmed.length < 30 && !trimmed.includes('.')) {
                        const charName = trimmed.replace(/\(.*\)/, '').trim();
                        if (charName) {
                            characters.add(charName);
                        }
                    }
                }
            });
            
            // Save last scene
            if (currentScene) {
                scenes.push(currentScene);
            }
            
            return {
                scenes: scenes,
                characters: Array.from(characters),
                totalLines: lines.length
            };
        }

        // Display parsed script
        function displayScript() {
            if (!parsedScript || !parsedScript.scenes) return;
            
            // Update scene count
            document.getElementById('sceneCount').textContent = parsedScript.scenes.length;
            
            // Generate scene list
            const sceneList = document.getElementById('sceneList');
            sceneList.innerHTML = '';
            
            parsedScript.scenes.forEach((scene, index) => {
                const sceneItem = document.createElement('div');
                sceneItem.className = 'scene-item';
                if (index === 0) sceneItem.classList.add('active');
                sceneItem.onclick = () => scrollToScene(index);
                
                sceneItem.innerHTML = `
                    <div class="scene-number">${scene.number}</div>
                    <div class="scene-heading">${scene.heading}</div>
                `;
                
                sceneList.appendChild(sceneItem);
            });
            
            // Generate script HTML
            let scriptHTML = '';
            parsedScript.scenes.forEach((scene, index) => {
                scriptHTML += `
                    <div class="script-scene" id="scene-${scene.number}">
                        <div class="script-scene-heading">${scene.number}. ${scene.heading}</div>
                `;
                
                // Format scene content
                scene.lines.forEach(line => {
                    const trimmed = line.trim();
                    
                    if (!trimmed) {
                        // Empty line
                        scriptHTML += '<br>';
                    } else if (trimmed === trimmed.toUpperCase() && trimmed.length < 30) {
                        // Character name
                        scriptHTML += `<div class="script-character">${trimmed}</div>`;
                    } else if (trimmed.startsWith('(') && trimmed.endsWith(')')) {
                        // Parenthetical
                        scriptHTML += `<div class="script-parenthetical">${trimmed}</div>`;
                    } else if (trimmed.includes('CUT TO:') || trimmed.includes('FADE')) {
                        // Transition
                        scriptHTML += `<div class="script-transition">${trimmed}</div>`;
                    } else {
                        // Action or dialogue
                        const indent = line.search(/\S/);
                        if (indent > 10) {
                            // Dialogue
                            scriptHTML += `<div class="script-dialogue">${trimmed}</div>`;
                        } else {
                            // Action
                            scriptHTML += `<div class="script-action">${trimmed}</div>`;
                        }
                    }
                });
                
                scriptHTML += '</div>';
            });
            
            document.getElementById('scriptContent').innerHTML = scriptHTML;
            
            // Load tags for first scene
            if (parsedScript.scenes.length > 0) {
                displayTagsForScene(0);
            }
        }

        // Import modal functions
        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
            selectedImportMethod = null;
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
            document.getElementById('pasteArea').classList.remove('active');
            document.getElementById('scriptTextarea').value = '';
        }

        function selectImportOption(option) {
            selectedImportMethod = option;
            
            if (option === 'file') {
                document.getElementById('fileInput').click();
            } else if (option === 'paste') {
                document.getElementById('pasteArea').classList.add('active');
                document.getElementById('scriptTextarea').focus();
            } else if (option === 'wizard') {
                // Save context and open wizard
                localStorage.setItem('importContext', JSON.stringify({
                    projectId: currentProject.title,
                    returnUrl: window.location.href
                }));
                window.open('script-import-wizard.html', '_blank');
                closeImportModal();
            } else if (option === 'sample') {
                loadSampleScript();
            }
        }

        function loadSampleScript() {
            const sampleScript = `FADE IN:

INT. COFFEE SHOP - DAY

A cozy neighborhood coffee shop. Morning light streams through the windows.

JANE (30s, writer) sits alone at a corner table, laptop open, coffee steaming.

JANE
(to herself)
This is it. Today's the day.

She takes a deep breath and begins typing.

MIKE (35, barista) approaches with a fresh cup.

MIKE
Another refill?

JANE
(looking up, smiling)
You're a lifesaver.

MIKE
Writer's fuel. I get it.
(beat)
Working on the big novel?

JANE
Screenplay, actually. It's about--

The door chimes. SARAH (20s, energetic) bursts in.

SARAH
Jane! There you are!

CUT TO:

EXT. PARK - LATER

Jane and Sarah walk along a tree-lined path.

SARAH
You can't just hide in coffee shops forever.

JANE
I'm not hiding. I'm writing.

SARAH
Same difference.

FADE OUT.`;

            document.getElementById('scriptTextarea').value = sampleScript;
            document.getElementById('pasteArea').classList.add('active');
            showStatus('info', 'Sample script loaded. Click Import to process.');
        }

        function processImport() {
            const scriptText = document.getElementById('scriptTextarea').value;
            
            if (!scriptText || !scriptText.trim()) {
                showStatus('error', 'Please paste or upload a script first');
                return;
            }
            
            // Save to current project
            currentProject.scriptContent = scriptText;
            saveProjectData();
            
            // Process the script
            processScript(scriptText);
            
            // Close modal
            closeImportModal();
        }

        // File input handler
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                document.getElementById('scriptTextarea').value = text;
                document.getElementById('pasteArea').classList.add('active');
                showStatus('success', 'File loaded successfully');
            } catch (error) {
                showStatus('error', 'Error reading file: ' + error.message);
            }
        });

        // Reprocess script
        function reprocessScript() {
            if (currentProject && currentProject.scriptContent) {
                console.log('üîÑ Reprocessing script...');
                processScript(currentProject.scriptContent);
            } else {
                showStatus('warning', 'No script to reprocess');
            }
        }

        // Open import wizard
        function openImportWizard() {
            localStorage.setItem('importContext', JSON.stringify({
                projectId: currentProject.title,
                returnUrl: window.location.href
            }));
            window.location.href = 'script-import-wizard.html';
        }

        // Display tags for a specific scene
        function displayTagsForScene(sceneIndex) {
            const tags = sceneTags[sceneIndex + 1] || [];
            const panel = document.getElementById('taggingPanel');
            
            const categories = [
                { id: 'makeup', name: 'Makeup', color: 'var(--tag-makeup)' },
                { id: 'hair', name: 'Hair', color: 'var(--tag-hair)' },
                { id: 'sfx', name: 'SFX', color: 'var(--tag-sfx)' },
                { id: 'cast', name: 'Cast', color: 'var(--tag-cast)' },
                { id: 'wardrobe', name: 'Wardrobe', color: 'var(--tag-wardrobe)' },
                { id: 'props', name: 'Props', color: 'var(--tag-props)' }
            ];
            
            let html = '';
            
            // Category sections
            categories.forEach(category => {
                const categoryTags = tags.filter(t => t.category === category.id);
                
                html += `<div class="tag-section">`;
                html += `<div class="tag-section-title">
                    ${category.name} 
                    ${categoryTags.length > 0 ? `<span class="tag-count">${categoryTags.length}</span>` : ''}
                </div>`;
                
                if (categoryTags.length > 0) {
                    html += '<div class="tag-list">';
                    categoryTags.forEach((tag, i) => {
                        html += `<div class="tag-item">
                            <div>${tag.description}</div>
                            <button class="tag-action-btn reject" onclick="removeTag(${sceneIndex + 1}, '${category.id}', ${i})">‚úï</button>
                        </div>`;
                    });
                    html += '</div>';
                }
                
                html += `<button class="add-tag-btn" onclick="addManualTag(${sceneIndex + 1}, '${category.id}')">+ Add ${category.name}</button>`;
                html += '</div>';
            });
            
            panel.innerHTML = html || '<div class="empty-state">No tags yet</div>';
        }

        // AI Analysis placeholder
        async function runAIAnalysis() {
            if (!parsedScript || parsedScript.scenes.length === 0) {
                showStatus('warning', 'Please import a script first');
                return;
            }
            
            showStatus('info', 'AI analysis requires API configuration. Coming soon!');
        }

        // Navigation functions
        function scrollToScene(sceneIndex) {
            currentScene = sceneIndex;
            
            // Update active state
            document.querySelectorAll('.scene-item').forEach((item, index) => {
                item.classList.toggle('active', index === sceneIndex);
            });
            
            // Scroll to scene
            const sceneElement = document.getElementById(`scene-${sceneIndex + 1}`);
            if (sceneElement) {
                sceneElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            // Update tags panel
            displayTagsForScene(sceneIndex);
            
            // Load notes
            document.getElementById('notesTextarea').value = sceneNotes[sceneIndex + 1] || '';
        }

        function handleSceneSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            const sceneItems = document.querySelectorAll('.scene-item');
            
            sceneItems.forEach((item, index) => {
                const heading = parsedScript.scenes[index].heading.toLowerCase();
                item.style.display = heading.includes(searchTerm) ? 'block' : 'none';
            });
        }

        function switchTab(tab) {
            document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'tags') {
                document.querySelector('.sidebar-tab:nth-child(1)').classList.add('active');
                document.getElementById('tagsTab').classList.add('active');
            } else {
                document.querySelector('.sidebar-tab:nth-child(2)').classList.add('active');
                document.getElementById('notesTab').classList.add('active');
            }
        }

        // Tag management
        function addManualTag(sceneNumber, category) {
            const description = prompt(`Add ${category} tag:`);
            if (!description) return;
            
            if (!sceneTags[sceneNumber]) {
                sceneTags[sceneNumber] = [];
            }
            
            sceneTags[sceneNumber].push({
                category: category,
                description: description
            });
            
            saveProjectData();
            displayTagsForScene(currentScene);
        }

        function removeTag(sceneNumber, category, tagIndex) {
            const categoryTags = (sceneTags[sceneNumber] || []).filter(t => t.category === category);
            
            if (categoryTags[tagIndex]) {
                sceneTags[sceneNumber] = sceneTags[sceneNumber].filter(t => t !== categoryTags[tagIndex]);
                saveProjectData();
                displayTagsForScene(currentScene);
            }
        }

        // Save project data
        function saveProjectData() {
            if (currentProject) {
                currentProject.sceneTags = sceneTags;
                currentProject.sceneNotes = sceneNotes;
                
                localStorage.setItem('currentProject', JSON.stringify(currentProject));
                
                // Also update in projects list
                const projects = JSON.parse(localStorage.getItem('checksHappyProjects') || '[]');
                const projectIndex = projects.findIndex(p => p.title === currentProject.title);
                if (projectIndex !== -1) {
                    projects[projectIndex] = currentProject;
                    localStorage.setItem('checksHappyProjects', JSON.stringify(projects));
                }
            }
        }

        // UI Helper functions
        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function showStatus(type, message) {
            console.log(`[${type}] ${message}`);
            
            // Create status message element
            const statusEl = document.createElement('div');
            statusEl.className = `status-msg ${type}`;
            statusEl.innerHTML = `
                <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
                <span>${message}</span>
            `;
            
            // Add to page temporarily
            document.querySelector('.top-bar').appendChild(statusEl);
            
            setTimeout(() => {
                statusEl.remove();
            }, 3000);
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function goBack() {
            window.location.href = 'dashboard.html';
        }

        function generateBreakdown() {
            if (!parsedScript) {
                showStatus('warning', 'Please load a script first');
                return;
            }
            
            // Count total tags
            let totalTags = 0;
            Object.values(sceneTags).forEach(tags => {
                totalTags += tags.length;
            });
            
            showStatus('success', `Breakdown ready: ${parsedScript.scenes.length} scenes, ${parsedScript.characters.length} characters, ${totalTags} tags`);
        }

        // Save notes on change
        document.getElementById('notesTextarea').addEventListener('change', function() {
            sceneNotes[currentScene + 1] = this.value;
            saveProjectData();
        });

        // Initialize on page load
        init();
    </script>
</body>
</html>
