<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Script Breakdown - Checks Happy</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">

    <!-- External Stylesheet -->
    <link rel="stylesheet" href="/css/script-breakdown.css">
    <link rel="stylesheet" href="/css/chat-assistant.css">
</head>
<body>
    <!-- Top Loading Bar -->
    <div id="top-loading-bar" class="top-loading-bar" style="display: none;">
        <div class="top-loading-progress" id="top-loading-progress"></div>
        <div class="top-loading-content">
            <div class="top-loading-message" id="top-loading-message">Processing...</div>
            <div class="top-loading-details" id="top-loading-details"></div>
        </div>
    </div>

    <div class="app-layout">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="nav-section">
                <a href="dashboard.html" class="back-link">‚Üê Dashboard</a>
                <h1 class="page-title" id="projectTitle">Script Breakdown</h1>
            </div>
            <div class="toolbar">
                <button class="toolbar-btn" onclick="openToolsPanel()">Tools</button>
                <button class="toolbar-btn" onclick="openImportModal()">Import Script</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Sidebar - Scenes -->
            <div class="left-sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">
                        <span>SCENES</span>
                        <span class="scene-count" id="scene-count">0</span>
                    </div>
                    <input type="text" class="scene-search" placeholder="Search scenes..." id="scene-search">
                </div>
                <div class="scene-list" id="scene-list">
                    <div class="empty-state">
                        <div class="empty-title">No Scenes</div>
                        <div class="empty-desc">Import a screenplay to begin</div>
                    </div>
                </div>
            </div>

            <!-- Center Panel - Script & Character Tabs -->
            <div class="center-panel">
                <!-- Tab Bar -->
                <div class="center-tabs">
                    <div class="center-tab active" data-tab="script" onclick="switchCenterTab('script')">
                        Script
                    </div>
                    <!-- Character tabs generated dynamically -->
                </div>

                <!-- Tab Content Container -->
                <div class="center-tab-content">
                    <!-- Script Tab -->
                    <div class="center-tab-panel active" id="script-tab-panel">
                        <div class="script-toolbar">
                            <div class="color-legend">
                                <span class="legend-item"><span class="legend-color" style="background: #fbbf24;"></span>Cast</span>
                                <span class="legend-item"><span class="legend-color" style="background: #a855f7;"></span>Hair</span>
                                <span class="legend-item"><span class="legend-color" style="background: #ec4899;"></span>Makeup</span>
                                <span class="legend-item"><span class="legend-color" style="background: #ef4444;"></span>SFX</span>
                                <span class="legend-item"><span class="legend-color" style="background: #f59e0b;"></span>Health</span>
                                <span class="legend-item"><span class="legend-color" style="background: #dc2626;"></span>Injuries</span>
                                <span class="legend-item"><span class="legend-color" style="background: #f97316;"></span>Stunts</span>
                                <span class="legend-item"><span class="legend-color" style="background: #38bdf8;"></span>Weather</span>
                                <span class="legend-item"><span class="legend-color" style="background: #34d399;"></span>Wardrobe</span>
                                <span class="legend-item"><span class="legend-color" style="background: #9ca3af;"></span>Extras</span>
                            </div>
                            <div class="view-controls">
                                <button class="view-btn" id="zoom-in" onclick="zoomIn()">Zoom In</button>
                                <button class="view-btn" id="zoom-out" onclick="zoomOut()">Zoom Out</button>
                            </div>
                        </div>

                        <div class="script-viewer" id="script-viewer">
                            <div class="script-container">
                                <div class="script-content" id="script-content">
                                    <div class="empty-state">
                                        <div class="empty-title">No Script Loaded</div>
                                        <div class="empty-desc">Import your screenplay to begin</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Character Tab Panels (generated dynamically) -->
                </div>
            </div>

            <!-- Right Sidebar - Scene Breakdown -->
            <div class="right-sidebar">
                <div class="workspace-header">
                    <div class="workspace-title">SCENE BREAKDOWN</div>
                </div>

                <div class="workspace-content">
                    <div class="tab-panel active" id="breakdown-panel">
                        <div class="empty-state">
                            <div class="empty-title">Select a Scene</div>
                            <div class="empty-desc">Choose a scene to view and edit its breakdown</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================================================ -->
    <!-- MODALS -->
    <!-- ============================================================================ -->

    <!-- Add Element Modal -->
    <div class="modal" id="addElementModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-title">Add Element</div>
            <input type="text" class="modal-input" id="elementInput" placeholder="Enter element name...">
            <div class="modal-actions">
                <button class="modal-btn" onclick="closeAddElementModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmAddElement()">Add</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="import-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-title">Import Screenplay</div>
            <textarea class="modal-textarea" id="script-input" rows="20" placeholder="Paste your screenplay here..."></textarea>
            <div class="modal-actions">
                <button class="modal-btn" onclick="closeImportModal()">Cancel</button>
                <button class="modal-btn primary" onclick="processScript()">Import & Analyze</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settings-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-title">AI Settings</div>

            <!-- Anthropic/Claude Settings -->
            <div class="provider-settings" id="anthropic-settings">
                <div class="modal-section">
                    <label class="modal-label">Anthropic API Key</label>
                    <input type="password" class="modal-input" id="anthropic-api-key" placeholder="sk-ant-api03-...">
                    <div class="modal-note">For local testing only. Key stored in localStorage. Use serverless deployment for production.</div>
                </div>

                <div class="modal-section">
                    <label class="modal-label">Claude Model</label>
                    <select class="modal-select" id="anthropic-model">
                        <option value="claude-sonnet-4-20250514">Claude Sonnet 4 (Recommended)</option>
                        <option value="claude-opus-4-20250514">Claude Opus 4 (Best Quality)</option>
                        <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
                        <option value="claude-3-haiku-20240307">Claude 3 Haiku (Fastest/Cheapest)</option>
                    </select>
                </div>
            </div>

            <div class="modal-actions">
                <button class="modal-btn" onclick="testAPIConnection()">Test Connection</button>
                <button class="modal-btn" onclick="closeSettingsModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div class="modal" id="progress-modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-title" id="progress-title">Processing...</div>

            <div class="modal-section">
                <div class="progress-message" id="progress-message">Starting batch processing...</div>

                <div class="continuity-progress" style="margin: 20px 0;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
                    </div>
                    <div class="progress-label" id="progress-label">0 / 0</div>
                </div>

                <div class="progress-details" id="progress-details" style="font-size: 0.85em; color: var(--text-muted); margin-top: 8px;">
                    <!-- Details shown here -->
                </div>
            </div>

            <div class="modal-actions">
                <button class="modal-btn" id="progress-cancel-btn" onclick="cancelBatchProcessing()">Cancel</button>
                <button class="modal-btn primary" id="progress-done-btn" style="display: none;" onclick="closeProgressModal()">Done</button>
            </div>
        </div>
    </div>

    <!-- Continuity Edit Modal -->
    <div class="modal" id="continuity-edit-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-title" id="continuity-modal-title">Edit Continuity</div>

            <div class="modal-section">
                <label class="modal-label">Character</label>
                <div id="continuity-modal-character" style="font-weight: 600; color: var(--accent-gold); margin-bottom: 16px;"></div>

                <label class="modal-label">Category</label>
                <select class="modal-select" id="continuity-category">
                    <option value="hair">Hair</option>
                    <option value="makeup">Makeup</option>
                    <option value="sfx">SFX</option>
                    <option value="wardrobe">Wardrobe</option>
                    <option value="health">Health</option>
                    <option value="injuries">Injuries</option>
                    <option value="stunts">Stunts</option>
                </select>
            </div>

            <div class="modal-section">
                <label class="modal-label">Continuity Note</label>
                <textarea class="modal-textarea" id="continuity-note-text" rows="4" placeholder="Describe the appearance or condition for this category..."></textarea>
                <div class="modal-note">Note: Leave blank to remove this note</div>
            </div>

            <div class="modal-actions">
                <button class="modal-btn" onclick="closeContinuityEditModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveContinuityNote()">Save Note</button>
            </div>
        </div>
    </div>

    <!-- Character Review Modal - Two Step Workflow -->
    <div class="modal" id="character-review-modal" style="display: none;">
        <div class="modal-content character-review-modal-v2">
            <!-- Header -->
            <div class="character-review-header">
                <div class="character-review-title">Character Confirmation</div>
                <button class="character-review-close" onclick="closeCharacterReviewModal()">&times;</button>
            </div>

            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step-item active" id="step-indicator-1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Merge Duplicates</div>
                </div>
                <div class="step-connector"></div>
                <div class="step-item" id="step-indicator-2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Confirm Selection</div>
                </div>
            </div>

            <!-- Step 1: Merge Duplicates -->
            <div class="step-content" id="step-1-content">
                <div class="step-description">
                    <strong>Clean up duplicate character names</strong>
                    <p>Click characters to select for merging. When 2+ are selected, merge options appear.</p>
                </div>

                <div class="character-review-list" id="character-merge-list">
                    <!-- Characters rendered here -->
                </div>

                <!-- Inline Merge Prompt -->
                <div class="merge-prompt" id="merge-prompt" style="display: none;">
                    <div class="merge-prompt-header">Merge Characters</div>
                    <div class="merge-prompt-body">
                        <div class="merge-preview">
                            <span class="merge-preview-label">Selected:</span>
                            <div class="merge-preview-names" id="merge-preview-names"></div>
                        </div>
                        <div class="merge-options" id="merge-options">
                            <!-- Radio options for names -->
                        </div>
                        <div class="merge-custom-option">
                            <label class="merge-radio-label">
                                <input type="radio" name="merge-name" id="merge-custom-radio" value="custom">
                                <span>Custom name:</span>
                            </label>
                            <input type="text" class="merge-custom-input" id="merge-custom-input" placeholder="Enter custom name..." oninput="document.getElementById('merge-custom-radio').checked = true;">
                        </div>
                    </div>
                    <div class="merge-prompt-actions">
                        <button class="modal-btn" onclick="cancelMerge()">Cancel</button>
                        <button class="modal-btn primary" onclick="confirmMerge()">Merge Characters</button>
                    </div>
                </div>

                <div class="step-actions">
                    <button class="modal-btn" onclick="closeCharacterReviewModal()">Cancel</button>
                    <button class="modal-btn primary" onclick="goToStep2()">Continue to Selection ‚Üí</button>
                </div>
            </div>

            <!-- Step 2: Confirm Selection -->
            <div class="step-content" id="step-2-content" style="display: none;">
                <div class="step-description">
                    <strong>Select characters to include in breakdown</strong>
                    <p>Check the characters you want to track. Unchecked characters will not appear in your breakdown.</p>
                </div>

                <div class="selection-controls">
                    <label class="auto-select-toggle">
                        <input type="checkbox" id="auto-select-high" checked onchange="toggleAutoSelectHigh()">
                        <span>Auto-select high confidence</span>
                    </label>
                    <div class="selection-buttons">
                        <button class="modal-btn small" onclick="selectAllCharacters()">Select All</button>
                        <button class="modal-btn small" onclick="deselectAllCharacters()">Deselect All</button>
                    </div>
                </div>

                <div class="character-review-list" id="character-selection-list">
                    <!-- Characters with checkboxes rendered here -->
                </div>

                <div class="selection-stats" id="selection-stats">
                    <!-- Stats rendered here -->
                </div>

                <div class="step-actions">
                    <button class="modal-btn" onclick="goToStep1()">‚Üê Back to Merging</button>
                    <button class="modal-btn primary" onclick="confirmCharacterSelection()">Confirm & Process</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Characters Not Confirmed Modal -->
    <div class="modal" id="characters-not-confirmed-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-title">Characters Not Confirmed</div>
            <div class="modal-section">
                <p>Please detect and review characters before running Auto Tag.</p>
                <p style="margin-top: 12px; color: var(--text-muted);">
                    Click "Detect & Review Characters" to parse your script and select which characters to track.
                </p>
            </div>
            <div class="modal-actions">
                <button class="modal-btn" onclick="closeCharactersNotConfirmedModal()">Cancel</button>
                <button class="modal-btn primary" onclick="closeCharactersNotConfirmedModal(); reviewCharacters();">Detect & Review Characters</button>
            </div>
        </div>
    </div>

    <!-- Script Supervisor Breakdown Upload Modal -->
    <div class="modal" id="supervisor-breakdown-modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-title">Upload Script Supervisor's Breakdown</div>

            <div class="modal-section">
                <div class="modal-note" style="margin-bottom: 16px;">
                    Upload the official continuity breakdown to cross-reference story days, timelines, and continuity notes.
                    Supported formats: PDF, Excel (.xlsx), CSV, or plain text (.txt)
                </div>

                <div class="file-upload-area" id="supervisor-file-upload-area" style="padding: 30px; text-align: center; border: 2px dashed var(--glass-border); border-radius: 12px; background: rgba(255, 255, 255, 0.02); cursor: pointer;">
                    <div style="font-size: 48px; margin-bottom: 12px;">üìã</div>
                    <div style="color: var(--text-light); margin-bottom: 8px;">Click to upload or drag and drop</div>
                    <div style="color: var(--text-muted); font-size: 0.875em;">PDF, XLSX, CSV, or TXT</div>
                    <input type="file" id="supervisor-file" accept=".pdf,.xlsx,.csv,.txt" style="display: none;">
                </div>

                <div id="supervisor-file-info" style="display: none; margin-top: 16px; padding: 12px; background: rgba(201, 169, 97, 0.1); border: 1px solid var(--accent-gold); border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 24px;">üìÑ</span>
                        <div style="flex: 1;">
                            <div id="supervisor-file-name" style="color: var(--text-light); font-weight: 500;"></div>
                            <div id="supervisor-file-size" style="color: var(--text-muted); font-size: 0.875em;"></div>
                        </div>
                        <button onclick="clearSupervisorFile()" style="padding: 6px 12px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 6px; color: #ef4444; cursor: pointer;">Remove</button>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="modal-btn" onclick="closeSupervisorUploadModal()">Cancel</button>
                <button class="modal-btn primary" id="process-supervisor-btn" onclick="processSupBreakdown()" disabled>Process & Cross-Reference</button>
            </div>
        </div>
    </div>

    <!-- Tag Popup (for creating tags from text selection) -->
    <div class="tag-popup" id="tag-popup">
        <div class="tag-popup-header">
            <div class="tag-popup-title">Create Tag</div>
            <button class="tag-popup-close" onclick="closeTagPopup()">√ó</button>
        </div>
        <div class="tag-popup-body">
            <div class="tag-field">
                <label>Selected Text</label>
                <div class="tag-selected-text" id="tag-selected-text"></div>
            </div>
            <div class="tag-field">
                <label>Category</label>
                <select id="tag-category" onchange="handleCategoryChange()">
                    <option value="cast">Cast Member</option>
                    <option value="hair">Hair</option>
                    <option value="makeup">Makeup</option>
                    <option value="sfx">SFX</option>
                    <option value="health">Health/Illness</option>
                    <option value="injuries">Injuries</option>
                    <option value="stunts">Stunts/Action</option>
                    <option value="weather">Weather</option>
                    <option value="wardrobe">Wardrobe</option>
                    <option value="extras">Extras</option>
                </select>
            </div>
            <div class="tag-field" id="tag-character-field">
                <label>Character</label>
                <select id="tag-character" onchange="handleCharacterChange()">
                    <option value="">Auto-detect</option>
                </select>
            </div>
            <div class="tag-field" id="tag-event-field" style="display: none;">
                <label>Link to Continuity Event</label>
                <select id="tag-event">
                    <option value="">None</option>
                </select>
                <div class="modal-note" style="margin-top: 4px; font-size: 0.85em;">
                    Link this tag to an active event for timeline tracking
                </div>
            </div>
        </div>
        <div class="tag-popup-footer">
            <button class="modal-btn" onclick="closeTagPopup()">Cancel</button>
            <button class="modal-btn primary" onclick="saveTag()">Create Tag</button>
        </div>
    </div>

    <!-- Tag Context Menu (right-click on tags) -->
    <div class="tag-context-menu" id="tag-context-menu" style="display: none;">
        <div class="context-menu-item" onclick="editTagFromContext()">Edit</div>
        <div class="context-menu-item" onclick="removeTagFromContext()">Delete</div>
        <div class="context-menu-item" onclick="linkToContinuityFromContext()">Link to Event</div>
        <div class="context-menu-item" onclick="jumpToTagsTab()">Go to Tags</div>
    </div>

    <!-- Tag Tooltip (hover on tags) -->
    <div class="tag-tooltip" id="tag-tooltip" style="display: none;"></div>

    <!-- Corner Progress Notification (Replaced with inline button progress) -->
    <!--
    <div class="corner-progress" id="corner-progress" style="display: none;">
        <div class="corner-progress-header">
            <div class="corner-progress-title" id="corner-progress-title">Processing...</div>
            <button class="corner-progress-minimize" onclick="toggleCornerProgress()">‚àí</button>
            <button class="corner-progress-close" onclick="cancelBatchProcessing()">√ó</button>
        </div>
        <div class="corner-progress-body" id="corner-progress-body">
            <div class="corner-progress-message" id="corner-progress-message">Starting...</div>
            <div class="corner-progress-bar">
                <div class="corner-progress-fill" id="corner-progress-fill" style="width: 0%;"></div>
            </div>
            <div class="corner-progress-label" id="corner-progress-label">0 / 0</div>
            <div class="corner-progress-details" id="corner-progress-details"></div>
        </div>
    </div>
    -->

    <!-- Create Continuity Event Modal -->
    <div class="modal" id="create-event-modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-title">Create Continuity Event</div>

            <div class="modal-section">
                <label class="modal-label">Character</label>
                <div id="event-character-name" style="color: var(--accent-gold); font-weight: 600; margin-bottom: 16px;"></div>

                <label class="modal-label">Event Name</label>
                <input type="text" class="modal-input" id="event-name"
                       placeholder="e.g., Forehead Cut, Flu Illness, Pregnancy">

                <label class="modal-label">Category</label>
                <select class="modal-select" id="event-category">
                    <option value="injuries">Injury/Wound</option>
                    <option value="health">Illness/Health</option>
                    <option value="sfx">SFX/Prosthetics</option>
                    <option value="aging">Aging</option>
                    <option value="pregnancy">Pregnancy</option>
                    <option value="dirt">Dirt/Blood/Wear</option>
                    <option value="other">Other</option>
                </select>

                <label class="modal-label">Starting Scene</label>
                <input type="number" class="modal-input" id="event-start-scene"
                       value="" min="1">
                <div class="modal-note">Scene where this event begins</div>

                <label class="modal-label">Initial Description</label>
                <textarea class="modal-textarea" id="event-initial-description" rows="3"
                          placeholder="Describe the initial state (e.g., 'Fresh 2-inch cut above right eyebrow, bleeding')"></textarea>
            </div>

            <div class="modal-actions">
                <button class="modal-btn" onclick="closeCreateEventModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmCreateEvent()">Create Event</button>
            </div>
        </div>
    </div>

    <!-- Event Timeline Modal (Three-Column View) -->
    <div class="modal" id="event-timeline-modal" style="display: none;">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh;">
            <div class="modal-title" id="timeline-event-name">Event Timeline</div>

            <div class="modal-section">
                <div class="timeline-header">
                    <div class="timeline-info">
                        <div><strong>Character:</strong> <span id="timeline-character"></span></div>
                        <div><strong>Category:</strong> <span id="timeline-category"></span></div>
                        <div><strong>Scenes:</strong> <span id="timeline-range"></span></div>
                        <div><strong>Status:</strong> <span id="timeline-status"></span></div>
                    </div>
                    <button class="modal-btn primary" onclick="generateEventTimeline()"
                            id="generate-timeline-btn">
                        ü§ñ Generate AI Timeline
                    </button>
                </div>

                <!-- Three-Column Timeline View -->
                <div class="timeline-three-column">
                    <div class="timeline-column">
                        <div class="timeline-column-header">TIMELINE</div>
                        <div class="timeline-column-content" id="timeline-column">
                            <!-- Timeline entries (logged + generated) -->
                        </div>
                    </div>

                    <div class="timeline-column">
                        <div class="timeline-column-header">ACTOR PRESENCE</div>
                        <div class="timeline-column-content" id="actor-presence-column">
                            <!-- Actor presence scenes with visibility status -->
                        </div>
                    </div>

                    <div class="timeline-column">
                        <div class="timeline-column-header">KEY SCENES</div>
                        <div class="timeline-column-content" id="key-scenes-column">
                            <!-- Linked tags from script -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="modal-btn" onclick="closeEventTimelineModal()">Close</button>
                <button class="modal-btn" onclick="exportEventPDF()">üìÑ Export PDF</button>
            </div>
        </div>
    </div>

    <!-- ============================================================================ -->
    <!-- TOOLS PANEL -->
    <!-- ============================================================================ -->

    <!-- Tools Panel (Slide-out from right) -->
    <div class="tools-panel" id="tools-panel">
        <div class="tools-panel-header">
            <div class="tools-panel-title">TOOLS</div>
            <button class="tools-panel-close" onclick="closeToolsPanel()">√ó</button>
        </div>

        <div class="tools-panel-content">
            <!-- WORKFLOW Status Section -->
            <div class="tools-section">
                <div class="tools-section-title">WORKFLOW</div>
                <div class="workflow-status" id="workflow-status">
                    <div class="workflow-item" id="workflow-script-status">
                        <span class="workflow-icon">üìÑ</span>
                        <span class="workflow-text">No Script Loaded</span>
                    </div>
                    <div class="workflow-item" id="workflow-characters-status" style="display: none;">
                        <span class="workflow-icon">üë•</span>
                        <span class="workflow-text">Characters: 0</span>
                    </div>
                    <div class="workflow-item" id="workflow-scenes-status" style="display: none;">
                        <span class="workflow-icon">üé¨</span>
                        <span class="workflow-text">Scenes: 0/0 processed</span>
                    </div>
                </div>
            </div>

            <!-- SCRIPT Section -->
            <div class="tools-section">
                <div class="tools-section-title">SCRIPT</div>
                <button class="tools-panel-btn" onclick="openImportModal(); closeToolsPanel();">
                    Import New Script
                </button>
                <button class="tools-panel-btn" onclick="openSupervisorUploadModal(); closeToolsPanel();">
                    Upload Supervisor Breakdown
                </button>
            </div>

            <!-- SCENE TOOLS Section -->
            <div class="tools-section">
                <div class="tools-section-title">SCENE TOOLS</div>
                <button class="tools-panel-btn" onclick="processCurrentScene(); closeToolsPanel();" id="process-current-scene-btn" disabled>
                    Process Current Scene
                </button>
                <button class="tools-panel-btn" onclick="processAllRemaining(); closeToolsPanel();" id="process-all-remaining-btn" disabled>
                    Process All Unprocessed
                </button>
                <button class="tools-panel-btn" onclick="reviewCharacters(); closeToolsPanel();">
                    Detect & Review Characters
                </button>
            </div>

            <!-- BREAKDOWN Section -->
            <div class="tools-section">
                <div class="tools-section-title">MASTER BREAKDOWN</div>
                <button class="tools-panel-btn" style="background: var(--accent-gold); color: var(--bg-dark); font-weight: 600;" onclick="window.location.href='generate-breakdown.html';">
                    Generate Master Breakdown
                </button>
                <div style="font-size: 0.75em; color: var(--text-muted); margin-top: 8px; padding: 0 8px;">
                    View full H&MU breakdown spreadsheet with all scenes and characters
                </div>
            </div>

            <!-- EXPORT Section -->
            <div class="tools-section">
                <div class="tools-section-title">EXPORT</div>
                <button class="tools-panel-btn" onclick="generateCharacterTimelines(); closeToolsPanel();">
                    Generate Timelines
                </button>
                <button class="tools-panel-btn" onclick="generateCharacterLookbooks(); closeToolsPanel();">
                    Generate Lookbooks
                </button>
                <button class="tools-panel-btn" onclick="exportBible(); closeToolsPanel();">
                    Export Bible
                </button>
            </div>

            <!-- SETTINGS Section -->
            <div class="tools-section">
                <div class="tools-section-title">SETTINGS</div>
                <button class="tools-panel-btn" onclick="openSettingsModal(); closeToolsPanel();">
                    AI Settings
                </button>
            </div>

            <!-- API USAGE Section -->
            <div class="tools-section">
                <div class="tools-section-title">API USAGE</div>
                <div class="api-stats" id="api-stats">
                    <div class="stat-item">
                        <span class="stat-label">Total Calls:</span>
                        <span class="stat-value" id="stat-calls">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Errors:</span>
                        <span class="stat-value" id="stat-errors">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Rate Limits:</span>
                        <span class="stat-value" id="stat-rate-limits">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Last Call:</span>
                        <span class="stat-value" id="stat-last-call">Never</span>
                    </div>
                </div>
                <button class="tools-panel-btn" onclick="resetAPIUsage()">Reset Stats</button>
                <button class="tools-panel-btn" onclick="showAPILimitHelp()">Check API Limits</button>
            </div>
        </div>
    </div>

    <!-- Tools Panel Overlay -->
    <div class="tools-panel-overlay" id="tools-panel-overlay" onclick="closeToolsPanel()"></div>

    <!-- ============================================================================ -->
    <!-- JAVASCRIPT MODULES -->
    <!-- ============================================================================ -->

    <!-- Load modules in correct order -->
    <script type="module">
        // Import and initialize the application
        import './js/script-breakdown/main.js';

        // Note: main.js handles all other module imports and initialization
        // The init() function is called automatically when main.js loads
    </script>

    <!-- Legacy global function exposure for HTML onclick handlers -->
    <!-- These are exposed in each module via window.functionName = ... -->

    <!-- Error Notification -->
    <div class="error-notification" id="error-notification" style="display: none;">
        <div class="error-content">
            <div class="error-icon">‚ö†Ô∏è</div>
            <div class="error-message" id="error-message"></div>
            <button class="error-close" onclick="closeErrorNotification()">√ó</button>
        </div>
    </div>

    <style>
        .error-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            max-width: 400px;
            background: rgba(239, 68, 68, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            z-index: 10001;
            animation: slideInRight 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .error-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .error-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .error-message {
            flex: 1;
            color: white;
            font-size: 14px;
            line-height: 1.5;
        }

        .error-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            line-height: 1;
        }

        .error-close:hover {
            opacity: 0.8;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* API Stats Styles */
        .api-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .stat-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
        }

        .stat-value {
            font-size: 13px;
            font-weight: 600;
            color: #fbbf24;
        }
    </style>

    <!-- Chat Assistant -->
    <script src="/js/chat-assistant.js"></script>
</body>
</html>
