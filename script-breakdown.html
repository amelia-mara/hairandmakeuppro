<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Script Breakdown - AI Enhanced</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-dark: #0a0908;
            --bg-medium: rgba(18, 16, 14, 0.85);
            --card-bg: rgba(28, 25, 22, 0.5);
            --text-light: #e8e6e3;
            --text-muted: #9a8f7f;
            --accent-gold: #d4af7a;
            --accent-gold-hover: #e0c08f;
            --glass-border: rgba(255, 255, 255, 0.06);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --success: #52c186;
            --error: #ff6b6b;
            --tag-makeup: #ff6b9d;
            --tag-hair: #c084fc;
            --tag-sfx: #38bdf8;
            --tag-cast: #fbbf24;
            --tag-wardrobe: #34d399;
            --tag-props: #fb923c;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(13, 11, 10, 0.4); }
        ::-webkit-scrollbar-thumb { background: rgba(138, 127, 115, 0.3); border-radius: 4px; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #050404 0%, #0f0d0c 50%, #050404 100%);
            color: var(--text-light);
            height: 100vh;
            overflow: hidden;
        }
        .app-layout { display: flex; height: 100vh; flex-direction: column; }
        
        /* Top Bar */
        .top-bar {
            height: 60px;
            background: linear-gradient(135deg, rgba(212, 175, 122, 0.08) 0%, rgba(18, 16, 14, 0.85) 50%, rgba(212, 175, 122, 0.05) 100%);
            backdrop-filter: blur(24px);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }
        .back-link { display: flex; align-items: center; gap: 8px; color: var(--text-muted); cursor: pointer; font-size: 0.875em; }
        .back-link:hover { color: var(--accent-gold); }
        .page-title { font-size: 1.125em; font-weight: 600; }
        .toolbar-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8125em;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .toolbar-btn:hover { border-color: var(--accent-gold); color: var(--accent-gold); }
        .toolbar-btn.primary { background: var(--accent-gold); border-color: var(--accent-gold); color: #0a0908; font-weight: 600; }
        .toolbar-btn.ai { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-color: #667eea; color: white; font-weight: 600; }
        
        /* Layout */
        .main-content { display: flex; flex: 1; overflow: hidden; }
        .left-sidebar, .right-sidebar {
            width: 300px;
            background: linear-gradient(135deg, rgba(212, 175, 122, 0.06) 0%, rgba(18, 16, 14, 0.85) 50%, rgba(212, 175, 122, 0.03) 100%);
            backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .right-sidebar { width: 380px; }
        
        /* Sidebar Elements */
        .sidebar-header { padding: 16px 20px; border-bottom: 1px solid var(--glass-border); }
        .sidebar-title { font-size: 0.875em; font-weight: 600; text-transform: uppercase; color: var(--text-muted); margin-bottom: 12px; }
        .scene-search {
            width: 100%;
            padding: 10px 14px;
            background: rgba(10, 9, 8, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 0.8125em;
        }
        .scene-search:focus { outline: none; border-color: var(--accent-gold); }
        .scene-list { flex: 1; overflow-y: auto; padding: 12px; }
        .scene-item {
            background: rgba(28, 25, 22, 0.5);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .scene-item:hover { border-color: var(--accent-gold); transform: translateX(4px); }
        .scene-item.active { border-color: var(--accent-gold); background: rgba(201, 169, 97, 0.15); }
        .scene-item.hidden { display: none; }
        .scene-number {
            width: 28px;
            height: 28px;
            background: var(--accent-gold);
            color: #0a0908;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.8125em;
            margin-bottom: 8px;
        }
        .scene-heading { font-size: 0.8125em; font-weight: 600; line-height: 1.3; }
        
        /* Center Panel */
        .center-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .script-toolbar {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 20px;
            background: var(--bg-medium);
            border-bottom: 1px solid var(--glass-border);
        }
        .tag-legend { display: flex; gap: 16px; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.75em; color: var(--text-muted); }
        .legend-color { width: 12px; height: 12px; border-radius: 3px; }
        .script-viewer { flex: 1; overflow-y: auto; padding: 40px; background: rgba(232, 230, 227, 0.03); }
        .script-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(248, 246, 240, 0.98);
            padding: 60px 80px;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }
        .script-content { font-family: 'Courier Prime', monospace; font-size: 12pt; line-height: 1.5; color: #000; user-select: text; }
        .script-scene { margin-bottom: 24px; }
        .script-scene-heading { font-weight: 700; text-transform: uppercase; margin-bottom: 12px; color: #000; }
        .script-action { margin-bottom: 12px; color: #000; }
        .script-character { margin: 12px 0 4px; text-align: center; text-transform: uppercase; color: #000; }
        .script-dialogue { margin-bottom: 12px; width: 70%; margin-left: 15%; color: #000; }
        .script-parenthetical { margin-bottom: 4px; width: 60%; margin-left: 20%; color: #000; }
        
        /* Tagged Text */
        .tagged { padding: 2px 4px; border-radius: 3px; cursor: pointer; user-select: none; }
        .tagged.makeup { background: rgba(255, 107, 157, 0.2); }
        .tagged.hair { background: rgba(192, 132, 252, 0.2); }
        .tagged.sfx { background: rgba(56, 189, 248, 0.2); }
        .tagged.cast { background: rgba(251, 191, 36, 0.2); }
        .tagged.wardrobe { background: rgba(52, 211, 153, 0.2); }
        .tagged.props { background: rgba(251, 146, 60, 0.2); }
        
        /* Right Sidebar Tabs */
        .sidebar-tabs { display: flex; border-bottom: 1px solid var(--glass-border); }
        .sidebar-tab {
            flex: 1;
            padding: 16px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8125em;
            border-bottom: 2px solid transparent;
        }
        .sidebar-tab.active { color: var(--accent-gold); border-bottom-color: var(--accent-gold); }
        .tab-content { display: none; flex: 1; flex-direction: column; overflow: hidden; }
        .tab-content.active { display: flex; }
        
        /* Tagging Panel */
        .tagging-panel { flex: 1; overflow-y: auto; padding: 20px; }
        .ai-banner {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 0.8125em;
        }
        .tag-section { margin-bottom: 24px; }
        .tag-section-title {
            font-size: 0.875em;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tag-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
        .tag-item {
            background: rgba(28, 25, 22, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tag-item.ai-suggested { border-color: rgba(102, 126, 234, 0.5); background: rgba(102, 126, 234, 0.1); }
        .tag-badge { font-size: 0.65em; padding: 3px 8px; border-radius: 4px; background: rgba(102, 126, 234, 0.2); color: #667eea; margin-right: 8px; }
        .tag-actions { display: flex; gap: 4px; }
        .tag-action-btn {
            width: 24px;
            height: 24px;
            background: transparent;
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75em;
        }
        .tag-action-btn.accept { border-color: var(--success); color: var(--success); }
        .tag-action-btn.reject { border-color: var(--error); color: var(--error); }
        .add-tag-btn {
            width: 100%;
            padding: 10px;
            background: rgba(28, 25, 22, 0.4);
            border: 1px dashed var(--glass-border);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8125em;
        }
        
        /* Notes */
        .notes-header { padding: 16px 20px; border-bottom: 1px solid var(--glass-border); }
        .notes-content { flex: 1; padding: 20px; overflow-y: auto; }
        .notes-textarea {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            background: rgba(10, 9, 8, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 0.875em;
            font-family: 'Inter', sans-serif;
            resize: vertical;
        }
        .notes-footer { padding: 16px 20px; border-top: 1px solid var(--glass-border); }
        .save-notes-btn {
            width: 100%;
            padding: 10px;
            background: var(--accent-gold);
            border: none;
            border-radius: 6px;
            color: #0a0908;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Tag Toolbar */
        .tag-toolbar {
            position: fixed;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 8px;
            display: none;
            gap: 4px;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        .tag-toolbar.active { display: flex; }
        .tag-toolbar-btn { padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.75em; border: none; }
        .tag-toolbar-btn.makeup { background: var(--tag-makeup); color: white; }
        .tag-toolbar-btn.hair { background: var(--tag-hair); color: white; }
        .tag-toolbar-btn.sfx { background: var(--tag-sfx); color: white; }
        .tag-toolbar-btn.cast { background: var(--tag-cast); color: #000; }
        .tag-toolbar-btn.wardrobe { background: var(--tag-wardrobe); color: white; }
        .tag-toolbar-btn.props { background: var(--tag-props); color: white; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 9, 8, 0.85); backdrop-filter: blur(12px); z-index: 2000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content {
            background: rgba(18, 16, 14, 0.95);
            backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
        }
        .modal-title { font-size: 1.25em; font-weight: 600; margin-bottom: 8px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 0.875em; color: var(--text-muted); margin-bottom: 8px; }
        .form-input, .form-select {
            width: 100%;
            padding: 10px 14px;
            background: rgba(10, 9, 8, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 0.875em;
        }
        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }
        .modal-btn { padding: 10px 20px; border: 1px solid var(--glass-border); border-radius: 8px; cursor: pointer; background: transparent; color: var(--text-light); }
        .modal-btn.primary { background: var(--accent-gold); border-color: var(--accent-gold); color: #0a0908; font-weight: 600; }
        
        /* Loading */
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 9, 8, 0.9); backdrop-filter: blur(12px); z-index: 3000; align-items: center; justify-content: center; flex-direction: column; gap: 20px; }
        .loading-overlay.active { display: flex; }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid rgba(212, 175, 122, 0.2); border-top-color: var(--accent-gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Error State */
        .error-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
        }
        .error-icon { font-size: 4em; margin-bottom: 20px; }
        .error-message { font-size: 1.125em; font-weight: 600; margin-bottom: 8px; }
        .error-hint { font-size: 0.875em; color: var(--text-muted); margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="app-layout">
        <div class="top-bar">
            <div style="display: flex; align-items: center; gap: 24px;">
                <div onclick="goBack()" class="back-link">‚Üê Dashboard</div>
                <h1 class="page-title" id="projectTitle">Script Breakdown</h1>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="toolbar-btn ai" onclick="runAIAnalysis()">ü§ñ AI Auto-Tag</button>
                <button class="toolbar-btn" onclick="openSettings()">‚öôÔ∏è Settings</button>
                <button class="toolbar-btn primary">‚ú® Generate</button>
            </div>
        </div>
        <div class="main-content">
            <div class="left-sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">Scenes (<span id="sceneCount">0</span>)</div>
                    <input type="text" class="scene-search" placeholder="Search scenes..." id="sceneSearch">
                </div>
                <div class="scene-list" id="sceneList">
                    <div class="error-state">
                        <div class="error-icon">üìÑ</div>
                        <div class="error-message">Loading script...</div>
                    </div>
                </div>
            </div>
            <div class="center-panel">
                <div class="script-toolbar">
                    <div class="tag-legend">
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-makeup)"></div>Makeup</div>
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-hair)"></div>Hair</div>
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-sfx)"></div>SFX</div>
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-cast)"></div>Cast</div>
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-wardrobe)"></div>Wardrobe</div>
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-props)"></div>Props</div>
                    </div>
                </div>
                <div class="script-viewer">
                    <div class="script-container">
                        <div class="script-content" id="scriptContent">
                            <div class="error-state">
                                <div class="error-icon">üìú</div>
                                <div class="error-message">No script loaded</div>
                                <div class="error-hint">Please upload a script from the projects page</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="right-sidebar">
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" onclick="switchTab('tags')">üè∑Ô∏è Tags</button>
                    <button class="sidebar-tab" onclick="switchTab('notes')">üìù Notes</button>
                </div>
                <div class="tab-content active" id="tagsTab">
                    <div class="tagging-panel" id="taggingPanel">Select a scene</div>
                </div>
                <div class="tab-content" id="notesTab">
                    <div class="notes-header">
                        <div style="font-size: 0.875em; font-weight: 600;">Scene Notes</div>
                    </div>
                    <div class="notes-content">
                        <textarea class="notes-textarea" id="notesTextarea" placeholder="Enter notes..."></textarea>
                    </div>
                    <div class="notes-footer">
                        <button class="save-notes-btn" onclick="saveNotes()">üíæ Save Notes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="tag-toolbar" id="tagToolbar">
        <button class="tag-toolbar-btn makeup" onclick="tagSelection('makeup')">üíÑ Makeup</button>
        <button class="tag-toolbar-btn hair" onclick="tagSelection('hair')">‚úÇÔ∏è Hair</button>
        <button class="tag-toolbar-btn sfx" onclick="tagSelection('sfx')">ü©∏ SFX</button>
        <button class="tag-toolbar-btn cast" onclick="tagSelection('cast')">üë§ Cast</button>
        <button class="tag-toolbar-btn wardrobe" onclick="tagSelection('wardrobe')">üëî Wardrobe</button>
        <button class="tag-toolbar-btn props" onclick="tagSelection('props')">üì¶ Props</button>
    </div>
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-title">AI Settings</div>
            <div class="form-group">
                <label class="form-label">AI Provider</label>
                <select class="form-select" id="aiProvider">
                    <option value="openai">OpenAI (GPT-4)</option>
                    <option value="anthropic">Anthropic (Claude)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">API Key</label>
                <input type="password" class="form-input" id="apiKey" placeholder="Enter your API key">
            </div>
            <div class="modal-actions">
                <button class="modal-btn" onclick="closeSettings()">Cancel</button>
                <button class="modal-btn primary" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div style="color: var(--text-light); font-weight: 600;" id="loadingText">Analyzing...</div>
    </div>
    <script>
        let currentProject = null;
        let scriptText = '';
        let scenes = [];
        let currentScene = 1;
        let sceneNotes = {};
        let sceneTags = {};
        let apiKey = '';
        let aiProvider = 'openai';
        
        function init() {
            console.log('üöÄ Initializing Script Breakdown...');
            
            // Load API settings
            apiKey = localStorage.getItem('aiApiKey') || '';
            aiProvider = localStorage.getItem('aiProvider') || 'openai';
            
            // Load current project
            currentProject = JSON.parse(localStorage.getItem('currentProject') || 'null');
            
            if (!currentProject) {
                console.error('‚ùå No project found');
                showError('No project selected', 'Please return to the projects page and select a project');
                return;
            }
            
            console.log('‚úÖ Project loaded:', currentProject.title);
            document.getElementById('projectTitle').textContent = currentProject.title + ' - Script Breakdown';
            
            // Load script content
            if (currentProject.scriptContent) {
                console.log('‚úÖ Script content found in project');
                scriptText = currentProject.scriptContent;
                sceneTags = currentProject.sceneTags || {};
                sceneNotes = currentProject.sceneNotes || {};
                parseAndDisplayScript(scriptText);
            } else {
                console.warn('‚ö†Ô∏è No script content in project');
                showError('No script found', 'This project doesn\'t have a script. Please upload one from the projects page.');
            }
            
            // Add text selection handler
            document.addEventListener('mouseup', handleTextSelection);
            
            // Add scene search handler
            document.getElementById('sceneSearch').addEventListener('input', handleSceneSearch);
        }
        
        function showError(title, message) {
            document.getElementById('scriptContent').innerHTML = `
                <div class="error-state">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <div class="error-message">${title}</div>
                    <div class="error-hint">${message}</div>
                    <button class="toolbar-btn primary" onclick="goBack()" style="margin-top: 20px;">‚Üê Back to Projects</button>
                </div>
            `;
            document.getElementById('sceneList').innerHTML = `
                <div class="error-state">
                    <div class="error-icon">üìÑ</div>
                    <div class="error-message">No scenes</div>
                </div>
            `;
        }
        
        function parseAndDisplayScript(text) {
            console.log('üìù Parsing script...', text.length, 'characters');
            const lines = text.split('\n');
            scenes = [];
            
            // Pattern to detect scene headings
            const patterns = [
                /^\s*(?:\d+\s+)?(?:\d+\s+)?(INT\.?|EXT\.?|INT\/EXT|I\/E)\s+/i,
            ];
            
            lines.forEach((line, index) => {
                const trimmed = line.trim();
                if (!trimmed) return;
                
                for (let pattern of patterns) {
                    if (pattern.test(trimmed)) {
                        const upperRatio = (trimmed.match(/[A-Z]/g) || []).length / trimmed.replace(/\s/g, '').length;
                        if (upperRatio > 0.5 && trimmed.length < 150) {
                            let cleanHeading = trimmed.replace(/^\s*(?:\d+\s+)?/, '').trim();
                            scenes.push({
                                id: Date.now() + index,
                                lineIndex: index,
                                heading: cleanHeading
                            });
                            console.log('üé¨ Found scene:', cleanHeading);
                            break;
                        }
                    }
                }
            });
            
            console.log('‚úÖ Found', scenes.length, 'scenes');
            document.getElementById('sceneCount').textContent = scenes.length;
            
            if (scenes.length === 0) {
                showError('No scenes detected', 'The script parser couldn\'t find any scene headings. Make sure your script uses standard INT. or EXT. scene headings.');
                return;
            }
            
            // Generate HTML for script display
            let html = '';
            scenes.forEach((scene, index) => {
                const sceneNumber = index + 1;
                const startLine = scene.lineIndex;
                let endLine = lines.length;
                if (index < scenes.length - 1) {
                    endLine = scenes[index + 1].lineIndex;
                }
                const sceneContent = lines.slice(startLine + 1, endLine).join('\n');
                
                html += `<div class="script-scene" id="scene-${sceneNumber}">`;
                html += `<div class="script-scene-heading">${sceneNumber}. ${scene.heading}</div>`;
                html += formatScriptContent(sceneContent);
                html += `</div>`;
            });
            
            document.getElementById('scriptContent').innerHTML = html;
            generateSceneList();
            
            if (scenes.length > 0) {
                scrollToScene(1);
            }
        }
        
        function formatScriptContent(content) {
            const lines = content.split('\n');
            let html = '';
            let inDialogue = false;
            
            lines.forEach(line => {
                const trimmed = line.trim();
                
                if (!trimmed) {
                    html += '<div>&nbsp;</div>';
                    inDialogue = false;
                    return;
                }
                
                // Scene heading
                if (/^(INT|EXT|INT\/EXT)[\.\s]+/i.test(trimmed)) {
                    html += `<div class="script-scene-heading">${trimmed}</div>`;
                    inDialogue = false;
                }
                // Parenthetical
                else if (trimmed.startsWith('(') && trimmed.endsWith(')')) {
                    html += `<div class="script-parenthetical">${trimmed}</div>`;
                    inDialogue = true;
                }
                // Character name
                else if (trimmed === trimmed.toUpperCase() && trimmed.length > 0 && trimmed.length < 40 && !inDialogue) {
                    html += `<div class="script-character">${trimmed}</div>`;
                    inDialogue = true;
                }
                // Dialogue
                else if (inDialogue) {
                    html += `<div class="script-dialogue">${trimmed}</div>`;
                }
                // Action
                else {
                    html += `<div class="script-action">${trimmed}</div>`;
                    inDialogue = false;
                }
            });
            
            return html;
        }
        
        function generateSceneList() {
            const sceneList = document.getElementById('sceneList');
            sceneList.innerHTML = '';
            
            scenes.forEach((scene, index) => {
                const sceneNumber = index + 1;
                const div = document.createElement('div');
                div.className = 'scene-item';
                div.dataset.sceneNumber = sceneNumber;
                div.dataset.heading = scene.heading.toLowerCase();
                if (sceneNumber === 1) div.classList.add('active');
                div.onclick = () => scrollToScene(sceneNumber);
                div.innerHTML = `
                    <div class="scene-number">${sceneNumber}</div>
                    <div class="scene-heading">${scene.heading}</div>
                `;
                sceneList.appendChild(div);
            });
        }
        
        function handleSceneSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            const sceneItems = document.querySelectorAll('.scene-item');
            
            sceneItems.forEach(item => {
                const heading = item.dataset.heading || '';
                const sceneNum = item.dataset.sceneNumber || '';
                
                if (heading.includes(searchTerm) || sceneNum.includes(searchTerm)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }
        
        function scrollToScene(sceneNum) {
            currentScene = sceneNum;
            
            document.querySelectorAll('.scene-item').forEach((item, index) => {
                if (index + 1 === sceneNum) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            const el = document.getElementById(`scene-${sceneNum}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            displayTaggingPanel(sceneNum - 1);
            document.getElementById('notesTextarea').value = sceneNotes[sceneNum] || '';
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'tags') {
                document.querySelectorAll('.sidebar-tab')[0].classList.add('active');
                document.getElementById('tagsTab').classList.add('active');
            } else {
                document.querySelectorAll('.sidebar-tab')[1].classList.add('active');
                document.getElementById('notesTab').classList.add('active');
            }
        }
        
        function displayTaggingPanel(sceneIndex) {
            const sceneNumber = sceneIndex + 1;
            const tags = sceneTags[sceneNumber] || [];
            const panel = document.getElementById('taggingPanel');
            const aiSuggestions = tags.filter(t => t.aiSuggested && !t.accepted);
            
            let html = '';
            
            if (aiSuggestions.length > 0) {
                html += `<div class="ai-banner">ü§ñ ${aiSuggestions.length} AI suggestions pending</div>`;
            }
            
            const sections = [
                { category: 'makeup', title: 'Makeup' },
                { category: 'hair', title: 'Hair' },
                { category: 'sfx', title: 'SFX' },
                { category: 'cast', title: 'Cast' },
                { category: 'wardrobe', title: 'Wardrobe' },
                { category: 'props', title: 'Props' }
            ];
            
            sections.forEach(section => {
                const sectionTags = tags.filter(t => t.category === section.category);
                const sectionAI = sectionTags.filter(t => t.aiSuggested && !t.accepted);
                const sectionConfirmed = sectionTags.filter(t => t.accepted || !t.aiSuggested);
                
                html += `<div class="tag-section"><div class="tag-section-title">${section.title}</div>`;
                
                if (sectionAI.length > 0) {
                    html += '<div class="tag-list">';
                    sectionAI.forEach((tag, i) => {
                        html += `<div class="tag-item ai-suggested"><div><span class="tag-badge">AI</span>${tag.description}</div><div class="tag-actions"><button class="tag-action-btn accept" onclick="acceptTag(${sceneNumber}, '${section.category}', ${i})">‚úì</button><button class="tag-action-btn reject" onclick="rejectTag(${sceneNumber}, '${section.category}', ${i})">‚úï</button></div></div>`;
                    });
                    html += '</div>';
                }
                
                if (sectionConfirmed.length > 0) {
                    html += '<div class="tag-list">';
                    sectionConfirmed.forEach((tag, i) => {
                        html += `<div class="tag-item"><div>${tag.description}</div><button class="tag-action-btn reject" onclick="removeTag(${sceneNumber}, '${section.category}', ${i})">‚úï</button></div>`;
                    });
                    html += '</div>';
                }
                
                html += `<button class="add-tag-btn" onclick="addManualTag('${section.category}')">+ Add ${section.title}</button></div>`;
            });
            
            panel.innerHTML = html;
        }
        
        async function runAIAnalysis() {
            if (!apiKey) {
                openSettings();
                alert('Please configure your API key in settings first');
                return;
            }
            
            if (scenes.length === 0) {
                alert('No scenes to analyze. Please load a script first.');
                return;
            }
            
            if (!confirm(`Run AI analysis on ${scenes.length} scenes? This may take a few minutes.`)) {
                return;
            }
            
            document.getElementById('loadingOverlay').classList.add('active');
            
            try {
                for (let i = 0; i < scenes.length; i++) {
                    document.getElementById('loadingText').textContent = `Analyzing scene ${i + 1} of ${scenes.length}...`;
                    await analyzeScene(i);
                    await new Promise(r => setTimeout(r, 500));
                }
                
                document.getElementById('loadingOverlay').classList.remove('active');
                displayTaggingPanel(currentScene - 1);
                alert('AI analysis complete!');
            } catch (error) {
                document.getElementById('loadingOverlay').classList.remove('active');
                console.error('Error during AI analysis:', error);
                alert('Error during AI analysis: ' + error.message);
            }
        }
        
        async function analyzeScene(sceneIndex) {
            const scene = scenes[sceneIndex];
            const sceneNumber = sceneIndex + 1;
            const lines = scriptText.split('\n');
            const startLine = scene.lineIndex;
            let endLine = lines.length;
            if (sceneIndex < scenes.length - 1) {
                endLine = scenes[sceneIndex + 1].lineIndex;
            }
            const sceneContent = lines.slice(startLine, endLine).join('\n');
            
            try {
                const suggestions = await callAIAPI(scene.heading, sceneContent);
                
                if (!sceneTags[sceneNumber]) {
                    sceneTags[sceneNumber] = [];
                }
                
                suggestions.forEach(s => {
                    sceneTags[sceneNumber].push({
                        category: s.category,
                        description: s.description,
                        aiSuggested: true,
                        accepted: false
                    });
                });
                
                saveProjectData();
            } catch (error) {
                console.error(`Error analyzing scene ${sceneNumber}:`, error);
                throw error;
            }
        }
        
        async function callAIAPI(sceneHeading, sceneContent) {
            const prompt = `Extract production elements from this scene. Return ONLY a JSON array.

Scene: ${sceneHeading}
Content: ${sceneContent.substring(0, 2000)}

Categories: makeup, hair, sfx, wardrobe, props, cast

Example: [{"category": "makeup", "description": "bruised cheek"},{"category": "hair", "description": "disheveled"}]`;

            try {
                if (aiProvider === 'openai') {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o-mini',
                            messages: [{role: 'user', content: prompt}],
                            temperature: 0.3
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const content = data.choices[0].message.content;
                    const match = content.match(/\[[\s\S]*\]/);
                    return JSON.parse(match ? match[0] : content);
                } else {
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: 'claude-3-5-sonnet-20241022',
                            max_tokens: 1024,
                            messages: [{role: 'user', content: prompt}]
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const content = data.content[0].text;
                    const match = content.match(/\[[\s\S]*\]/);
                    return JSON.parse(match ? match[0] : content);
                }
            } catch (error) {
                console.error('API call error:', error);
                throw error;
            }
        }
        
        function acceptTag(sceneNumber, category, tagIndex) {
            const tags = sceneTags[sceneNumber].filter(t => t.category === category && t.aiSuggested && !t.accepted);
            if (tags[tagIndex]) {
                tags[tagIndex].accepted = true;
                saveProjectData();
                displayTaggingPanel(currentScene - 1);
            }
        }
        
        function rejectTag(sceneNumber, category, tagIndex) {
            const aiTags = sceneTags[sceneNumber].filter(t => t.category === category && t.aiSuggested && !t.accepted);
            sceneTags[sceneNumber] = sceneTags[sceneNumber].filter(t => t !== aiTags[tagIndex]);
            saveProjectData();
            displayTaggingPanel(currentScene - 1);
        }
        
        function removeTag(sceneNumber, category, tagIndex) {
            const confirmedTags = sceneTags[sceneNumber].filter(t => t.category === category && (t.accepted || !t.aiSuggested));
            sceneTags[sceneNumber] = sceneTags[sceneNumber].filter(t => t !== confirmedTags[tagIndex]);
            saveProjectData();
            displayTaggingPanel(currentScene - 1);
        }
        
        function addManualTag(category) {
            const description = prompt(`Add ${category}:`);
            if (!description) return;
            
            if (!sceneTags[currentScene]) {
                sceneTags[currentScene] = [];
            }
            
            sceneTags[currentScene].push({
                category,
                description,
                aiSuggested: false,
                accepted: true
            });
            
            saveProjectData();
            displayTaggingPanel(currentScene - 1);
        }
        
        function handleTextSelection(e) {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (selectedText.length > 0 && e.target.closest('.script-content')) {
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                const toolbar = document.getElementById('tagToolbar');
                
                const viewerRect = document.querySelector('.script-viewer').getBoundingClientRect();
                toolbar.style.left = rect.left + (rect.width / 2) - 200 + 'px';
                toolbar.style.top = (rect.top - viewerRect.top - 50) + 'px';
                toolbar.classList.add('active');
                
                window.currentSelection = {text: selectedText, range};
            } else if (!e.target.closest('.tag-toolbar')) {
                document.getElementById('tagToolbar').classList.remove('active');
            }
        }
        
        function tagSelection(category) {
            if (!window.currentSelection) return;
            
            const {text, range} = window.currentSelection;
            const description = prompt(`Add ${category} tag:`, text);
            if (!description) return;
            
            const span = document.createElement('span');
            span.className = `tagged ${category}`;
            span.title = `${category}: ${description}`;
            
            try {
                range.surroundContents(span);
                document.getElementById('tagToolbar').classList.remove('active');
                window.getSelection().removeAllRanges();
            } catch (error) {
                alert('Cannot tag across element boundaries. Please select text within a single paragraph.');
            }
        }
        
        function saveNotes() {
            sceneNotes[currentScene] = document.getElementById('notesTextarea').value;
            saveProjectData();
            alert('Notes saved!');
        }
        
        function saveProjectData() {
            if (currentProject) {
                currentProject.sceneTags = sceneTags;
                currentProject.sceneNotes = sceneNotes;
                currentProject.scenes = scenes.length;
                localStorage.setItem('currentProject', JSON.stringify(currentProject));
                
                // Also update in projects list
                const projects = JSON.parse(localStorage.getItem('checksHappyProjects') || '[]');
                const projectIndex = projects.findIndex(p => p.title === currentProject.title);
                if (projectIndex !== -1) {
                    projects[projectIndex] = currentProject;
                    localStorage.setItem('checksHappyProjects', JSON.stringify(projects));
                }
            }
        }
        
        function openSettings() {
            document.getElementById('apiKey').value = apiKey;
            document.getElementById('aiProvider').value = aiProvider;
            document.getElementById('settingsModal').classList.add('active');
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }
        
        function saveSettings() {
            apiKey = document.getElementById('apiKey').value.trim();
            aiProvider = document.getElementById('aiProvider').value;
            localStorage.setItem('aiApiKey', apiKey);
            localStorage.setItem('aiProvider', aiProvider);
            closeSettings();
            alert('Settings saved!');
        }
        
        function goBack() {
            if (confirm('Return to dashboard? Any unsaved changes will be lost.')) {
                window.location.href = 'dashboard.html';
            }
        }
        
        // Close modal on outside click
        document.getElementById('settingsModal').addEventListener('click', function(e) {
            if (e.target === this) closeSettings();
        });
        
        // Initialize on page load
        init();
        
        console.log('‚úÖ Script Breakdown Ready');
    </script>
</body>
</html>
