<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget System Pro - Hair & Makeup</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #050403;
            --bg-darker: #020201;
            --bg-medium: rgba(18, 16, 14, 0.85);
            --card-bg: linear-gradient(135deg, rgba(36, 32, 25, 0.7), rgba(42, 38, 31, 0.6));
            --text-primary: #f0eeeb;
            --text-secondary: #9a8f83;
            --accent-gold: #d4af7a;
            --accent-gold-hover: #e0c08f;
            --border: rgba(255, 255, 255, 0.06);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-shine: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.02));
            --success: #52c186;
            --warning: #e8a87c;
            --danger: #ef4444;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(13, 11, 10, 0.4);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(138, 127, 115, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(138, 127, 115, 0.5);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: radial-gradient(ellipse at top, #0a0908 0%, #020201 40%, #000000 100%);
            color: var(--text-primary);
            min-height: 100vh;
            font-weight: 400;
            letter-spacing: -0.01em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 30%, rgba(212, 175, 122, 0.02) 0%, transparent 40%),
                        radial-gradient(circle at 80% 70%, rgba(212, 175, 122, 0.015) 0%, transparent 40%);
            pointer-events: none;
            z-index: 1;
        }

        /* Layout */
        .app-layout {
            display: flex;
            height: 100vh;
            position: relative;
            z-index: 2;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: linear-gradient(135deg, rgba(26, 22, 18, 0.8), rgba(20, 17, 15, 0.7));
            backdrop-filter: blur(40px) saturate(120%);
            -webkit-backdrop-filter: blur(40px) saturate(120%);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.05) 0%, transparent 100%);
            pointer-events: none;
        }

        .sidebar-header {
            padding: 32px 24px 24px;
            border-bottom: 1px solid var(--glass-border);
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 20px;
            transition: color 0.2s ease;
            opacity: 0.8;
        }

        .back-btn:hover {
            color: var(--text-primary);
            opacity: 1;
        }

        .project-info h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
            letter-spacing: -0.02em;
        }

        .project-code {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            opacity: 0.7;
        }

        .nav-section {
            padding: 20px 12px;
            border-bottom: 1px solid var(--glass-border);
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            margin-bottom: 8px;
            padding: 0 12px;
            opacity: 0.5;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            margin-bottom: 2px;
            font-size: 14px;
            color: var(--text-secondary);
            position: relative;
        }

        .nav-item:hover {
            background: linear-gradient(135deg, rgba(212, 175, 122, 0.08), rgba(212, 175, 122, 0.05));
            color: var(--text-primary);
            box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.05);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(212, 175, 122, 0.12), rgba(212, 175, 122, 0.08));
            color: var(--accent-gold);
            font-weight: 500;
            box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.1),
                        0 2px 8px rgba(212, 175, 122, 0.1);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 16px;
            background: var(--accent-gold);
            border-radius: 2px;
        }

        .nav-icon {
            width: 18px;
            height: 18px;
            opacity: 0.7;
        }

        .nav-item:hover .nav-icon {
            opacity: 1;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Top Bar */
        .top-bar {
            height: 56px;
            background: linear-gradient(135deg, rgba(26, 22, 18, 0.85), rgba(20, 17, 15, 0.75));
            backdrop-filter: blur(40px) saturate(120%);
            -webkit-backdrop-filter: blur(40px) saturate(120%);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            position: relative;
            z-index: 9;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
        }

        .top-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        }

        .page-title {
            font-size: 16px;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .top-bar-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.01));
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.05),
                        0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
            background: linear-gradient(135deg, rgba(212, 175, 122, 0.08), rgba(212, 175, 122, 0.04));
            box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.1),
                        0 4px 12px rgba(212, 175, 122, 0.15);
            transform: translateY(-1px);
        }

        .btn.primary {
            background: linear-gradient(135deg, rgba(212, 175, 122, 0.9), rgba(184, 150, 81, 0.9));
            border-color: var(--accent-gold);
            color: var(--bg-dark);
        }

        .btn.primary:hover {
            background: linear-gradient(135deg, #d4af7a, #c09861);
        }

        /* Content Area */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }

        /* Budget Overview Cards */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--card-bg);
            backdrop-filter: blur(30px) saturate(110%);
            -webkit-backdrop-filter: blur(30px) saturate(110%);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.2s ease;
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4),
                        inset 0 1px 1px rgba(255, 255, 255, 0.1);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.08) 0%, transparent 100%);
            pointer-events: none;
            border-radius: 12px 12px 0 0;
        }

        .stat-card:hover {
            border-color: rgba(212, 175, 122, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5),
                        inset 0 1px 2px rgba(255, 255, 255, 0.15);
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .stat-change {
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--danger);
        }

        /* Budget Section */
        .budget-section {
            background: var(--card-bg);
            backdrop-filter: blur(30px) saturate(110%);
            -webkit-backdrop-filter: blur(30px) saturate(110%);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 24px;
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4),
                        inset 0 1px 1px rgba(255, 255, 255, 0.1);
        }

        .budget-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.08) 0%, transparent 100%);
            pointer-events: none;
            border-radius: 12px 12px 0 0;
        }

        .budget-section-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(30, 26, 22, 0.5), rgba(26, 22, 18, 0.6));
            position: relative;
        }

        .budget-section-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        }

        .section-title {
            font-size: 1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .icon-btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        /* Category Table */
        .category-table {
            width: 100%;
            border-collapse: collapse;
        }

        .category-table thead {
            background: rgba(212, 175, 122, 0.05);
        }

        .category-table th {
            padding: 12px 24px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
        }

        .category-table th:last-child {
            text-align: right;
        }

        .category-table td {
            padding: 16px 24px;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
        }

        .category-table td:last-child {
            text-align: right;
            font-weight: 500;
        }

        .category-table tbody tr:hover {
            background: rgba(212, 175, 122, 0.03);
        }

        .category-table tbody tr:last-child td {
            border-bottom: none;
        }

        .item-name {
            color: var(--text-primary);
            font-weight: 500;
        }

        .item-desc {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-top: 2px;
        }

        .supplier-tag {
            display: inline-block;
            padding: 4px 8px;
            background: rgba(212, 175, 122, 0.1);
            border: 1px solid rgba(212, 175, 122, 0.2);
            border-radius: 4px;
            font-size: 11px;
            color: var(--accent-gold);
        }

        /* Input Fields */
        .input-row {
            display: grid;
            grid-template-columns: 2.5fr 80px 100px 100px 120px 200px 150px 40px;
            gap: 12px;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }

        .input-row:last-child {
            border-bottom: none;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            background: var(--bg-dark);
        }

        .form-input::placeholder {
            color: var(--text-secondary);
        }

        .calculated-value {
            color: var(--accent-gold);
            font-weight: 600;
            font-size: 14px;
            text-align: right;
        }

        .delete-btn {
            padding: 6px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .delete-btn:hover {
            border-color: var(--danger);
            color: var(--danger);
        }

        /* Category Total */
        .category-total {
            padding: 16px 24px;
            background: rgba(212, 175, 122, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .total-label {
            color: var(--text-secondary);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .total-value {
            color: var(--accent-gold);
            font-size: 18px;
        }

        /* Grand Total */
        .grand-total {
            background: var(--card-bg);
            backdrop-filter: blur(30px) saturate(110%);
            -webkit-backdrop-filter: blur(30px) saturate(110%);
            border: 2px solid var(--accent-gold);
            border-radius: 12px;
            padding: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            position: relative;
            box-shadow: 0 8px 32px rgba(212, 175, 122, 0.2),
                        inset 0 1px 2px rgba(255, 255, 255, 0.1);
        }

        .grand-total::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            pointer-events: none;
            border-radius: 10px 10px 0 0;
        }

        .grand-total-label {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .grand-total-value {
            font-size: 40px;
            font-weight: 700;
            color: var(--accent-gold);
        }

        /* Progress Bar */
        .progress-section {
            margin-bottom: 32px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .progress-value {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .progress-bar {
            height: 8px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.4));
            border-radius: 4px;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-gold), rgba(212, 175, 122, 0.8));
            border-radius: 4px;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(212, 175, 122, 0.3);
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, var(--warning), #f0b589);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, var(--danger), #f87171);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(26, 22, 18, 0.95), rgba(20, 17, 15, 0.9));
            backdrop-filter: blur(40px) saturate(120%);
            -webkit-backdrop-filter: blur(40px) saturate(120%);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6),
                        inset 0 1px 2px rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(30, 26, 22, 0.7), rgba(26, 22, 18, 0.8));
            position: relative;
        }

        .modal-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            padding: 8px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 24px;
            transition: color 0.2s ease;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-select {
            width: 100%;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
        }

        .modal-footer {
            padding: 24px;
            border-top: 1px solid var(--glass-border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Empty State */
        .empty-state {
            padding: 60px 24px;
            text-align: center;
            color: var(--text-secondary);
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-desc {
            font-size: 14px;
            margin-bottom: 24px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            color: var(--accent-gold);
            border-bottom-color: var(--accent-gold);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 80px;
            right: 32px;
            padding: 16px 24px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            z-index: 2000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
            backdrop-filter: blur(20px);
        }

        .notification.success {
            background: rgba(82, 193, 134, 0.9);
            border: 1px solid var(--success);
            color: white;
        }

        .notification.warning {
            background: rgba(232, 168, 124, 0.9);
            border: 1px solid var(--warning);
            color: var(--bg-dark);
        }

        .notification.danger {
            background: rgba(239, 68, 68, 0.9);
            border: 1px solid var(--danger);
            color: white;
        }

        .notification.info {
            background: rgba(212, 175, 122, 0.9);
            border: 1px solid var(--accent-gold);
            color: var(--bg-dark);
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }

        /* Over Budget Banner */
        .over-budget-banner {
            position: fixed;
            top: 0;
            left: 260px;
            right: 0;
            padding: 12px 32px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(200, 50, 50, 0.95));
            color: white;
            font-weight: 600;
            font-size: 14px;
            display: none;
            justify-content: center;
            align-items: center;
            gap: 16px;
            z-index: 1001;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
            animation: slideDown 0.3s ease;
        }

        .over-budget-banner button {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .over-budget-banner button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: white;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        /* Receipt Upload Zone */
        .receipt-upload-zone {
            border: 2px dashed var(--glass-border);
            border-radius: 12px;
            padding: 48px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(0, 0, 0, 0.2);
        }

        .receipt-upload-zone:hover,
        .receipt-upload-zone.dragover {
            border-color: var(--accent-gold);
            background: rgba(212, 175, 122, 0.05);
        }

        .receipt-upload-zone .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .receipt-upload-zone .upload-text {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .receipt-upload-zone .upload-subtext {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Receipts Grid */
        .receipts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            padding: 24px;
        }

        .receipt-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .receipt-card:hover {
            border-color: var(--accent-gold);
            transform: translateY(-2px);
        }

        .receipt-thumbnail {
            width: 100%;
            height: 140px;
            background: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .receipt-thumbnail img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .receipt-thumbnail .pdf-icon {
            font-size: 48px;
            color: var(--text-secondary);
        }

        .receipt-info {
            padding: 12px;
        }

        .receipt-supplier {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .receipt-amount {
            font-size: 14px;
            color: var(--accent-gold);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .receipt-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .receipt-status.unprocessed {
            background: rgba(232, 168, 124, 0.2);
            color: var(--warning);
        }

        .receipt-status.processed {
            background: rgba(82, 193, 134, 0.2);
            color: var(--success);
        }

        .receipt-status.flagged {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .receipt-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .receipt-actions button {
            flex: 1;
            padding: 6px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .receipt-actions button:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .receipt-actions button.primary {
            background: rgba(212, 175, 122, 0.2);
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .receipt-count {
            font-weight: 400;
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Receipt Link Button */
        .receipt-link-btn {
            padding: 4px 8px;
            background: rgba(212, 175, 122, 0.15);
            border: 1px solid rgba(212, 175, 122, 0.3);
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .receipt-link-btn:hover {
            background: rgba(212, 175, 122, 0.3);
            border-color: var(--accent-gold);
        }

        .receipt-link-btn.no-receipt {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--border);
            opacity: 0.6;
        }

        .receipt-link-btn.no-receipt:hover {
            opacity: 1;
            background: rgba(212, 175, 122, 0.1);
            border-color: var(--accent-gold);
        }

        /* Search & Filter Bar */
        .search-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .search-input {
            flex: 1;
            padding: 10px 16px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .filter-btn {
            padding: 10px 16px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        /* Variance Indicator */
        .variance {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .variance.positive {
            color: var(--success);
            background: rgba(82, 193, 134, 0.1);
        }

        .variance.negative {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .variance.neutral {
            color: var(--text-secondary);
            background: rgba(138, 127, 115, 0.1);
        }

        /* Supplier Management */
        .supplier-select {
            width: 100%;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
        }

        /* Notes Field */
        .notes-input {
            width: 100%;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 12px;
            resize: vertical;
            min-height: 32px;
        }

        /* Quick Actions Menu */
        .quick-actions {
            position: fixed;
            bottom: 32px;
            right: 32px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-gold), rgba(184, 150, 81, 0.9));
            border: none;
            color: var(--bg-dark);
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(212, 175, 122, 0.3);
            transition: all 0.2s ease;
        }

        .fab:hover {
            transform: scale(1.1);
            background: linear-gradient(135deg, #e0c08f, #c09861);
            box-shadow: 0 6px 16px rgba(212, 175, 122, 0.4);
        }

        .fab-menu {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 8px;
        }

        .fab-menu.active {
            display: flex;
        }

        .fab-item {
            padding: 8px 16px;
            background: var(--card-bg);
            backdrop-filter: blur(30px);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .fab-item:hover {
            background: rgba(212, 175, 122, 0.1);
            border-color: var(--accent-gold);
        }

        /* Comparison View */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
        }

        .comparison-table th {
            padding: 12px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            background: rgba(212, 175, 122, 0.05);
            border-bottom: 2px solid var(--border);
        }

        .comparison-table td {
            padding: 12px;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
        }

        /* Print Styles */
        @media print {
            .sidebar, .top-bar, .tabs, .btn, .icon-btn, .delete-btn, .fab {
                display: none !important;
            }
            
            .app-layout {
                display: block;
            }
            
            .main-content {
                width: 100%;
            }
            
            .content {
                padding: 20px;
            }
            
            body {
                background: white;
                color: black;
            }
            
            .budget-section, .stat-card {
                border: 1px solid #ddd;
                break-inside: avoid;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .input-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .overview-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading State */
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent-gold);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <a href="dashboard.html" class="back-btn">← Back to Dashboard</a>
                <div class="project-info">
                    <h2 id="project-name-display">The Big Race</h2>
                    <div class="project-code" id="project-code-display">HM-2025-001</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Budget Tools</div>
                <div class="nav-item active" data-tab="overview">
                    <span class="nav-icon">OVERVIEW</span>
                </div>
                <div class="nav-item" data-tab="proposal">
                    <span class="nav-icon">PROPOSAL</span>
                </div>
                <div class="nav-item" data-tab="receipts">
                    <span class="nav-icon">RECEIPTS</span>
                </div>
                <div class="nav-item" data-tab="tracking">
                    <span class="nav-icon">TRACKING</span>
                </div>
                <div class="nav-item" data-tab="comparison">
                    <span class="nav-icon">COMPARE</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Budget Summary</div>
                <div style="padding: 0 16px; font-size: 14px;">
                    <div style="margin-bottom: 12px;">
                        <div style="color: var(--text-secondary); margin-bottom: 4px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em;">Budget Total</div>
                        <div style="color: var(--accent-gold); font-weight: 600;" id="sidebar-budget-total">£0.00</div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <div style="color: var(--text-secondary); margin-bottom: 4px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em;">Spent</div>
                        <div style="color: var(--text-primary); font-weight: 600;" id="sidebar-spent">£0.00</div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <div style="color: var(--text-secondary); margin-bottom: 4px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em;">Remaining</div>
                        <div style="font-weight: 600;" id="sidebar-remaining">£0.00</div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span style="color: var(--text-secondary); font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em;">Budget Used</span>
                            <span style="color: var(--text-primary); font-size: 12px;" id="sidebar-percent">0%</span>
                        </div>
                        <div class="sidebar-progress-bar" style="height: 6px; background: rgba(0, 0, 0, 0.3); border-radius: 3px; overflow: hidden;">
                            <div id="sidebar-progress-fill" style="height: 100%; width: 0%; background: var(--success); border-radius: 3px; transition: width 0.3s ease, background 0.3s ease;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Quick Stats</div>
                <div style="padding: 0 16px; font-size: 14px;">
                    <div style="margin-bottom: 12px;">
                        <div style="color: var(--text-secondary); margin-bottom: 4px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em;">Total Budget</div>
                        <div style="color: var(--accent-gold); font-weight: 600;" id="sidebar-total">£0.00</div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <div style="color: var(--text-secondary); margin-bottom: 4px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em;">Items</div>
                        <div style="color: var(--text-primary); font-weight: 600;" id="sidebar-items">0</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); margin-bottom: 4px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em;">Last Saved</div>
                        <div style="color: var(--text-primary); font-size: 12px;" id="sidebar-saved">Never</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="page-title">Budget System Pro</div>
                <div class="top-bar-actions">
                    <button class="btn" onclick="importData()">Import CSV</button>
                    <button class="btn" onclick="exportBudget()">Export</button>
                    <button class="btn" onclick="openTemplateModal()">Templates</button>
                    <button class="btn primary" onclick="saveBudget()">Save</button>
                </div>
            </div>

            <!-- Content -->
            <div class="content">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" data-tab="overview">Overview</button>
                    <button class="tab" data-tab="proposal">Budget Proposal</button>
                    <button class="tab" data-tab="receipts">Receipts</button>
                    <button class="tab" data-tab="tracking">Spend Tracking</button>
                    <button class="tab" data-tab="comparison">Compare</button>
                </div>

                <!-- Overview Tab -->
                <div id="overview-tab" class="tab-content active">
                    <!-- Stats Grid -->
                    <div class="overview-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Budget</div>
                            <div class="stat-value" id="overview-total-budget">£0.00</div>
                            <div class="stat-change positive">
                                <span id="overview-budget-change">Ready to build</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-label">Spent To Date</div>
                            <div class="stat-value" id="overview-spent">£0.00</div>
                            <div class="stat-change positive">
                                <span id="overview-spent-percent">0%</span> of budget
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-label">Remaining</div>
                            <div class="stat-value" id="overview-remaining">£0.00</div>
                            <div class="stat-change positive">
                                <span id="overview-remaining-percent">100%</span> available
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-label">Cost Variance</div>
                            <div class="stat-value" id="overview-variance">£0.00</div>
                            <div class="stat-change" id="overview-variance-status">
                                <span>On budget</span>
                            </div>
                        </div>
                    </div>

                    <!-- Budget Progress -->
                    <div class="progress-section">
                        <div class="progress-header">
                            <span class="progress-label">Budget Utilization</span>
                            <span class="progress-value" id="progress-percent">0% Used</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Category Breakdown -->
                    <div class="budget-section">
                        <div class="budget-section-header">
                            <div class="section-title">Category Breakdown</div>
                            <div class="section-actions">
                                <button class="icon-btn" onclick="refreshOverview()">Refresh</button>
                            </div>
                        </div>
                        <table class="category-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Budgeted</th>
                                    <th>Spent</th>
                                    <th>Remaining</th>
                                    <th>Variance</th>
                                </tr>
                            </thead>
                            <tbody id="overview-categories">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Budget Proposal Tab -->
                <div id="proposal-tab" class="tab-content">
                    <!-- Search Bar -->
                    <div class="search-bar">
                        <input type="text" class="search-input" placeholder="Search items..." id="search-items">
                        <button class="filter-btn" onclick="clearSearch()">Clear Search</button>
                    </div>

                    <!-- Project Info -->
                    <div class="budget-section" style="margin-bottom: 24px;">
                        <div class="budget-section-header">
                            <div class="section-title">Project Information</div>
                        </div>
                        <div style="padding: 24px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div class="form-group">
                                    <label class="form-label">Production Name</label>
                                    <input type="text" class="form-input" id="project-name" value="The Big Race" placeholder="Enter production name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Project Code</label>
                                    <input type="text" class="form-input" id="project-code" value="HM-2025-001" placeholder="e.g., HM-2025-001">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Makeup Designer</label>
                                    <input type="text" class="form-input" id="designer-name" placeholder="Enter designer name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Project Type</label>
                                    <select class="form-select" id="project-type">
                                        <option>Feature Film</option>
                                        <option>TV Series</option>
                                        <option>Commercial</option>
                                        <option>Short Film</option>
                                        <option>Documentary</option>
                                        <option>Music Video</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Duration</label>
                                    <input type="text" class="form-input" id="project-duration" value="4 weeks" placeholder="e.g., 4 weeks">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Budget Limit</label>
                                    <input type="number" class="form-input" id="budget-limit" placeholder="Maximum budget (£)" step="100">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic Category Sections -->
                    <div id="category-sections">
                        <!-- Categories will be generated here -->
                    </div>

                    <!-- Grand Total -->
                    <div class="grand-total">
                        <div class="grand-total-label">TOTAL ESTIMATED BUDGET</div>
                        <div class="grand-total-value" id="grand-total">£0.00</div>
                    </div>
                </div>

                <!-- Receipts Tab -->
                <div id="receipts-tab" class="tab-content">
                    <!-- Upload Zone -->
                    <div class="budget-section" style="margin-bottom: 24px;">
                        <div class="budget-section-header">
                            <div class="section-title">Upload Receipts</div>
                            <div class="section-actions">
                                <button class="icon-btn" onclick="openSettingsModal()">API Settings</button>
                            </div>
                        </div>
                        <div style="padding: 24px;">
                            <div class="receipt-upload-zone" id="receipt-upload-zone" onclick="triggerReceiptUpload()">
                                <div class="upload-icon">📄</div>
                                <div class="upload-text">Drag & drop receipts here or click to browse</div>
                                <div class="upload-subtext">JPG, PNG, HEIC recommended for auto-scan (PDF requires manual entry)</div>
                                <input type="file" id="receipt-file-input" accept=".jpg,.jpeg,.png,.heic,.pdf,image/jpeg,image/png,image/heic,application/pdf" multiple style="display: none;" onchange="handleReceiptFiles(this.files)">
                            </div>
                            <div id="api-key-status" style="margin-top: 12px; padding: 12px; border-radius: 6px; font-size: 13px; display: none;">
                                <!-- Dynamic API key status message -->
                            </div>
                        </div>
                    </div>

                    <!-- Unprocessed Receipts -->
                    <div class="budget-section" style="margin-bottom: 24px;">
                        <div class="budget-section-header">
                            <div class="section-title">
                                Unprocessed Receipts
                                <span class="receipt-count" id="unprocessed-count">(0)</span>
                            </div>
                            <div class="section-actions">
                                <button class="icon-btn" onclick="processAllReceipts()">Process All</button>
                            </div>
                        </div>
                        <div class="receipts-grid" id="unprocessed-receipts-grid">
                            <div class="empty-state">
                                <div class="empty-title">No unprocessed receipts</div>
                                <div class="empty-desc">Upload receipts above to get started</div>
                            </div>
                        </div>
                    </div>

                    <!-- Processed Receipts -->
                    <div class="budget-section">
                        <div class="budget-section-header">
                            <div class="section-title">
                                Processed Receipts
                                <span class="receipt-count" id="processed-count">(0)</span>
                            </div>
                            <div class="section-actions">
                                <button class="icon-btn" onclick="toggleProcessedReceipts()">View All</button>
                            </div>
                        </div>
                        <div class="receipts-grid" id="processed-receipts-grid" style="display: none;">
                            <div class="empty-state">
                                <div class="empty-title">No processed receipts</div>
                                <div class="empty-desc">Process unprocessed receipts to see them here</div>
                            </div>
                        </div>
                        <div id="processed-receipts-summary" style="padding: 24px; text-align: center; color: var(--text-secondary);">
                            Click "View All" to see processed receipts
                        </div>
                    </div>
                </div>

                <!-- Spend Tracking Tab -->
                <div id="tracking-tab" class="tab-content">
                    <!-- Search Bar -->
                    <div class="search-bar">
                        <input type="text" class="search-input" placeholder="Search expenses..." id="search-expenses">
                        <input type="date" class="form-input" id="expense-date-filter" style="width: 200px;">
                        <button class="filter-btn" onclick="filterExpenses()">Filter by Date</button>
                        <button class="filter-btn" onclick="clearExpenseFilter()">Clear Filter</button>
                    </div>

                    <div class="budget-section">
                        <div class="budget-section-header">
                            <div class="section-title">Expense Tracking</div>
                            <div class="section-actions">
                                <button class="icon-btn" onclick="openExpenseModal()">+ Add Expense</button>
                            </div>
                        </div>
                        <table class="category-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Item</th>
                                    <th>Category</th>
                                    <th>Supplier</th>
                                    <th>Receipt</th>
                                    <th>Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="expense-list">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                        <div class="category-total">
                            <span class="total-label">Total Expenses</span>
                            <span class="total-value" id="total-expenses">£0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Budget vs Actual Comparison Tab -->
                <div id="comparison-tab" class="tab-content">
                    <div class="budget-section">
                        <div class="budget-section-header">
                            <div class="section-title">Budget vs Actual Comparison</div>
                            <div class="section-actions">
                                <button class="icon-btn" onclick="exportComparison()">Export Report</button>
                            </div>
                        </div>
                        <table class="comparison-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Budgeted</th>
                                    <th>Actual Spent</th>
                                    <th>Variance (£)</th>
                                    <th>Variance (%)</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="comparison-table-body">
                                <!-- Dynamic content -->
                            </tbody>
                            <tfoot style="background: rgba(212, 175, 122, 0.05); font-weight: 600;">
                                <tr>
                                    <td style="padding: 16px 12px;">TOTAL</td>
                                    <td id="comp-total-budget">£0.00</td>
                                    <td id="comp-total-actual">£0.00</td>
                                    <td id="comp-total-variance">£0.00</td>
                                    <td id="comp-total-variance-percent">0%</td>
                                    <td id="comp-total-status">-</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Variance Analysis -->
                    <div class="budget-section">
                        <div class="budget-section-header">
                            <div class="section-title">Variance Analysis</div>
                        </div>
                        <div style="padding: 24px;">
                            <div id="variance-analysis">
                                <!-- Dynamic analysis content -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Import Budget Data</div>
                <button class="modal-close" onclick="closeModal('importModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Import Instructions</label>
                    <div style="background: rgba(212, 175, 122, 0.1); padding: 16px; border-radius: 6px; margin-bottom: 16px;">
                        <div style="font-size: 14px; line-height: 1.6;">
                            <strong>Supported File Formats:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px;">
                                <li><strong>JSON (.json)</strong> - Complete budget backup files exported from this system</li>
                                <li><strong>CSV (.csv)</strong> - Budget items or expense lists in CSV format</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">CSV Format Requirements</label>
                    <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">
                        <strong>For Budget Items CSV:</strong>
                        <div style="font-family: monospace; background: var(--bg-dark); padding: 8px; border-radius: 4px; margin: 8px 0;">
                            Category,Item Description,Quantity,Unit Price,Markup %,Total,Supplier,Notes
                        </div>
                        
                        <strong>For Expenses CSV:</strong>
                        <div style="font-family: monospace; background: var(--bg-dark); padding: 8px; border-radius: 4px; margin: 8px 0;">
                            Date,Item,Category,Supplier,Receipt #,Amount,Notes
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Important</label>
                    <div style="background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: 6px; font-size: 13px; color: var(--text-secondary);">
                        Importing will ask if you want to merge with or replace your current data. Make sure to save your current budget before importing if you want to keep it!
                    </div>
                </div>

                <div class="form-group" style="margin-top: 24px;">
                    <button class="btn primary" onclick="triggerFileImport()" style="width: 100%; justify-content: center;">
                        Select File to Import
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('importModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Export Budget</div>
                <button class="modal-close" onclick="closeModal('exportModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Export Format</label>
                    <select class="form-select" id="export-format">
                        <option value="json">JSON (Complete backup - recommended)</option>
                        <option value="csv-budget">CSV - Budget Items Only</option>
                        <option value="csv-expenses">CSV - Expenses Only</option>
                        <option value="csv-full">CSV - Full Report (Budget + Expenses)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.5;" id="export-description">
                        Export your complete budget data including project info, budget items, and expenses. This format is recommended for backups and can be re-imported later.
                    </p>
                </div>
                <div class="form-group">
                    <label class="form-label">File Preview</label>
                    <div style="background: var(--bg-dark); padding: 12px; border-radius: 6px; font-family: monospace; font-size: 12px; color: var(--text-secondary);">
                        <span id="export-filename">budget_HM-2025-001_2025-01-15.json</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('exportModal')">Cancel</button>
                <button class="btn primary" onclick="performExport()">Download Export</button>
            </div>
        </div>
    </div>

    <!-- Template Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Load Budget Template</div>
                <button class="modal-close" onclick="closeModal('templateModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select Template</label>
                    <select class="form-select" id="template-select">
                        <option value="feature">Basic Feature Film (4 weeks)</option>
                        <option value="tv">TV Series Episode Budget</option>
                        <option value="commercial">Commercial Shoot (1-3 days)</option>
                        <option value="period">Period Drama Budget</option>
                        <option value="horror">Horror/SFX Heavy Budget</option>
                        <option value="indie">Low Budget Indie Film</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.5;" id="template-description">
                        Standard feature film budget template for a 4-week shoot. Includes basic disposables, hygiene supplies, and common beauty products. Customize as needed for your specific production requirements.
                    </p>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="merge-template" style="margin-right: 8px;"> Merge with existing budget (don't replace)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('templateModal')">Cancel</button>
                <button class="btn primary" onclick="loadTemplate()">Load Template</button>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add Expense</div>
                <button class="modal-close" onclick="closeModal('expenseModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" id="expense-date" value="">
                </div>
                <div class="form-group">
                    <label class="form-label">Item Description</label>
                    <input type="text" class="form-input" id="expense-item" placeholder="Enter item description">
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="expense-category">
                        <option value="disposables">Disposables</option>
                        <option value="hygiene">Hygiene</option>
                        <option value="makeup">Makeup</option>
                        <option value="hair">Hair</option>
                        <option value="prosthetics">Prosthetics</option>
                        <option value="mouldmaking">Mould Making</option>
                        <option value="sfxmakeup">SFX Makeup</option>
                        <option value="accessories">Accessories</option>
                        <option value="actoressentials">Actor Essentials</option>
                        <option value="departmentsupplies">Department Supplies</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Supplier</label>
                    <input type="text" class="form-input" id="expense-supplier" placeholder="Enter supplier name" list="supplier-list">
                    <datalist id="supplier-list">
                        <option value="Amazon">
                        <option value="Boots">
                        <option value="MAC">
                        <option value="Superdrug">
                        <option value="Sally's">
                        <option value="Charles Fox">
                        <option value="Screenface">
                        <option value="Kryolan">
                        <option value="Pharmacy">
                    </datalist>
                </div>
                <div class="form-group">
                    <label class="form-label">Amount (£)</label>
                    <input type="number" class="form-input" id="expense-amount" placeholder="0.00" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label">Receipt Number</label>
                    <input type="text" class="form-input" id="expense-receipt" placeholder="Optional receipt/invoice number">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="notes-input" id="expense-notes" placeholder="Additional notes..." rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('expenseModal')">Cancel</button>
                <button class="btn primary" onclick="saveExpense()">Add Expense</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">API Settings</div>
                <button class="modal-close" onclick="closeModal('settingsModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Claude API Key</label>
                    <input type="password" class="form-input" id="claude-api-key" placeholder="sk-ant-...">
                    <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
                        Your API key is stored locally in your browser's localStorage. Never share your API key.
                    </div>
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label class="form-label">Note</label>
                    <div style="background: rgba(232, 168, 124, 0.1); padding: 12px; border-radius: 6px; font-size: 13px; color: var(--text-secondary);">
                        The Claude API is used for OCR receipt extraction. In production, API calls should be made through a secure server. This local storage approach is for personal use only.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('settingsModal')">Cancel</button>
                <button class="btn primary" onclick="saveApiSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Receipt Processing Modal -->
    <div id="receiptProcessingModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; width: 95%; max-height: 90vh;">
            <div class="modal-header">
                <div class="modal-title">Process Receipt</div>
                <button class="modal-close" onclick="closeReceiptProcessingModal()">×</button>
            </div>
            <div class="modal-body" style="display: flex; gap: 24px; padding: 0; max-height: calc(90vh - 140px); position: relative;">
                <!-- Left: Receipt Viewer -->
                <div class="receipt-viewer" style="flex: 1; min-width: 0; background: var(--bg-dark); display: flex; flex-direction: column;">
                    <div class="viewer-controls" style="padding: 12px; border-bottom: 1px solid var(--border); display: flex; gap: 8px;">
                        <button class="icon-btn" onclick="rotateReceiptImage(-90)">↺ Rotate Left</button>
                        <button class="icon-btn" onclick="rotateReceiptImage(90)">↻ Rotate Right</button>
                        <button class="icon-btn" onclick="zoomReceiptImage(1.2)">+ Zoom In</button>
                        <button class="icon-btn" onclick="zoomReceiptImage(0.8)">- Zoom Out</button>
                        <button class="icon-btn" onclick="resetReceiptImage()">Reset</button>
                    </div>
                    <div id="receipt-image-container" style="flex: 1; overflow: auto; padding: 16px; display: flex; align-items: center; justify-content: center;">
                        <img id="receipt-image-preview" src="" alt="Receipt" style="max-width: 100%; transition: transform 0.2s ease;">
                    </div>
                </div>

                <!-- OCR Loading Overlay -->
                <div id="ocr-loading-overlay" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 100; justify-content: center; align-items: center; flex-direction: column; gap: 16px;">
                    <div class="loading-spinner" style="width: 48px; height: 48px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <div style="color: var(--text-primary); font-size: 16px; font-weight: 500;">Processing receipt with AI...</div>
                    <div style="color: var(--text-secondary); font-size: 14px;">This may take a few seconds</div>
                </div>

                <!-- Right: Extracted Data Form -->
                <div class="receipt-form" style="width: 400px; overflow-y: auto; padding: 24px; border-left: 1px solid var(--border);">
                    <div class="form-group">
                        <label class="form-label">Supplier</label>
                        <input type="text" class="form-input" id="receipt-supplier">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="receipt-date">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Invoice/Receipt Number</label>
                        <input type="text" class="form-input" id="receipt-invoice-number">
                    </div>

                    <div class="form-group" style="margin-top: 24px;">
                        <label class="form-label" style="display: flex; justify-content: space-between; align-items: center;">
                            Line Items
                            <button class="icon-btn" onclick="addReceiptLineItem()">+ Add Item</button>
                        </label>
                        <div id="receipt-line-items" style="max-height: 300px; overflow-y: auto;">
                            <!-- Dynamic line items -->
                        </div>
                    </div>

                    <div style="margin-top: 24px; padding: 16px; background: rgba(0, 0, 0, 0.3); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--text-secondary);">Receipt Total (OCR):</span>
                            <span id="receipt-ocr-total" style="color: var(--text-primary); font-weight: 600;">£0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--text-secondary);">Items Total:</span>
                            <span id="receipt-items-total" style="color: var(--text-primary); font-weight: 600;">£0.00</span>
                        </div>
                        <div id="receipt-total-match" style="display: flex; align-items: center; gap: 8px; padding-top: 8px; border-top: 1px solid var(--border);">
                            <span style="font-size: 18px;">✓</span>
                            <span style="color: var(--success);">Totals match</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeReceiptProcessingModal()">Cancel</button>
                <button class="btn" onclick="flagReceipt()">Flag for Review</button>
                <button class="btn primary" onclick="approveReceipt()">Save & Approve</button>
            </div>
        </div>
    </div>

    <!-- Receipt View Modal (for viewing processed receipts) -->
    <div id="receiptViewModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">View Receipt</div>
                <button class="modal-close" onclick="closeModal('receiptViewModal')">×</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <div id="receipt-view-image" style="max-height: 60vh; overflow: auto; margin-bottom: 16px;">
                    <img src="" alt="Receipt" style="max-width: 100%;">
                </div>
                <div id="receipt-view-metadata" style="text-align: left; padding: 16px; background: rgba(0, 0, 0, 0.3); border-radius: 8px;">
                    <!-- Receipt metadata -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('receiptViewModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Quick Actions FAB -->
    <div class="quick-actions">
        <div class="fab-menu" id="fab-menu">
            <div class="fab-item" onclick="quickAddItem()">Quick Add Item</div>
            <div class="fab-item" onclick="quickAddExpense()">Quick Expense</div>
            <div class="fab-item" onclick="duplicateLastItem()">Duplicate Last</div>
            <div class="fab-item" onclick="clearAll()">Clear All</div>
        </div>
        <button class="fab" onclick="toggleFab()">+</button>
    </div>

    <script>
        // Enhanced Budget Management System
        class BudgetManager {
            constructor() {
                this.data = {
                    projectInfo: {
                        name: 'The Big Race',
                        code: 'HM-2025-001',
                        designer: '',
                        type: 'Feature Film',
                        duration: '4 weeks',
                        budgetLimit: 0
                    },
                    categories: {
                        disposables: { name: 'Disposables', items: [] },
                        hygiene: { name: 'Hygiene', items: [] },
                        makeup: { name: 'Makeup', items: [] },
                        hair: { name: 'Hair', items: [] },
                        prosthetics: { name: 'Prosthetics', items: [] },
                        mouldmaking: { name: 'Mould Making', items: [] },
                        sfxmakeup: { name: 'SFX Makeup', items: [] },
                        accessories: { name: 'Accessories', items: [] },
                        actoressentials: { name: 'Actor Essentials', items: [] },
                        departmentsupplies: { name: 'Department Supplies', items: [] }
                    },
                    expenses: [],
                    receipts: [],
                    apiSettings: {
                        claudeApiKey: ''
                    },
                    lastSaved: null
                };

                // Track which budget alerts have been triggered this session
                this.triggeredAlerts = {
                    threshold75: false,
                    threshold90: false,
                    threshold100: false
                };

                this.init();
            }

            init() {
                this.loadFromStorage();
                this.setupEventListeners();
                this.renderCategories();
                this.updateAllCalculations();
                this.setTodayDate();
            }

            setupEventListeners() {
                // Project info changes
                ['project-name', 'project-code', 'designer-name', 'project-type', 'project-duration', 'budget-limit'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('change', () => this.saveProjectInfo());
                    }
                });

                // Tab navigation
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const tabName = e.target.dataset.tab;
                        this.switchTab(tabName);
                    });
                });

                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const tabName = e.currentTarget.dataset.tab;
                        this.switchTab(tabName);
                    });
                });

                // Search functionality
                const searchItems = document.getElementById('search-items');
                if (searchItems) {
                    searchItems.addEventListener('input', (e) => this.searchItems(e.target.value));
                }

                const searchExpenses = document.getElementById('search-expenses');
                if (searchExpenses) {
                    searchExpenses.addEventListener('input', (e) => this.searchExpenses(e.target.value));
                }

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case 's':
                                e.preventDefault();
                                this.save();
                                break;
                        }
                    }
                });

                // Auto-save every 30 seconds
                setInterval(() => this.autoSave(), 30000);

                // Click outside modal to close
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.remove('active');
                        }
                    });
                });
            }

            switchTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.tab').forEach(tab => {
                    if (tab.dataset.tab === tabName) {
                        tab.classList.add('active');
                    } else {
                        tab.classList.remove('active');
                    }
                });

                // Update nav items
                document.querySelectorAll('.nav-item').forEach(item => {
                    if (item.dataset.tab === tabName) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });

                // Update tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                const targetTab = document.getElementById(`${tabName}-tab`);
                if (targetTab) {
                    targetTab.classList.add('active');
                }

                // Update calculations when switching tabs
                this.updateAllCalculations();

                // Update API key status when switching to receipts tab
                if (tabName === 'receipts') {
                    updateApiKeyStatus();
                }
            }

            renderCategories() {
                const container = document.getElementById('category-sections');
                if (!container) return;

                container.innerHTML = '';
                
                Object.keys(this.data.categories).forEach(key => {
                    const category = this.data.categories[key];
                    const section = this.createCategorySection(key, category);
                    container.appendChild(section);
                });
            }

            createCategorySection(key, category) {
                const section = document.createElement('div');
                section.className = 'budget-section';
                section.innerHTML = `
                    <div class="budget-section-header">
                        <div class="section-title">${category.name}</div>
                        <div class="section-actions">
                            <button class="icon-btn" data-action="add" data-category="${key}">+ Add Item</button>
                            <button class="icon-btn" data-action="clear" data-category="${key}">Clear</button>
                        </div>
                    </div>
                    <div id="${key}-items">
                        ${category.items.length === 0 ? this.getEmptyState(category) : ''}
                    </div>
                    <div class="category-total">
                        <span class="total-label">Category Total</span>
                        <span class="total-value" id="${key}-total">£0.00</span>
                    </div>
                `;

                // Add event listeners to buttons
                section.querySelector('[data-action="add"]').addEventListener('click', () => this.addItem(key));
                section.querySelector('[data-action="clear"]').addEventListener('click', () => this.clearCategory(key));

                // Render existing items
                if (category.items.length > 0) {
                    const itemsContainer = section.querySelector(`#${key}-items`);
                    category.items.forEach((item, index) => {
                        itemsContainer.appendChild(this.createItemRow(key, item, index));
                    });
                }

                return section;
            }

            createItemRow(categoryKey, item = {}, index) {
                const row = document.createElement('div');
                row.className = 'input-row';
                row.dataset.category = categoryKey;
                row.dataset.index = index;
                
                row.innerHTML = `
                    <input type="text" class="form-input item-description" 
                           placeholder="Item description" 
                           value="${item.description || ''}"
                           data-field="description">
                    <input type="number" class="form-input item-qty" 
                           placeholder="Qty" 
                           value="${item.qty || 1}" 
                           min="0"
                           data-field="qty">
                    <input type="number" class="form-input item-price" 
                           placeholder="Unit Price" 
                           value="${item.price || 0}" 
                           step="0.01" 
                           min="0"
                           data-field="price">
                    <input type="number" class="form-input item-markup" 
                           placeholder="Markup %" 
                           value="${item.markup || 0}" 
                           step="1" 
                           min="0"
                           data-field="markup">
                    <div class="calculated-value">${this.formatCurrency(this.calculateItemTotal(item))}</div>
                    <select class="supplier-select" data-field="supplier">
                        <option value="">Select Supplier</option>
                        <option value="Amazon" ${item.supplier === 'Amazon' ? 'selected' : ''}>Amazon</option>
                        <option value="Boots" ${item.supplier === 'Boots' ? 'selected' : ''}>Boots</option>
                        <option value="MAC" ${item.supplier === 'MAC' ? 'selected' : ''}>MAC</option>
                        <option value="Superdrug" ${item.supplier === 'Superdrug' ? 'selected' : ''}>Superdrug</option>
                        <option value="Sally's" ${item.supplier === "Sally's" ? 'selected' : ''}>Sally's</option>
                        <option value="Charles Fox" ${item.supplier === 'Charles Fox' ? 'selected' : ''}>Charles Fox</option>
                        <option value="Other" ${item.supplier === 'Other' ? 'selected' : ''}>Other</option>
                    </select>
                    <input type="text" class="notes-input" 
                           placeholder="Notes..." 
                           value="${item.notes || ''}"
                           data-field="notes">
                    <button class="delete-btn" data-action="delete">×</button>
                `;

                // Add event listeners to all inputs
                row.querySelectorAll('input, select').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const field = e.target.dataset.field;
                        if (field) {
                            this.updateItem(categoryKey, index, field, e.target.value);
                        }
                    });
                });

                // Delete button
                row.querySelector('[data-action="delete"]').addEventListener('click', () => {
                    this.removeItem(categoryKey, index);
                });

                return row;
            }

            getEmptyState(category) {
                return `
                    <div class="empty-state">
                        <div class="empty-title">No items added yet</div>
                        <div class="empty-desc">Click "Add Item" to start building your budget</div>
                    </div>
                `;
            }

            addItem(categoryKey) {
                const category = this.data.categories[categoryKey];
                if (!category) return;

                const newItem = {
                    description: '',
                    qty: 1,
                    price: 0,
                    markup: 0,
                    supplier: '',
                    notes: '',
                    id: Date.now()
                };

                category.items.push(newItem);

                // Remove empty state if exists
                const container = document.getElementById(`${categoryKey}-items`);
                const emptyState = container.querySelector('.empty-state');
                if (emptyState) emptyState.remove();

                // Add new row
                const newRow = this.createItemRow(categoryKey, newItem, category.items.length - 1);
                container.appendChild(newRow);

                // Focus on description
                setTimeout(() => {
                    newRow.querySelector('.item-description').focus();
                }, 100);

                this.updateCategoryTotal(categoryKey);
                this.updateGrandTotal();
            }

            updateItem(categoryKey, index, field, value) {
                const category = this.data.categories[categoryKey];
                if (!category || !category.items[index]) return;

                // Convert values to appropriate types
                if (field === 'qty' || field === 'price' || field === 'markup') {
                    value = parseFloat(value) || 0;
                }

                category.items[index][field] = value;

                // Update row total
                const row = document.querySelector(`[data-category="${categoryKey}"][data-index="${index}"]`);
                if (row) {
                    const totalEl = row.querySelector('.calculated-value');
                    if (totalEl) {
                        totalEl.textContent = this.formatCurrency(this.calculateItemTotal(category.items[index]));
                    }
                }

                this.updateCategoryTotal(categoryKey);
                this.updateGrandTotal();
                
                // Debounced save
                clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(() => this.save(), 1000);
            }

            removeItem(categoryKey, index) {
                const category = this.data.categories[categoryKey];
                if (!category || !category.items[index]) return;

                if (confirm('Are you sure you want to remove this item?')) {
                    category.items.splice(index, 1);
                    this.renderCategories();
                    this.updateAllCalculations();
                    this.save();
                }
            }

            clearCategory(categoryKey) {
                if (confirm(`Clear all items in ${this.data.categories[categoryKey].name}?`)) {
                    this.data.categories[categoryKey].items = [];
                    this.renderCategories();
                    this.updateAllCalculations();
                    this.save();
                }
            }

            calculateItemTotal(item) {
                if (!item) return 0;
                const baseTotal = (item.qty || 0) * (item.price || 0);
                const markupAmount = baseTotal * ((item.markup || 0) / 100);
                return baseTotal + markupAmount;
            }

            updateCategoryTotal(categoryKey) {
                const category = this.data.categories[categoryKey];
                if (!category) return 0;

                const total = category.items.reduce((sum, item) => sum + this.calculateItemTotal(item), 0);
                
                const totalEl = document.getElementById(`${categoryKey}-total`);
                if (totalEl) {
                    totalEl.textContent = this.formatCurrency(total);
                }

                return total;
            }

            updateGrandTotal() {
                let grandTotal = 0;
                Object.keys(this.data.categories).forEach(key => {
                    grandTotal += this.updateCategoryTotal(key);
                });

                const grandTotalEl = document.getElementById('grand-total');
                if (grandTotalEl) {
                    grandTotalEl.textContent = this.formatCurrency(grandTotal);
                }
                
                const sidebarTotal = document.getElementById('sidebar-total');
                if (sidebarTotal) {
                    sidebarTotal.textContent = this.formatCurrency(grandTotal);
                }
                
                return grandTotal;
            }

            updateAllCalculations() {
                const grandTotal = this.updateGrandTotal();
                const totalExpenses = this.calculateTotalExpenses();
                const remaining = grandTotal - totalExpenses;

                // Update overview
                this.updateOverview(grandTotal, totalExpenses, remaining);

                // Update comparison
                this.updateComparison();

                // Update sidebar budget summary
                this.updateSidebarBudgetSummary(grandTotal, totalExpenses, remaining);

                // Update item count
                let itemCount = 0;
                Object.values(this.data.categories).forEach(cat => {
                    itemCount += cat.items.length;
                });
                const itemsEl = document.getElementById('sidebar-items');
                if (itemsEl) {
                    itemsEl.textContent = itemCount;
                }
            }

            updateSidebarBudgetSummary(budget, spent, remaining) {
                // Update sidebar values
                this.setElementText('sidebar-budget-total', this.formatCurrency(budget));
                this.setElementText('sidebar-spent', this.formatCurrency(spent));

                // Update remaining with color
                const remainingEl = document.getElementById('sidebar-remaining');
                if (remainingEl) {
                    remainingEl.textContent = this.formatCurrency(remaining);
                    if (remaining < 0) {
                        remainingEl.style.color = 'var(--danger)';
                        remainingEl.textContent = '-' + this.formatCurrency(Math.abs(remaining));
                    } else {
                        remainingEl.style.color = 'var(--success)';
                    }
                }

                // Calculate and update percentage
                const percent = budget > 0 ? (spent / budget * 100) : 0;
                this.setElementText('sidebar-percent', percent.toFixed(1) + '%');

                // Update progress bar
                const progressFill = document.getElementById('sidebar-progress-fill');
                if (progressFill) {
                    progressFill.style.width = Math.min(percent, 100) + '%';

                    // Update color based on percentage
                    if (percent >= 100) {
                        progressFill.style.background = 'var(--danger)';
                    } else if (percent >= 75) {
                        progressFill.style.background = 'var(--warning)';
                    } else {
                        progressFill.style.background = 'var(--success)';
                    }
                }

                // Check and trigger budget alerts
                this.checkBudgetAlerts(budget, spent, percent);
            }

            checkBudgetAlerts(budget, spent, percent) {
                // Don't check if budget is 0
                if (budget <= 0) return;

                const overBudgetAmount = spent - budget;

                // Handle over budget state
                if (percent >= 100) {
                    this.showOverBudgetBanner(overBudgetAmount);

                    if (!this.triggeredAlerts.threshold100) {
                        this.showNotification("You've reached your budget limit", 'danger');
                        this.triggeredAlerts.threshold100 = true;
                    }
                } else {
                    this.hideOverBudgetBanner();

                    // Check 90% threshold
                    if (percent >= 90 && !this.triggeredAlerts.threshold90) {
                        this.showNotification('Warning - only 10% of budget remaining', 'warning');
                        this.triggeredAlerts.threshold90 = true;
                    }
                    // Check 75% threshold
                    else if (percent >= 75 && !this.triggeredAlerts.threshold75) {
                        this.showNotification("Heads up - you've used 75% of your budget", 'info');
                        this.triggeredAlerts.threshold75 = true;
                    }
                }
            }

            showOverBudgetBanner(amount) {
                let banner = document.getElementById('over-budget-banner');
                if (!banner) {
                    banner = document.createElement('div');
                    banner.id = 'over-budget-banner';
                    banner.className = 'over-budget-banner';
                    document.body.appendChild(banner);
                }
                banner.innerHTML = `<span>You're ${this.formatCurrency(amount)} over budget</span><button onclick="budgetManager.hideOverBudgetBanner()">×</button>`;
                banner.style.display = 'flex';
            }

            hideOverBudgetBanner() {
                const banner = document.getElementById('over-budget-banner');
                if (banner) {
                    banner.style.display = 'none';
                }
            }

            updateOverview(budget, spent, remaining) {
                // Update values
                this.setElementText('overview-total-budget', this.formatCurrency(budget));
                this.setElementText('overview-spent', this.formatCurrency(spent));
                this.setElementText('overview-remaining', this.formatCurrency(remaining));
                
                const spentPercent = budget > 0 ? (spent / budget * 100).toFixed(1) : 0;
                const remainingPercent = budget > 0 ? (remaining / budget * 100).toFixed(1) : 100;
                
                this.setElementText('overview-spent-percent', spentPercent + '%');
                this.setElementText('overview-remaining-percent', remainingPercent + '%');
                
                // Update progress bar
                this.setElementText('progress-percent', spentPercent + '% Used');
                const progressBar = document.getElementById('progress-bar');
                if (progressBar) {
                    progressBar.style.width = spentPercent + '%';
                    
                    // Update progress bar color
                    progressBar.classList.remove('warning', 'danger');
                    if (spentPercent > 90) {
                        progressBar.classList.add('danger');
                    } else if (spentPercent > 75) {
                        progressBar.classList.add('warning');
                    }
                }

                // Update variance
                const variance = spent - budget;
                this.setElementText('overview-variance', this.formatCurrency(Math.abs(variance)));
                
                const varianceStatus = document.getElementById('overview-variance-status');
                if (varianceStatus) {
                    if (variance > 0) {
                        varianceStatus.innerHTML = '<span style="color: var(--danger)">Over budget</span>';
                        varianceStatus.className = 'stat-change negative';
                    } else if (variance < 0) {
                        varianceStatus.innerHTML = '<span style="color: var(--success)">Under budget</span>';
                        varianceStatus.className = 'stat-change positive';
                    } else {
                        varianceStatus.innerHTML = '<span>On budget</span>';
                        varianceStatus.className = 'stat-change';
                    }
                }

                // Update category breakdown
                this.updateCategoryBreakdown();
            }

            updateCategoryBreakdown() {
                const tbody = document.getElementById('overview-categories');
                if (!tbody) return;

                tbody.innerHTML = '';
                
                Object.keys(this.data.categories).forEach(key => {
                    const category = this.data.categories[key];
                    const budgeted = category.items.reduce((sum, item) => sum + this.calculateItemTotal(item), 0);
                    const spent = this.getCategoryExpenses(key);
                    const remaining = budgeted - spent;
                    const variance = spent - budgeted;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span>${category.name}</span>
                            </div>
                        </td>
                        <td>${this.formatCurrency(budgeted)}</td>
                        <td>${this.formatCurrency(spent)}</td>
                        <td>${this.formatCurrency(remaining)}</td>
                        <td>
                            ${this.getVarianceBadge(variance)}
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }

            getCategoryExpenses(categoryKey) {
                return this.data.expenses
                    .filter(exp => exp.category === categoryKey)
                    .reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
            }

            getVarianceBadge(variance) {
                if (variance > 0) {
                    return `<span class="variance negative">+${this.formatCurrency(variance)}</span>`;
                } else if (variance < 0) {
                    return `<span class="variance positive">${this.formatCurrency(variance)}</span>`;
                } else {
                    return `<span class="variance neutral">£0.00</span>`;
                }
            }

            updateComparison() {
                const tbody = document.getElementById('comparison-table-body');
                if (!tbody) return;

                tbody.innerHTML = '';
                let totalBudget = 0;
                let totalActual = 0;
                
                Object.keys(this.data.categories).forEach(key => {
                    const category = this.data.categories[key];
                    const budgeted = category.items.reduce((sum, item) => sum + this.calculateItemTotal(item), 0);
                    const actual = this.getCategoryExpenses(key);
                    const variance = actual - budgeted;
                    const variancePercent = budgeted > 0 ? (variance / budgeted * 100) : 0;
                    
                    totalBudget += budgeted;
                    totalActual += actual;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span>${category.name}</span>
                            </div>
                        </td>
                        <td>${this.formatCurrency(budgeted)}</td>
                        <td>${this.formatCurrency(actual)}</td>
                        <td>${this.formatCurrency(variance)}</td>
                        <td>${variancePercent.toFixed(1)}%</td>
                        <td>${this.getStatusBadge(variance, budgeted)}</td>
                    `;
                    
                    tbody.appendChild(row);
                });

                // Update totals
                const totalVariance = totalActual - totalBudget;
                const totalVariancePercent = totalBudget > 0 ? (totalVariance / totalBudget * 100) : 0;
                
                this.setElementText('comp-total-budget', this.formatCurrency(totalBudget));
                this.setElementText('comp-total-actual', this.formatCurrency(totalActual));
                this.setElementText('comp-total-variance', this.formatCurrency(totalVariance));
                this.setElementText('comp-total-variance-percent', totalVariancePercent.toFixed(1) + '%');
                
                const statusEl = document.getElementById('comp-total-status');
                if (statusEl) {
                    statusEl.innerHTML = this.getStatusBadge(totalVariance, totalBudget);
                }

                // Update variance analysis
                this.updateVarianceAnalysis(totalBudget, totalActual, totalVariance);
            }

            updateVarianceAnalysis(budget, actual, variance) {
                const container = document.getElementById('variance-analysis');
                if (!container) return;

                const percentSpent = budget > 0 ? (actual / budget * 100).toFixed(1) : 0;
                const status = variance > 0 ? 'over budget' : variance < 0 ? 'under budget' : 'on budget';
                
                container.innerHTML = `
                    <div style="display: grid; gap: 16px;">
                        <div>
                            <strong>Summary:</strong> The project is currently ${status} by ${this.formatCurrency(Math.abs(variance))} 
                            (${Math.abs((variance / budget * 100).toFixed(1))}%).
                        </div>
                        <div>
                            <strong>Budget Utilization:</strong> ${percentSpent}% of the total budget has been spent.
                        </div>
                        <div>
                            <strong>Top Variance Categories:</strong>
                            <ul style="margin-top: 8px; padding-left: 20px;">
                                ${this.getTopVariances()}
                            </ul>
                        </div>
                        <div>
                            <strong>Recommendations:</strong>
                            <ul style="margin-top: 8px; padding-left: 20px;">
                                ${this.getRecommendations(variance, budget)}
                            </ul>
                        </div>
                    </div>
                `;
            }

            getTopVariances() {
                const variances = [];
                Object.keys(this.data.categories).forEach(key => {
                    const category = this.data.categories[key];
                    const budgeted = category.items.reduce((sum, item) => sum + this.calculateItemTotal(item), 0);
                    const actual = this.getCategoryExpenses(key);
                    const variance = actual - budgeted;
                    
                    if (Math.abs(variance) > 0) {
                        variances.push({ name: category.name, variance, budgeted });
                    }
                });

                variances.sort((a, b) => Math.abs(b.variance) - Math.abs(a.variance));
                
                if (variances.length === 0) {
                    return '<li>No variances to report</li>';
                }

                return variances.slice(0, 3)
                    .map(v => `<li>${v.name}: ${v.variance > 0 ? 'Over' : 'Under'} by ${this.formatCurrency(Math.abs(v.variance))}</li>`)
                    .join('');
            }

            getRecommendations(variance, budget) {
                const recommendations = [];
                
                if (variance > budget * 0.1) {
                    recommendations.push('Review and reduce non-essential expenses immediately');
                    recommendations.push('Consider renegotiating supplier contracts');
                } else if (variance > 0) {
                    recommendations.push('Monitor spending closely to prevent further overruns');
                    recommendations.push('Identify areas for cost optimization');
                } else if (variance < -budget * 0.2) {
                    recommendations.push('Consider reallocating unused budget to quality improvements');
                    recommendations.push('Review if all necessary items have been accounted for');
                } else {
                    recommendations.push('Continue current spending patterns');
                    recommendations.push('Maintain regular budget reviews');
                }
                
                return recommendations.map(r => `<li>${r}</li>`).join('');
            }

            getStatusBadge(variance, budget) {
                const percent = budget > 0 ? Math.abs(variance / budget * 100) : 0;
                
                if (variance > budget * 0.1) {
                    return '<span class="variance negative">Over</span>';
                } else if (variance > 0) {
                    return '<span class="variance warning">Slightly Over</span>';
                } else if (variance < -budget * 0.2) {
                    return '<span class="variance positive">Under</span>';
                } else {
                    return '<span class="variance neutral">On Track</span>';
                }
            }

            saveProjectInfo() {
                this.data.projectInfo.name = document.getElementById('project-name').value;
                this.data.projectInfo.code = document.getElementById('project-code').value;
                this.data.projectInfo.designer = document.getElementById('designer-name').value;
                this.data.projectInfo.type = document.getElementById('project-type').value;
                this.data.projectInfo.duration = document.getElementById('project-duration').value;
                this.data.projectInfo.budgetLimit = parseFloat(document.getElementById('budget-limit').value) || 0;

                // Update display
                this.setElementText('project-name-display', this.data.projectInfo.name);
                this.setElementText('project-code-display', this.data.projectInfo.code);

                this.save();
            }

            addExpense(expense) {
                expense.id = Date.now();
                expense.date = expense.date || new Date().toISOString().split('T')[0];
                this.data.expenses.push(expense);
                this.renderExpenses();
                this.updateAllCalculations();
                this.save();
            }

            renderExpenses() {
                const tbody = document.getElementById('expense-list');
                if (!tbody) return;

                tbody.innerHTML = '';

                if (this.data.expenses.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary); padding: 40px;">No expenses recorded yet. Click "Add Expense" to start tracking.</td></tr>';
                    this.setElementText('total-expenses', '£0.00');
                    return;
                }

                const sortedExpenses = [...this.data.expenses].sort((a, b) =>
                    new Date(b.date) - new Date(a.date)
                );

                sortedExpenses.forEach(expense => {
                    const row = document.createElement('tr');

                    // Check if expense has a linked receipt
                    const hasReceipt = expense.receipt_id && this.data.receipts?.find(r => r.id === expense.receipt_id);
                    const receiptIcon = hasReceipt
                        ? `<button class="receipt-link-btn" onclick="viewReceipt(${expense.receipt_id})" title="View linked receipt">📎</button>`
                        : `<button class="receipt-link-btn no-receipt" onclick="attachReceiptToExpense(${expense.id})" title="Attach receipt">+📎</button>`;

                    row.innerHTML = `
                        <td>${expense.date}</td>
                        <td>
                            <div class="item-name">${expense.item}</div>
                            ${expense.notes ? `<div class="item-desc">${expense.notes}</div>` : ''}
                        </td>
                        <td>${this.data.categories[expense.category]?.name || expense.category}</td>
                        <td><span class="supplier-tag">${expense.supplier || '-'}</span></td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span>${expense.receipt || '-'}</span>
                                ${receiptIcon}
                            </div>
                        </td>
                        <td>${this.formatCurrency(expense.amount)}</td>
                        <td>
                            <button class="delete-btn" data-expense-id="${expense.id}">×</button>
                        </td>
                    `;

                    // Add delete listener
                    row.querySelector('.delete-btn').addEventListener('click', () => {
                        this.deleteExpense(expense.id);
                    });

                    tbody.appendChild(row);
                });

                this.setElementText('total-expenses', this.formatCurrency(this.calculateTotalExpenses()));
            }

            deleteExpense(id) {
                if (confirm('Delete this expense?')) {
                    this.data.expenses = this.data.expenses.filter(e => e.id !== id);
                    this.renderExpenses();
                    this.updateAllCalculations();
                    this.save();
                }
            }

            calculateTotalExpenses() {
                return this.data.expenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
            }

            searchItems(query) {
                const lowerQuery = query.toLowerCase();
                
                document.querySelectorAll('.input-row').forEach(row => {
                    const description = row.querySelector('.item-description')?.value.toLowerCase() || '';
                    const notes = row.querySelector('.notes-input')?.value.toLowerCase() || '';
                    
                    if (!query || description.includes(lowerQuery) || notes.includes(lowerQuery)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            searchExpenses(query) {
                const lowerQuery = query.toLowerCase();
                
                document.querySelectorAll('#expense-list tr').forEach(row => {
                    const text = row.textContent.toLowerCase();
                    if (!query || text.includes(lowerQuery)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            formatCurrency(amount) {
                return '£' + (parseFloat(amount) || 0).toFixed(2);
            }

            setElementText(id, text) {
                const el = document.getElementById(id);
                if (el) el.textContent = text;
            }

            save() {
                this.data.lastSaved = new Date().toISOString();
                localStorage.setItem('hmBudgetPro', JSON.stringify(this.data));
                
                // Update last saved display
                const now = new Date();
                this.setElementText('sidebar-saved', `${now.toLocaleTimeString()}`);
                
                this.showNotification('Budget saved', 'success');
            }

            autoSave() {
                if (this.hasChanges()) {
                    this.data.lastSaved = new Date().toISOString();
                    localStorage.setItem('hmBudgetPro', JSON.stringify(this.data));
                    
                    // Silent auto-save, no notification
                    const now = new Date();
                    this.setElementText('sidebar-saved', `${now.toLocaleTimeString()}`);
                }
            }

            hasChanges() {
                const current = JSON.stringify(this.data);
                const saved = localStorage.getItem('hmBudgetPro');
                return current !== saved;
            }

            loadFromStorage() {
                const saved = localStorage.getItem('hmBudgetPro');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);

                        // Deep merge categories (keep new structure, import items from old)
                        if (data.categories) {
                            // Migrate old category data to new structure
                            const categoryMapping = {
                                'consumables': 'makeup',
                                'beauty': 'makeup',
                                'sfx': 'sfxmakeup',
                                'tools': 'departmentsupplies',
                                'custom': 'prosthetics'
                            };

                            Object.keys(data.categories).forEach(key => {
                                // Direct match for categories that exist in both old and new
                                if (this.data.categories[key]) {
                                    this.data.categories[key].items = data.categories[key].items || [];
                                }
                                // Map old categories to new ones
                                else if (categoryMapping[key] && this.data.categories[categoryMapping[key]]) {
                                    const targetKey = categoryMapping[key];
                                    const existingItems = this.data.categories[targetKey].items || [];
                                    const migratedItems = data.categories[key].items || [];
                                    this.data.categories[targetKey].items = [...existingItems, ...migratedItems];
                                }
                            });
                        }

                        // Merge other data
                        this.data.projectInfo = { ...this.data.projectInfo, ...data.projectInfo };
                        this.data.expenses = data.expenses || [];
                        this.data.receipts = data.receipts || [];
                        this.data.apiSettings = data.apiSettings || { claudeApiKey: '' };
                        this.data.lastSaved = data.lastSaved;

                        // Ensure all expenses have receipt_id field (migration)
                        this.data.expenses.forEach(expense => {
                            if (!expense.hasOwnProperty('receipt_id')) {
                                expense.receipt_id = null;
                            }
                        });

                        // Restore project info to form
                        if (this.data.projectInfo) {
                            document.getElementById('project-name').value = this.data.projectInfo.name || '';
                            document.getElementById('project-code').value = this.data.projectInfo.code || '';
                            document.getElementById('designer-name').value = this.data.projectInfo.designer || '';
                            document.getElementById('project-type').value = this.data.projectInfo.type || '';
                            document.getElementById('project-duration').value = this.data.projectInfo.duration || '';
                            document.getElementById('budget-limit').value = this.data.projectInfo.budgetLimit || '';

                            this.setElementText('project-name-display', this.data.projectInfo.name);
                            this.setElementText('project-code-display', this.data.projectInfo.code);
                        }

                        // Update last saved
                        if (this.data.lastSaved) {
                            const savedDate = new Date(this.data.lastSaved);
                            this.setElementText('sidebar-saved', savedDate.toLocaleTimeString());
                        }

                        this.renderExpenses();
                    } catch (e) {
                        console.error('Error loading data:', e);
                        this.showNotification('Error loading saved data', 'danger');
                    }
                }
            }

            exportData(format = 'json', includeExpenses = true) {
                const data = {
                    projectInfo: this.data.projectInfo,
                    categories: this.data.categories,
                    expenses: includeExpenses ? this.data.expenses : [],
                    exported: new Date().toISOString(),
                    exportFormat: format
                };

                if (format === 'json') {
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    this.downloadFile(blob, `budget_${this.data.projectInfo.code}_${this.getDateStamp()}.json`);
                } else if (format === 'csv-budget') {
                    const csv = this.convertBudgetToCSV(data);
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    this.downloadFile(blob, `budget_items_${this.data.projectInfo.code}_${this.getDateStamp()}.csv`);
                } else if (format === 'csv-expenses') {
                    const csv = this.convertExpensesToCSV(data);
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    this.downloadFile(blob, `expenses_${this.data.projectInfo.code}_${this.getDateStamp()}.csv`);
                } else if (format === 'csv-full') {
                    const csvBudget = this.convertBudgetToCSV(data);
                    const csvExpenses = this.convertExpensesToCSV(data);
                    const csv = `Budget Items:\n${csvBudget}\n\n\nExpenses:\n${csvExpenses}`;
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    this.downloadFile(blob, `full_report_${this.data.projectInfo.code}_${this.getDateStamp()}.csv`);
                }

                this.showNotification('Budget exported successfully', 'success');
            }

            convertBudgetToCSV(data) {
                let csv = 'Category,Item Description,Quantity,Unit Price (£),Markup %,Total (£),Supplier,Notes\n';
                
                Object.keys(data.categories).forEach(key => {
                    const category = data.categories[key];
                    category.items.forEach(item => {
                        const total = this.calculateItemTotal(item);
                        csv += `"${category.name}","${this.escapeCSV(item.description)}",${item.qty},${item.price},${item.markup},${total.toFixed(2)},"${this.escapeCSV(item.supplier)}","${this.escapeCSV(item.notes)}"\n`;
                    });
                });

                // Add totals row
                let grandTotal = 0;
                Object.values(data.categories).forEach(cat => {
                    grandTotal += cat.items.reduce((sum, item) => sum + this.calculateItemTotal(item), 0);
                });
                csv += `\n"TOTAL","","","","",${grandTotal.toFixed(2)},"",""\n`;

                return csv;
            }

            convertExpensesToCSV(data) {
                if (!data.expenses || data.expenses.length === 0) {
                    return 'No expenses recorded\n';
                }

                let csv = 'Date,Item,Category,Supplier,Receipt #,Amount (£),Notes\n';
                
                data.expenses.forEach(expense => {
                    const category = data.categories[expense.category]?.name || expense.category;
                    csv += `${expense.date},"${this.escapeCSV(expense.item)}","${category}","${this.escapeCSV(expense.supplier)}","${this.escapeCSV(expense.receipt)}",${parseFloat(expense.amount).toFixed(2)},"${this.escapeCSV(expense.notes)}"\n`;
                });

                // Add totals row
                const totalExpenses = data.expenses.reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
                csv += `\n"TOTAL","","","","",${totalExpenses.toFixed(2)},""\n`;

                return csv;
            }

            escapeCSV(value) {
                if (!value) return '';
                // Escape quotes and wrap in quotes if contains comma, quote, or newline
                const stringValue = String(value).replace(/"/g, '""');
                return stringValue;
            }

            getDateStamp() {
                const now = new Date();
                return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            }

            importFromFile(file) {
                const fileName = file.name.toLowerCase();
                const reader = new FileReader();

                reader.onload = (event) => {
                    try {
                        if (fileName.endsWith('.json')) {
                            this.importJSON(event.target.result);
                        } else if (fileName.endsWith('.csv')) {
                            this.importCSV(event.target.result);
                        } else {
                            this.showNotification('Unsupported file format. Use JSON or CSV.', 'danger');
                        }
                    } catch (e) {
                        console.error('Import error:', e);
                        this.showNotification('Error importing file: ' + e.message, 'danger');
                    }
                };

                reader.onerror = () => {
                    this.showNotification('Error reading file', 'danger');
                };

                reader.readAsText(file);
            }

            importJSON(content) {
                try {
                    const data = JSON.parse(content);
                    
                    // Validate data structure
                    if (!data.categories && !data.projectInfo) {
                        throw new Error('Invalid budget file format');
                    }

                    if (confirm('This will replace your current budget. Continue?')) {
                        // Merge imported data with existing structure
                        if (data.projectInfo) {
                            this.data.projectInfo = { ...this.data.projectInfo, ...data.projectInfo };
                        }
                        
                        if (data.categories) {
                            // Only import categories that exist in our structure
                            Object.keys(this.data.categories).forEach(key => {
                                if (data.categories[key]) {
                                    this.data.categories[key].items = data.categories[key].items || [];
                                }
                            });
                        }
                        
                        if (data.expenses) {
                            this.data.expenses = data.expenses;
                        }

                        // Update UI
                        this.loadProjectInfo();
                        this.renderCategories();
                        this.renderExpenses();
                        this.updateAllCalculations();
                        this.save();
                        
                        this.showNotification('Budget imported successfully', 'success');
                    }
                } catch (e) {
                    throw new Error('Invalid JSON format: ' + e.message);
                }
            }

            importCSV(content) {
                try {
                    const lines = content.split('\n').map(line => line.trim()).filter(line => line);
                    
                    if (lines.length < 2) {
                        throw new Error('CSV file is empty or invalid');
                    }

                    // Check if this is a budget items CSV or expenses CSV
                    const header = lines[0].toLowerCase();
                    
                    if (header.includes('item description') || header.includes('markup')) {
                        this.importBudgetItemsCSV(lines);
                    } else if (header.includes('receipt')) {
                        this.importExpensesCSV(lines);
                    } else {
                        throw new Error('Unrecognized CSV format. Please use exported CSV format.');
                    }
                    
                } catch (e) {
                    throw new Error('CSV import error: ' + e.message);
                }
            }

            importBudgetItemsCSV(lines) {
                const merge = confirm('Merge with existing budget items?\n\nClick OK to merge, Cancel to replace.');
                
                if (!merge) {
                    // Clear existing items
                    Object.keys(this.data.categories).forEach(key => {
                        this.data.categories[key].items = [];
                    });
                }

                let importedCount = 0;
                
                // Parse CSV (skip header)
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i];
                    if (!line || line.toLowerCase().includes('total')) continue;
                    
                    const values = this.parseCSVLine(line);
                    if (values.length < 5) continue;

                    const [categoryName, description, qty, price, markup, , supplier, notes] = values;
                    
                    // Find matching category
                    const categoryKey = this.findCategoryKey(categoryName);
                    if (!categoryKey) continue;

                    const item = {
                        description: description || '',
                        qty: parseFloat(qty) || 1,
                        price: parseFloat(price) || 0,
                        markup: parseFloat(markup) || 0,
                        supplier: supplier || '',
                        notes: notes || '',
                        id: Date.now() + Math.random()
                    };

                    this.data.categories[categoryKey].items.push(item);
                    importedCount++;
                }

                if (importedCount > 0) {
                    this.renderCategories();
                    this.updateAllCalculations();
                    this.save();
                    this.showNotification(`Imported ${importedCount} budget items`, 'success');
                } else {
                    this.showNotification('No valid items found in CSV', 'warning');
                }
            }

            importExpensesCSV(lines) {
                const merge = confirm('Merge with existing expenses?\n\nClick OK to merge, Cancel to replace.');
                
                if (!merge) {
                    this.data.expenses = [];
                }

                let importedCount = 0;
                
                // Parse CSV (skip header)
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i];
                    if (!line || line.toLowerCase().includes('total')) continue;
                    
                    const values = this.parseCSVLine(line);
                    if (values.length < 5) continue;

                    const [date, item, categoryName, supplier, receipt, amount, notes] = values;
                    
                    // Find matching category
                    const categoryKey = this.findCategoryKey(categoryName);
                    if (!categoryKey) continue;

                    const expense = {
                        date: date || new Date().toISOString().split('T')[0],
                        item: item || '',
                        category: categoryKey,
                        supplier: supplier || '',
                        receipt: receipt || '',
                        amount: parseFloat(amount) || 0,
                        notes: notes || '',
                        id: Date.now() + Math.random()
                    };

                    this.data.expenses.push(expense);
                    importedCount++;
                }

                if (importedCount > 0) {
                    this.renderExpenses();
                    this.updateAllCalculations();
                    this.save();
                    this.showNotification(`Imported ${importedCount} expenses`, 'success');
                } else {
                    this.showNotification('No valid expenses found in CSV', 'warning');
                }
            }

            parseCSVLine(line) {
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];
                    
                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            current += '"';
                            i++; // Skip next quote
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                values.push(current.trim());
                return values;
            }

            findCategoryKey(categoryName) {
                const lowerName = categoryName.toLowerCase();
                for (const [key, category] of Object.entries(this.data.categories)) {
                    if (category.name.toLowerCase() === lowerName) {
                        return key;
                    }
                }
                return null;
            }

            loadProjectInfo() {
                if (this.data.projectInfo) {
                    document.getElementById('project-name').value = this.data.projectInfo.name || '';
                    document.getElementById('project-code').value = this.data.projectInfo.code || '';
                    document.getElementById('designer-name').value = this.data.projectInfo.designer || '';
                    document.getElementById('project-type').value = this.data.projectInfo.type || '';
                    document.getElementById('project-duration').value = this.data.projectInfo.duration || '';
                    document.getElementById('budget-limit').value = this.data.projectInfo.budgetLimit || '';
                    
                    this.setElementText('project-name-display', this.data.projectInfo.name);
                    this.setElementText('project-code-display', this.data.projectInfo.code);
                }
            }

            downloadFile(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            showNotification(message, type = 'info') {
                // Remove existing notifications
                document.querySelectorAll('.notification').forEach(n => n.remove());

                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            setTodayDate() {
                const today = new Date().toISOString().split('T')[0];
                const expenseDateInput = document.getElementById('expense-date');
                if (expenseDateInput) {
                    expenseDateInput.value = today;
                }
            }
        }

        // Initialize Budget Manager
        let budgetManager;
        
        document.addEventListener('DOMContentLoaded', () => {
            budgetManager = new BudgetManager();
        });

        // Global functions
        function saveBudget() {
            budgetManager.save();
        }

        function exportBudget() {
            openExportModal();
        }

        function importData() {
            openImportModal();
        }

        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
        }

        function triggerFileImport() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.csv';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    closeModal('importModal');
                    budgetManager.importFromFile(file);
                }
            };
            input.click();
        }

        function openExportModal() {
            document.getElementById('exportModal').classList.add('active');
            updateExportPreview();
            
            // Add change listener to format selector
            document.getElementById('export-format').addEventListener('change', updateExportPreview);
        }

        function updateExportPreview() {
            const format = document.getElementById('export-format').value;
            const code = budgetManager.data.projectInfo.code;
            const dateStamp = budgetManager.getDateStamp();
            
            const descriptions = {
                'json': 'Export your complete budget data including project info, budget items, and expenses. This format is recommended for backups and can be re-imported later.',
                'csv-budget': 'Export only the budget items with categories, quantities, prices, and totals. Great for sharing with accountants or importing into spreadsheet software.',
                'csv-expenses': 'Export only the expense tracking data with dates, categories, and amounts. Useful for expense reports and reimbursement tracking.',
                'csv-full': 'Export a comprehensive report with both budget items and expenses in a single CSV file. Perfect for complete financial documentation.'
            };
            
            const filenames = {
                'json': `budget_${code}_${dateStamp}.json`,
                'csv-budget': `budget_items_${code}_${dateStamp}.csv`,
                'csv-expenses': `expenses_${code}_${dateStamp}.csv`,
                'csv-full': `full_report_${code}_${dateStamp}.csv`
            };
            
            document.getElementById('export-description').textContent = descriptions[format];
            document.getElementById('export-filename').textContent = filenames[format];
        }

        function performExport() {
            const format = document.getElementById('export-format').value;
            budgetManager.exportData(format);
            closeModal('exportModal');
        }

        function openTemplateModal() {
            document.getElementById('templateModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function loadTemplate() {
            const templateType = document.getElementById('template-select').value;
            const merge = document.getElementById('merge-template').checked;

            const templates = {
                feature: {
                    disposables: [
                        { description: 'Mascara Wands (Pack of 100)', qty: 3, price: 8.00, markup: 0, supplier: 'Amazon', notes: '' },
                        { description: 'Cotton Pads (Pack of 200)', qty: 4, price: 4.50, markup: 0, supplier: 'Boots', notes: '' },
                        { description: 'Cotton Buds (Pack of 200)', qty: 3, price: 3.00, markup: 0, supplier: 'Boots', notes: '' },
                        { description: 'Tissues (Box)', qty: 5, price: 2.50, markup: 0, supplier: 'Superdrug', notes: '' }
                    ],
                    hygiene: [
                        { description: 'Isopropyl Alcohol 99% (1L)', qty: 3, price: 12.00, markup: 0, supplier: 'Pharmacy', notes: '' },
                        { description: 'Brush Cleaner (250ml)', qty: 2, price: 15.00, markup: 0, supplier: 'MAC', notes: '' }
                    ],
                    makeup: [
                        { description: 'Foundation Set (Various Shades)', qty: 1, price: 250.00, markup: 0, supplier: 'MAC', notes: '' },
                        { description: 'Concealer Palette', qty: 2, price: 45.00, markup: 0, supplier: 'Charles Fox', notes: '' },
                        { description: 'Powder Set', qty: 1, price: 85.00, markup: 0, supplier: 'Kryolan', notes: '' }
                    ]
                },
                horror: {
                    sfxmakeup: [
                        { description: 'Liquid Latex (1L)', qty: 3, price: 25.00, markup: 0, supplier: 'Screenface', notes: '' },
                        { description: 'Scar Wax', qty: 5, price: 12.00, markup: 0, supplier: 'Kryolan', notes: '' },
                        { description: 'Stage Blood (1L)', qty: 2, price: 18.00, markup: 0, supplier: 'Charles Fox', notes: '' },
                        { description: 'Gelatin (1kg)', qty: 2, price: 35.00, markup: 0, supplier: 'Screenface', notes: '' }
                    ]
                },
                tv: {
                    disposables: [
                        { description: 'Mascara Wands (Pack of 100)', qty: 2, price: 8.00, markup: 0, supplier: 'Amazon', notes: '' },
                        { description: 'Cotton Pads (Pack of 200)', qty: 2, price: 4.50, markup: 0, supplier: 'Boots', notes: '' }
                    ],
                    makeup: [
                        { description: 'Foundation Set', qty: 1, price: 150.00, markup: 0, supplier: 'MAC', notes: '' }
                    ]
                },
                commercial: {
                    makeup: [
                        { description: 'HD Foundation', qty: 1, price: 120.00, markup: 0, supplier: 'MAC', notes: '' },
                        { description: 'Setting Spray', qty: 2, price: 25.00, markup: 0, supplier: 'MAC', notes: '' }
                    ]
                },
                period: {
                    hair: [
                        { description: 'Period Wigs', qty: 3, price: 200.00, markup: 0, supplier: 'Other', notes: '' },
                        { description: 'Hair Pieces', qty: 5, price: 80.00, markup: 0, supplier: 'Other', notes: '' }
                    ],
                    prosthetics: [
                        { description: 'Custom Prosthetics', qty: 1, price: 500.00, markup: 0, supplier: 'Other', notes: '' }
                    ]
                },
                indie: {
                    makeup: [
                        { description: 'Basic Makeup Kit', qty: 1, price: 100.00, markup: 0, supplier: 'Amazon', notes: '' }
                    ]
                }
            };

            const selectedTemplate = templates[templateType] || templates.feature;

            if (!merge) {
                // Clear existing items
                Object.keys(budgetManager.data.categories).forEach(key => {
                    budgetManager.data.categories[key].items = [];
                });
            }

            // Add template items
            Object.keys(selectedTemplate).forEach(categoryKey => {
                if (budgetManager.data.categories[categoryKey]) {
                    selectedTemplate[categoryKey].forEach(item => {
                        budgetManager.data.categories[categoryKey].items.push({
                            ...item,
                            id: Date.now() + Math.random()
                        });
                    });
                }
            });

            budgetManager.renderCategories();
            budgetManager.updateAllCalculations();
            budgetManager.save();
            closeModal('templateModal');
            budgetManager.showNotification('Template loaded successfully', 'success');
        }

        function openExpenseModal() {
            budgetManager.setTodayDate();
            document.getElementById('expenseModal').classList.add('active');
        }

        function saveExpense() {
            const expense = {
                date: document.getElementById('expense-date').value,
                item: document.getElementById('expense-item').value,
                category: document.getElementById('expense-category').value,
                supplier: document.getElementById('expense-supplier').value,
                amount: parseFloat(document.getElementById('expense-amount').value) || 0,
                receipt: document.getElementById('expense-receipt').value,
                notes: document.getElementById('expense-notes').value
            };

            if (!expense.item || !expense.amount) {
                budgetManager.showNotification('Please fill in required fields', 'warning');
                return;
            }

            budgetManager.addExpense(expense);
            closeModal('expenseModal');
            budgetManager.showNotification('Expense added successfully', 'success');

            // Clear form
            document.getElementById('expense-item').value = '';
            document.getElementById('expense-amount').value = '';
            document.getElementById('expense-supplier').value = '';
            document.getElementById('expense-receipt').value = '';
            document.getElementById('expense-notes').value = '';
        }

        function clearSearch() {
            document.getElementById('search-items').value = '';
            budgetManager.searchItems('');
        }

        function filterExpenses() {
            const dateFilter = document.getElementById('expense-date-filter').value;
            
            if (!dateFilter) {
                budgetManager.showNotification('Please select a date to filter', 'warning');
                return;
            }

            document.querySelectorAll('#expense-list tr').forEach(row => {
                const dateCell = row.cells[0];
                if (!dateCell) return;
                
                const date = dateCell.textContent;
                if (date === dateFilter) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function clearExpenseFilter() {
            document.getElementById('expense-date-filter').value = '';
            document.querySelectorAll('#expense-list tr').forEach(row => {
                row.style.display = '';
            });
            budgetManager.showNotification('Filter cleared', 'info');
        }

        function toggleFab() {
            document.getElementById('fab-menu').classList.toggle('active');
        }

        function quickAddItem() {
            const category = prompt('Enter category (disposables, hygiene, makeup, hair, prosthetics, mouldmaking, sfxmakeup, accessories, actoressentials, departmentsupplies):');
            if (category && budgetManager.data.categories[category]) {
                budgetManager.addItem(category);
                budgetManager.switchTab('proposal');
                toggleFab();
            } else if (category) {
                budgetManager.showNotification('Invalid category', 'warning');
            }
        }

        function quickAddExpense() {
            openExpenseModal();
            toggleFab();
        }

        function duplicateLastItem() {
            // Find the last added item
            let lastItem = null;
            let lastCategory = null;
            
            Object.keys(budgetManager.data.categories).forEach(key => {
                const items = budgetManager.data.categories[key].items;
                if (items.length > 0) {
                    lastItem = items[items.length - 1];
                    lastCategory = key;
                }
            });

            if (lastItem && lastCategory) {
                const duplicate = { ...lastItem, id: Date.now() };
                budgetManager.data.categories[lastCategory].items.push(duplicate);
                budgetManager.renderCategories();
                budgetManager.updateAllCalculations();
                budgetManager.save();
                budgetManager.showNotification('Item duplicated', 'success');
            } else {
                budgetManager.showNotification('No items to duplicate', 'warning');
            }
            
            toggleFab();
        }

        function clearAll() {
            if (confirm('This will clear ALL budget data. Are you sure?')) {
                Object.keys(budgetManager.data.categories).forEach(key => {
                    budgetManager.data.categories[key].items = [];
                });
                budgetManager.data.expenses = [];
                budgetManager.renderCategories();
                budgetManager.renderExpenses();
                budgetManager.updateAllCalculations();
                budgetManager.save();
                budgetManager.showNotification('All data cleared', 'info');
            }
            toggleFab();
        }

        function refreshOverview() {
            budgetManager.updateAllCalculations();
            budgetManager.showNotification('Overview refreshed', 'success');
        }

        function exportComparison() {
            // Export comparison as CSV
            budgetManager.exportData('csv-full');
        }

        // ===== RECEIPT MANAGEMENT FUNCTIONS =====

        // State for current receipt being processed
        let currentReceiptId = null;
        let currentReceiptData = {
            rotation: 0,
            zoom: 1,
            lineItems: []
        };

        // Settings Modal
        function openSettingsModal() {
            const apiKeyInput = document.getElementById('claude-api-key');
            if (apiKeyInput && budgetManager.data.apiSettings) {
                apiKeyInput.value = budgetManager.data.apiSettings.claudeApiKey || '';
            }
            document.getElementById('settingsModal').classList.add('active');
        }

        function saveApiSettings() {
            const apiKey = document.getElementById('claude-api-key').value.trim();

            // Validate API key format if provided
            if (apiKey && !apiKey.startsWith('sk-ant-')) {
                budgetManager.showNotification('Invalid API key format. Claude API keys should start with "sk-ant-"', 'warning');
                return;
            }

            budgetManager.data.apiSettings.claudeApiKey = apiKey;
            budgetManager.save();
            closeModal('settingsModal');
            budgetManager.showNotification('API settings saved', 'success');

            // Update the API key status message
            updateApiKeyStatus();
        }

        // Receipt Upload Functions
        function triggerReceiptUpload() {
            document.getElementById('receipt-file-input').click();
        }

        function updateApiKeyStatus() {
            const statusEl = document.getElementById('api-key-status');
            if (!statusEl) return;

            const hasApiKey = budgetManager.data.apiSettings.claudeApiKey &&
                              budgetManager.data.apiSettings.claudeApiKey.startsWith('sk-ant-');

            if (hasApiKey) {
                statusEl.style.display = 'none';
            } else {
                statusEl.style.display = 'block';
                statusEl.style.background = 'rgba(232, 168, 124, 0.1)';
                statusEl.style.border = '1px solid rgba(232, 168, 124, 0.3)';
                statusEl.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 16px;">⚙️</span>
                        <div>
                            <div style="color: var(--text-primary); font-weight: 500;">Set up your API key for automatic receipt scanning</div>
                            <div style="color: var(--text-secondary); margin-top: 4px;">Click "API Settings" above to add your Claude API key. Without it, you can still enter receipt data manually.</div>
                        </div>
                    </div>
                `;
            }
        }

        function handleReceiptFiles(files) {
            if (!files || files.length === 0) return;

            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = ['image/jpeg', 'image/png', 'image/heic', 'application/pdf'];

            Array.from(files).forEach(file => {
                if (file.size > maxSize) {
                    budgetManager.showNotification(`File ${file.name} is too large (max 10MB)`, 'warning');
                    return;
                }

                if (!allowedTypes.includes(file.type) && !file.name.toLowerCase().endsWith('.heic')) {
                    budgetManager.showNotification(`File ${file.name} is not a supported format`, 'warning');
                    return;
                }

                processReceiptFile(file);
            });
        }

        async function processReceiptFile(file) {
            try {
                const base64 = await fileToBase64(file);
                const receipt = {
                    id: Date.now(),
                    project_id: budgetManager.data.projectInfo.code,
                    file_data: base64,
                    file_type: file.type || 'image/jpeg',
                    file_name: file.name,
                    supplier: '',
                    invoice_number: '',
                    receipt_date: '',
                    raw_total: 0,
                    status: 'unprocessed',
                    uploaded_at: Date.now(),
                    ocr_response: null
                };

                budgetManager.data.receipts.push(receipt);
                budgetManager.save();
                renderReceipts();

                // Check if it's a PDF (can't auto-scan)
                const isPdf = file.type === 'application/pdf';
                if (isPdf) {
                    budgetManager.showNotification('PDF uploaded. Click "Process" to enter details manually.', 'info');
                    return;
                }

                // Check if API key is configured
                const hasApiKey = budgetManager.data.apiSettings.claudeApiKey &&
                                  budgetManager.data.apiSettings.claudeApiKey.startsWith('sk-ant-');

                if (!hasApiKey) {
                    budgetManager.showNotification('Receipt uploaded. Set up your API key in Settings to enable auto-scanning.', 'info');
                    return;
                }

                // Automatically process the receipt with OCR
                budgetManager.showNotification('Receipt uploaded - scanning with AI...', 'info');

                // Small delay to let the UI update, then auto-process
                setTimeout(() => {
                    processReceipt(receipt.id);
                }, 100);

            } catch (error) {
                console.error('Error processing file:', error);
                budgetManager.showNotification('Error processing file', 'danger');
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Drag and Drop
        document.addEventListener('DOMContentLoaded', () => {
            const uploadZone = document.getElementById('receipt-upload-zone');
            if (uploadZone) {
                uploadZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadZone.classList.add('dragover');
                });

                uploadZone.addEventListener('dragleave', () => {
                    uploadZone.classList.remove('dragover');
                });

                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('dragover');
                    handleReceiptFiles(e.dataTransfer.files);
                });
            }
        });

        // Render Receipts
        function renderReceipts() {
            const unprocessedGrid = document.getElementById('unprocessed-receipts-grid');
            const processedGrid = document.getElementById('processed-receipts-grid');

            const unprocessed = budgetManager.data.receipts.filter(r => r.status === 'unprocessed' || r.status === 'flagged');
            const processed = budgetManager.data.receipts.filter(r => r.status === 'processed');

            // Update counts
            document.getElementById('unprocessed-count').textContent = `(${unprocessed.length})`;
            document.getElementById('processed-count').textContent = `(${processed.length})`;

            // Render unprocessed
            if (unprocessed.length === 0) {
                unprocessedGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-title">No unprocessed receipts</div>
                        <div class="empty-desc">Upload receipts above to get started</div>
                    </div>
                `;
            } else {
                unprocessedGrid.innerHTML = unprocessed.map(receipt => createReceiptCard(receipt)).join('');
            }

            // Render processed
            if (processed.length === 0) {
                processedGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-title">No processed receipts</div>
                        <div class="empty-desc">Process unprocessed receipts to see them here</div>
                    </div>
                `;
            } else {
                processedGrid.innerHTML = processed.map(receipt => createReceiptCard(receipt, true)).join('');
            }
        }

        function createReceiptCard(receipt, isProcessed = false) {
            const isPdf = receipt.file_type === 'application/pdf';
            const thumbnail = isPdf
                ? `<div class="pdf-icon">PDF</div>`
                : `<img src="${receipt.file_data}" alt="Receipt">`;

            const statusClass = receipt.status === 'flagged' ? 'flagged' : (isProcessed ? 'processed' : 'unprocessed');
            const statusText = receipt.status === 'flagged' ? 'Flagged' : (isProcessed ? 'Processed' : 'Unprocessed');

            return `
                <div class="receipt-card" data-receipt-id="${receipt.id}">
                    <div class="receipt-thumbnail">${thumbnail}</div>
                    <div class="receipt-info">
                        <div class="receipt-supplier">${receipt.supplier || 'Unknown Supplier'}</div>
                        <div class="receipt-amount">${receipt.raw_total ? '£' + receipt.raw_total.toFixed(2) : 'Amount pending'}</div>
                        <span class="receipt-status ${statusClass}">${statusText}</span>
                        <div class="receipt-actions">
                            ${isProcessed
                                ? `<button onclick="viewReceipt(${receipt.id})">View</button>
                                   <button onclick="deleteReceipt(${receipt.id})">Delete</button>`
                                : `<button class="primary" onclick="processReceipt(${receipt.id})">Process</button>
                                   <button onclick="deleteReceipt(${receipt.id})">Delete</button>`
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleProcessedReceipts() {
            const grid = document.getElementById('processed-receipts-grid');
            const summary = document.getElementById('processed-receipts-summary');

            if (grid.style.display === 'none') {
                grid.style.display = 'grid';
                summary.style.display = 'none';
            } else {
                grid.style.display = 'none';
                summary.style.display = 'block';
            }
        }

        function deleteReceipt(receiptId) {
            if (confirm('Delete this receipt?')) {
                budgetManager.data.receipts = budgetManager.data.receipts.filter(r => r.id !== receiptId);
                budgetManager.save();
                renderReceipts();
                budgetManager.showNotification('Receipt deleted', 'info');
            }
        }

        // ===== CLAUDE API INTEGRATION =====

        async function callClaudeAPI(imageBase64, fileType) {
            const apiKey = budgetManager.data.apiSettings.claudeApiKey;

            if (!apiKey) {
                throw new Error('API key not configured. Please set your Claude API key in Settings.');
            }

            // Validate API key format
            if (!apiKey.startsWith('sk-ant-')) {
                throw new Error('Invalid API key format. Claude API keys should start with "sk-ant-"');
            }

            console.log('Starting OCR request, image data length:', imageBase64.length, 'file type:', fileType);

            // Try server-side proxy first (works in production on Vercel)
            try {
                console.log('Attempting server-side API proxy...');
                const proxyResponse = await fetch('/api/claude-ocr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        imageBase64: imageBase64,
                        fileType: fileType,
                        apiKey: apiKey
                    })
                });

                if (proxyResponse.ok) {
                    const result = await proxyResponse.json();
                    console.log('Server proxy OCR result:', result);
                    return result;
                }

                // If proxy returns an error, get the message
                const proxyError = await proxyResponse.json();
                if (proxyResponse.status !== 404) {
                    // Real error from proxy, throw it
                    throw new Error(proxyError.error || 'OCR processing failed');
                }
                // 404 means proxy not available, fall through to direct call
                console.log('Server proxy not available, trying direct API call...');
            } catch (proxyError) {
                // Network error or proxy not available - try direct call
                console.log('Server proxy failed:', proxyError.message, '- trying direct API call...');
            }

            // Fall back to direct API call (requires browser access enabled on API key)
            console.log('Attempting direct Claude API call...');

            // Extract base64 data from data URL
            const base64Data = imageBase64.split(',')[1];

            if (!base64Data) {
                throw new Error('Invalid image data. Please try uploading the receipt again.');
            }

            // Determine media type
            let mediaType = fileType;
            if (mediaType === 'image/heic') mediaType = 'image/jpeg';
            if (!mediaType || mediaType === '') mediaType = 'image/jpeg';

            const prompt = `Analyse this receipt/invoice image and extract the following data in JSON format:
{
  "supplier": "supplier name",
  "date": "DD/MM/YYYY",
  "invoice_number": "if visible",
  "items": [
    {
      "description": "item description",
      "quantity": 1,
      "amount": 0.00,
      "suggested_category": "one of: disposables, hygiene, makeup, hair, prosthetics, mouldmaking, sfxmakeup, accessories, actoressentials, departmentsupplies"
    }
  ],
  "total": 0.00
}

For suggested_category, use your knowledge of hair and makeup department supplies:
- disposables: mascara wands, cotton buds, sponges, gloves, applicators
- hygiene: brush cleaner, alcohol, sanitiser, wipes, sterilising supplies
- makeup: foundations, powders, lip products, mascara, setting spray, makeup brushes
- hair: wigs, extensions, styling products, combs, hairspray
- prosthetics: ready-made pieces, bondo moulds, transfers, bald caps, pre-made appliances
- mouldmaking: silicone, alginate, plaster, lifecasting supplies, release agents
- sfxmakeup: liquid latex, blood products, adhesives, removers, sealers, scar wax
- accessories: hair clips, grips, facial jewellery, piercings, decorative pieces
- actoressentials: chewing gum, mints, eye drops, tampons, deodorant, lip balm, tissues
- departmentsupplies: kit bags, capes, mirrors, organisers, storage, towels

Return ONLY the JSON object, no markdown formatting or explanation.`;

            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 2048,
                    messages: [
                        {
                            role: 'user',
                            content: [
                                {
                                    type: 'image',
                                    source: {
                                        type: 'base64',
                                        media_type: mediaType,
                                        data: base64Data
                                    }
                                },
                                {
                                    type: 'text',
                                    text: prompt
                                }
                            ]
                        }
                    ]
                })
            });

            if (!response.ok) {
                let errorMessage = 'API request failed';
                try {
                    const errorData = await response.json();
                    console.error('API Error Response:', errorData);
                    errorMessage = errorData.error?.message || errorMessage;
                } catch (e) {
                    console.error('Could not parse error response');
                }

                if (response.status === 401) {
                    throw new Error('Invalid API key. Please check your Claude API key in Settings.');
                } else if (response.status === 429) {
                    throw new Error('Rate limit exceeded. Please wait a moment and try again.');
                } else if (response.status === 400) {
                    throw new Error('Bad request: ' + errorMessage);
                } else if (response.status === 403) {
                    throw new Error('API access denied. Your Claude API key may not have browser access enabled. Please contact support or try a different API key.');
                } else if (response.status >= 500) {
                    throw new Error('Claude API server error. Please try again later.');
                }

                throw new Error(errorMessage);
            }

            const data = await response.json();
            console.log('Claude API Response:', data);

            if (!data.content || !data.content[0] || !data.content[0].text) {
                console.error('Unexpected API response structure:', data);
                throw new Error('Unexpected response from Claude API');
            }

            const content = data.content[0].text;
            console.log('OCR Response content:', content);

            // Parse the JSON response
            try {
                return JSON.parse(content);
            } catch (e) {
                console.log('Direct JSON parse failed, trying to extract JSON from text');
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    try {
                        return JSON.parse(jsonMatch[0]);
                    } catch (parseError) {
                        console.error('Failed to parse extracted JSON:', parseError);
                    }
                }
                console.error('Could not parse OCR response. Raw content:', content);
                throw new Error('Could not parse receipt data from AI response');
            }
        }

        // ===== RECEIPT PROCESSING =====

        async function processReceipt(receiptId) {
            const receipt = budgetManager.data.receipts.find(r => r.id === receiptId);
            if (!receipt) return;

            // Check for PDF files - OCR requires images
            const isPdf = receipt.file_type === 'application/pdf';
            if (isPdf) {
                budgetManager.showNotification('PDF files cannot be processed with OCR. Please upload a JPG/PNG image of your receipt, or enter details manually.', 'warning');
            }

            // Check API key before processing
            if (!receipt.ocr_response && !isPdf && !budgetManager.data.apiSettings.claudeApiKey) {
                budgetManager.showNotification('Please set your Claude API key in Settings to enable automatic receipt reading. Click the gear icon in the header.', 'warning');
            }

            currentReceiptId = receiptId;
            currentReceiptData = {
                rotation: 0,
                zoom: 1,
                lineItems: []
            };

            // Show the processing modal
            document.getElementById('receiptProcessingModal').classList.add('active');

            // Set the image (or PDF placeholder)
            const img = document.getElementById('receipt-image-preview');
            if (isPdf) {
                img.src = '';
                img.alt = 'PDF files cannot be previewed - enter data manually';
                img.style.display = 'none';
                document.getElementById('receipt-image-container').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 64px; margin-bottom: 16px;">📄</div>
                        <div style="font-size: 16px; font-weight: 500; color: var(--text-primary);">PDF Receipt</div>
                        <div style="margin-top: 8px;">PDF files cannot be auto-scanned.</div>
                        <div style="margin-top: 4px;">Please enter the receipt details manually.</div>
                    </div>
                `;
            } else {
                // Restore image element if it was replaced with PDF message
                const imgContainer = document.getElementById('receipt-image-container');
                if (!imgContainer.querySelector('img')) {
                    imgContainer.innerHTML = '<img id="receipt-image-preview" src="" alt="Receipt" style="max-width: 100%; transition: transform 0.2s ease;">';
                }
                const imgEl = document.getElementById('receipt-image-preview');
                imgEl.src = receipt.file_data;
                imgEl.style.transform = 'rotate(0deg) scale(1)';
                imgEl.style.display = 'block';
            }

            // Clear previous data
            document.getElementById('receipt-supplier').value = receipt.supplier || '';
            document.getElementById('receipt-date').value = receipt.receipt_date || '';
            document.getElementById('receipt-invoice-number').value = receipt.invoice_number || '';
            document.getElementById('receipt-line-items').innerHTML = '';
            document.getElementById('receipt-ocr-total').textContent = '£0.00';
            document.getElementById('receipt-items-total').textContent = '£0.00';

            // Hide loading overlay initially
            const loadingOverlay = document.getElementById('ocr-loading-overlay');
            loadingOverlay.style.display = 'none';

            // Check if already has OCR data
            if (receipt.ocr_response) {
                populateFromOCR(receipt.ocr_response);
            } else if (isPdf) {
                // PDF files - manual entry only
                addReceiptLineItem();
            } else {
                // Call Claude API for OCR
                if (!budgetManager.data.apiSettings.claudeApiKey) {
                    addReceiptLineItem(); // Add empty line item for manual entry
                    return;
                }

                try {
                    // Show loading overlay
                    loadingOverlay.style.display = 'flex';

                    console.log('Starting OCR processing for receipt:', receiptId);
                    const ocrResult = await callClaudeAPI(receipt.file_data, receipt.file_type);
                    console.log('OCR Result:', ocrResult);

                    // Hide loading overlay
                    loadingOverlay.style.display = 'none';

                    // Store OCR response
                    receipt.ocr_response = ocrResult;
                    budgetManager.save();

                    populateFromOCR(ocrResult);
                    budgetManager.showNotification('Receipt processed successfully! Review the extracted data below.', 'success');
                } catch (error) {
                    // Hide loading overlay on error
                    loadingOverlay.style.display = 'none';

                    console.error('OCR Error:', error);
                    console.error('Error details:', error.message, error.stack);

                    let errorMessage = 'OCR failed';
                    if (error.message.includes('API key')) {
                        errorMessage = 'Invalid API key. Please check your Claude API key in Settings.';
                    } else if (error.message.includes('network') || error.message.includes('fetch')) {
                        errorMessage = 'Network error. Please check your internet connection.';
                    } else if (error.message.includes('rate') || error.message.includes('limit')) {
                        errorMessage = 'Rate limit exceeded. Please wait a moment and try again.';
                    } else {
                        errorMessage = error.message || 'Unknown error occurred';
                    }

                    budgetManager.showNotification(errorMessage + ' You can enter receipt data manually.', 'danger');
                    addReceiptLineItem(); // Add empty line item for manual entry
                }
            }
        }

        function populateFromOCR(ocrData) {
            // Populate form fields
            document.getElementById('receipt-supplier').value = ocrData.supplier || '';

            // Convert date format from DD/MM/YYYY to YYYY-MM-DD for input
            if (ocrData.date) {
                const parts = ocrData.date.split('/');
                if (parts.length === 3) {
                    document.getElementById('receipt-date').value = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                }
            }

            document.getElementById('receipt-invoice-number').value = ocrData.invoice_number || '';

            // Set OCR total
            const ocrTotal = parseFloat(ocrData.total) || 0;
            document.getElementById('receipt-ocr-total').textContent = '£' + ocrTotal.toFixed(2);

            // Clear and populate line items
            const lineItemsContainer = document.getElementById('receipt-line-items');
            lineItemsContainer.innerHTML = '';
            currentReceiptData.lineItems = [];

            if (ocrData.items && ocrData.items.length > 0) {
                ocrData.items.forEach(item => {
                    addReceiptLineItem(item);
                });
            } else {
                addReceiptLineItem();
            }

            updateReceiptTotals();
        }

        function processAllReceipts() {
            const unprocessed = budgetManager.data.receipts.filter(r => r.status === 'unprocessed');
            if (unprocessed.length === 0) {
                budgetManager.showNotification('No unprocessed receipts', 'info');
                return;
            }

            // Process first one
            processReceipt(unprocessed[0].id);
        }

        // ===== LINE ITEM MANAGEMENT =====

        function addReceiptLineItem(itemData = {}) {
            const container = document.getElementById('receipt-line-items');
            const index = currentReceiptData.lineItems.length;

            const item = {
                description: itemData.description || '',
                quantity: itemData.quantity || 1,
                amount: itemData.amount || 0,
                category: itemData.suggested_category || 'disposables'
            };

            currentReceiptData.lineItems.push(item);

            const categoryOptions = `
                <option value="disposables" ${item.category === 'disposables' ? 'selected' : ''}>Disposables</option>
                <option value="hygiene" ${item.category === 'hygiene' ? 'selected' : ''}>Hygiene</option>
                <option value="makeup" ${item.category === 'makeup' ? 'selected' : ''}>Makeup</option>
                <option value="hair" ${item.category === 'hair' ? 'selected' : ''}>Hair</option>
                <option value="prosthetics" ${item.category === 'prosthetics' ? 'selected' : ''}>Prosthetics</option>
                <option value="mouldmaking" ${item.category === 'mouldmaking' ? 'selected' : ''}>Mould Making</option>
                <option value="sfxmakeup" ${item.category === 'sfxmakeup' ? 'selected' : ''}>SFX Makeup</option>
                <option value="accessories" ${item.category === 'accessories' ? 'selected' : ''}>Accessories</option>
                <option value="actoressentials" ${item.category === 'actoressentials' ? 'selected' : ''}>Actor Essentials</option>
                <option value="departmentsupplies" ${item.category === 'departmentsupplies' ? 'selected' : ''}>Department Supplies</option>
            `;

            const itemHtml = `
                <div class="receipt-line-item" data-index="${index}" style="padding: 12px; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 8px;">
                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                        <input type="text" class="form-input" placeholder="Description" value="${item.description}"
                               style="flex: 1;" onchange="updateLineItem(${index}, 'description', this.value)">
                        <button class="delete-btn" onclick="removeLineItem(${index})" style="width: 32px;">×</button>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <select class="form-select" style="flex: 2;" onchange="updateLineItem(${index}, 'category', this.value)">
                            ${categoryOptions}
                        </select>
                        <input type="number" class="form-input" placeholder="Qty" value="${item.quantity}" min="1" step="1"
                               style="width: 60px;" onchange="updateLineItem(${index}, 'quantity', this.value)">
                        <input type="number" class="form-input" placeholder="Amount" value="${item.amount}" min="0" step="0.01"
                               style="width: 80px;" onchange="updateLineItem(${index}, 'amount', this.value)">
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', itemHtml);
        }

        function updateLineItem(index, field, value) {
            if (currentReceiptData.lineItems[index]) {
                if (field === 'quantity' || field === 'amount') {
                    value = parseFloat(value) || 0;
                }
                currentReceiptData.lineItems[index][field] = value;
                updateReceiptTotals();
            }
        }

        function removeLineItem(index) {
            currentReceiptData.lineItems.splice(index, 1);

            // Re-render all line items
            const container = document.getElementById('receipt-line-items');
            container.innerHTML = '';

            const itemsCopy = [...currentReceiptData.lineItems];
            currentReceiptData.lineItems = [];

            itemsCopy.forEach(item => {
                addReceiptLineItem(item);
            });

            updateReceiptTotals();
        }

        function updateReceiptTotals() {
            const itemsTotal = currentReceiptData.lineItems.reduce((sum, item) => {
                return sum + (parseFloat(item.amount) || 0) * (parseInt(item.quantity) || 1);
            }, 0);

            document.getElementById('receipt-items-total').textContent = '£' + itemsTotal.toFixed(2);

            const ocrTotalText = document.getElementById('receipt-ocr-total').textContent;
            const ocrTotal = parseFloat(ocrTotalText.replace('£', '')) || 0;

            const matchEl = document.getElementById('receipt-total-match');
            const tolerance = 0.02; // 2p tolerance for rounding differences

            if (Math.abs(itemsTotal - ocrTotal) <= tolerance || ocrTotal === 0) {
                matchEl.innerHTML = '<span style="font-size: 18px;">✓</span><span style="color: var(--success);">Totals match</span>';
            } else {
                matchEl.innerHTML = '<span style="font-size: 18px;">⚠</span><span style="color: var(--warning);">Totals don\'t match (difference: £' + Math.abs(itemsTotal - ocrTotal).toFixed(2) + ')</span>';
            }
        }

        // ===== IMAGE MANIPULATION =====

        function rotateReceiptImage(degrees) {
            currentReceiptData.rotation += degrees;
            applyImageTransform();
        }

        function zoomReceiptImage(factor) {
            currentReceiptData.zoom *= factor;
            currentReceiptData.zoom = Math.max(0.5, Math.min(3, currentReceiptData.zoom));
            applyImageTransform();
        }

        function resetReceiptImage() {
            currentReceiptData.rotation = 0;
            currentReceiptData.zoom = 1;
            applyImageTransform();
        }

        function applyImageTransform() {
            const img = document.getElementById('receipt-image-preview');
            img.style.transform = `rotate(${currentReceiptData.rotation}deg) scale(${currentReceiptData.zoom})`;
        }

        // ===== RECEIPT APPROVAL =====

        function closeReceiptProcessingModal() {
            document.getElementById('receiptProcessingModal').classList.remove('active');
            currentReceiptId = null;
        }

        function flagReceipt() {
            if (!currentReceiptId) return;

            const receipt = budgetManager.data.receipts.find(r => r.id === currentReceiptId);
            if (receipt) {
                receipt.status = 'flagged';
                budgetManager.save();
                renderReceipts();
            }

            closeReceiptProcessingModal();
            budgetManager.showNotification('Receipt flagged for review', 'warning');
        }

        function approveReceipt() {
            if (!currentReceiptId) return;

            const receipt = budgetManager.data.receipts.find(r => r.id === currentReceiptId);
            if (!receipt) return;

            // Validate we have at least one line item
            if (currentReceiptData.lineItems.length === 0 || !currentReceiptData.lineItems.some(item => item.description)) {
                budgetManager.showNotification('Please add at least one line item', 'warning');
                return;
            }

            // Check for duplicate invoice number
            const invoiceNumber = document.getElementById('receipt-invoice-number').value;
            if (invoiceNumber) {
                const duplicate = budgetManager.data.receipts.find(r =>
                    r.id !== receipt.id &&
                    r.invoice_number === invoiceNumber &&
                    r.status === 'processed'
                );
                if (duplicate) {
                    if (!confirm('A receipt with this invoice number already exists. Continue anyway?')) {
                        return;
                    }
                }
            }

            // Update receipt data
            receipt.supplier = document.getElementById('receipt-supplier').value;
            receipt.receipt_date = document.getElementById('receipt-date').value;
            receipt.invoice_number = invoiceNumber;
            receipt.raw_total = currentReceiptData.lineItems.reduce((sum, item) => {
                return sum + (parseFloat(item.amount) || 0) * (parseInt(item.quantity) || 1);
            }, 0);
            receipt.status = 'processed';

            // Create expenses for each line item
            currentReceiptData.lineItems.forEach(item => {
                if (!item.description) return;

                const expense = {
                    id: Date.now() + Math.random(),
                    date: receipt.receipt_date || new Date().toISOString().split('T')[0],
                    item: item.description,
                    category: item.category,
                    supplier: receipt.supplier,
                    amount: (parseFloat(item.amount) || 0) * (parseInt(item.quantity) || 1),
                    receipt: receipt.invoice_number,
                    receipt_id: receipt.id,
                    notes: `From receipt: ${receipt.file_name || 'uploaded'}`
                };

                budgetManager.data.expenses.push(expense);
            });

            budgetManager.save();
            budgetManager.renderExpenses();
            budgetManager.updateAllCalculations();
            renderReceipts();
            closeReceiptProcessingModal();
            budgetManager.showNotification('Receipt approved and expenses created', 'success');
        }

        // ===== VIEW RECEIPT =====

        function viewReceipt(receiptId) {
            const receipt = budgetManager.data.receipts.find(r => r.id === receiptId);
            if (!receipt) return;

            const imageContainer = document.querySelector('#receiptViewModal #receipt-view-image img');
            imageContainer.src = receipt.file_data;

            const metadata = document.getElementById('receipt-view-metadata');
            const uploadDate = new Date(receipt.uploaded_at).toLocaleDateString();

            // Find linked expenses
            const linkedExpenses = budgetManager.data.expenses.filter(e => e.receipt_id === receipt.id);

            metadata.innerHTML = `
                <div style="display: grid; gap: 8px;">
                    <div><strong>Supplier:</strong> ${receipt.supplier || 'N/A'}</div>
                    <div><strong>Invoice Number:</strong> ${receipt.invoice_number || 'N/A'}</div>
                    <div><strong>Receipt Date:</strong> ${receipt.receipt_date || 'N/A'}</div>
                    <div><strong>Total:</strong> £${receipt.raw_total?.toFixed(2) || '0.00'}</div>
                    <div><strong>Uploaded:</strong> ${uploadDate}</div>
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border);">
                        <strong>Linked Expenses:</strong> ${linkedExpenses.length} item(s)
                    </div>
                </div>
            `;

            document.getElementById('receiptViewModal').classList.add('active');
        }

        // ===== ATTACH RECEIPT TO EXPENSE =====

        function attachReceiptToExpense(expenseId) {
            // Get unprocessed receipts
            const unprocessedReceipts = budgetManager.data.receipts.filter(r =>
                r.status === 'unprocessed' || r.status === 'flagged'
            );

            if (unprocessedReceipts.length === 0) {
                // Option to upload new receipt
                if (confirm('No unprocessed receipts available. Would you like to upload a new receipt?')) {
                    budgetManager.switchTab('receipts');
                }
                return;
            }

            // Create a simple modal to select receipt
            const options = unprocessedReceipts.map(r =>
                `${r.supplier || 'Unknown'} - ${r.file_name || 'Receipt'} (${new Date(r.uploaded_at).toLocaleDateString()})`
            );

            const selected = prompt(
                'Select a receipt to attach (enter number):\n\n' +
                options.map((opt, i) => `${i + 1}. ${opt}`).join('\n') +
                '\n\nOr enter 0 to upload a new receipt'
            );

            if (selected === null) return;

            const index = parseInt(selected) - 1;

            if (selected === '0') {
                budgetManager.switchTab('receipts');
                return;
            }

            if (index >= 0 && index < unprocessedReceipts.length) {
                const receipt = unprocessedReceipts[index];
                const expense = budgetManager.data.expenses.find(e => e.id === expenseId);

                if (expense) {
                    expense.receipt_id = receipt.id;
                    if (!expense.receipt) {
                        expense.receipt = receipt.invoice_number || 'Attached';
                    }
                    budgetManager.save();
                    budgetManager.renderExpenses();
                    budgetManager.showNotification('Receipt attached to expense', 'success');
                }
            } else {
                budgetManager.showNotification('Invalid selection', 'warning');
            }
        }

        // Initialize receipts display when tab is shown
        document.addEventListener('DOMContentLoaded', () => {
            // Add tab switch listener to render receipts when receipts tab is shown
            document.querySelectorAll('[data-tab="receipts"]').forEach(el => {
                el.addEventListener('click', () => {
                    setTimeout(renderReceipts, 100);
                });
            });

            // Initial render if receipts data exists
            if (budgetManager && budgetManager.data.receipts) {
                renderReceipts();
            }
        });
    </script>
</body>
</html>
