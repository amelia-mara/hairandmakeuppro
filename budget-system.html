<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget System Pro - Hair & Makeup</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0d0b0a;
            --bg-medium: #1a1612;
            --card-bg: #242019;
            --text-light: #e8e6e3;
            --text-muted: #8a7f73;
            --accent-gold: #c9a961;
            --border: #2d2925;
            --divider: #363330;
            --success: #52c186;
            --warning: #e8a87c;
            --danger: #ef4444;
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(13, 11, 10, 0.4);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(138, 127, 115, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(138, 127, 115, 0.5);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-light);
            min-height: 100vh;
            font-weight: 400;
            letter-spacing: -0.01em;
        }

        /* Layout */
        .app-layout {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-medium);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.875em;
            margin-bottom: 16px;
            transition: color 0.2s ease;
        }

        .back-btn:hover {
            color: var(--accent-gold);
        }

        .project-info h2 {
            font-size: 1.25em;
            font-weight: 600;
            margin-bottom: 4px;
            letter-spacing: -0.02em;
        }

        .project-code {
            font-size: 0.8125em;
            color: var(--text-muted);
        }

        .nav-section {
            padding: 24px 16px;
            border-bottom: 1px solid var(--border);
        }

        .nav-section-title {
            font-size: 0.6875em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 12px;
            padding: 0 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 2px;
            font-size: 0.875em;
            color: var(--text-muted);
        }

        .nav-item:hover {
            background: rgba(201, 169, 97, 0.08);
            color: var(--text-light);
        }

        .nav-item.active {
            background: rgba(201, 169, 97, 0.12);
            color: var(--accent-gold);
            font-weight: 500;
        }

        .nav-icon {
            width: 18px;
            font-size: 1.1em;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Top Bar */
        .top-bar {
            height: 60px;
            background: var(--bg-medium);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
        }

        .page-title {
            font-size: 1.125em;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .top-bar-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8125em;
            transition: all 0.2s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
            background: rgba(201, 169, 97, 0.05);
        }

        .btn.primary {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
            color: var(--bg-dark);
        }

        .btn.primary:hover {
            background: #d4b16d;
        }

        /* Content Area */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }

        /* Budget Overview Cards */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            border-color: var(--divider);
        }

        .stat-label {
            font-size: 0.8125em;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .stat-change {
            font-size: 0.8125em;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--danger);
        }

        /* Budget Table */
        .budget-section {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 24px;
        }

        .budget-section-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-icon {
            font-size: 1.2em;
        }

        .section-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            padding: 6px 10px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.875em;
            transition: all 0.2s ease;
        }

        .icon-btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        /* Category Table */
        .category-table {
            width: 100%;
            border-collapse: collapse;
        }

        .category-table thead {
            background: rgba(201, 169, 97, 0.05);
        }

        .category-table th {
            padding: 12px 24px;
            text-align: left;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
        }

        .category-table th:last-child {
            text-align: right;
        }

        .category-table td {
            padding: 16px 24px;
            font-size: 0.875em;
            border-bottom: 1px solid var(--border);
        }

        .category-table td:last-child {
            text-align: right;
            font-weight: 500;
        }

        .category-table tbody tr:hover {
            background: rgba(201, 169, 97, 0.03);
        }

        .category-table tbody tr:last-child td {
            border-bottom: none;
        }

        .item-name {
            color: var(--text-light);
            font-weight: 500;
        }

        .item-desc {
            color: var(--text-muted);
            font-size: 0.9em;
            margin-top: 2px;
        }

        .supplier-tag {
            display: inline-block;
            padding: 4px 8px;
            background: rgba(201, 169, 97, 0.1);
            border: 1px solid rgba(201, 169, 97, 0.2);
            border-radius: 4px;
            font-size: 0.75em;
            color: var(--accent-gold);
        }

        /* Input Fields */
        .input-row {
            display: grid;
            grid-template-columns: 2.5fr 80px 100px 100px 120px 200px 150px 40px;
            gap: 12px;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }

        .input-row:last-child {
            border-bottom: none;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-medium);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-light);
            font-size: 0.875em;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            background: var(--bg-dark);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .calculated-value {
            color: var(--accent-gold);
            font-weight: 600;
            font-size: 0.875em;
            text-align: right;
        }

        .delete-btn {
            padding: 6px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875em;
        }

        .delete-btn:hover {
            border-color: var(--danger);
            color: var(--danger);
        }

        /* Category Total */
        .category-total {
            padding: 16px 24px;
            background: rgba(201, 169, 97, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .total-label {
            color: var(--text-muted);
            font-size: 0.875em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .total-value {
            color: var(--accent-gold);
            font-size: 1.125em;
        }

        /* Grand Total */
        .grand-total {
            background: var(--card-bg);
            border: 2px solid var(--accent-gold);
            border-radius: 8px;
            padding: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
        }

        .grand-total-label {
            font-size: 1.25em;
            font-weight: 600;
            color: var(--text-light);
        }

        .grand-total-value {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--accent-gold);
        }

        /* Progress Bar */
        .progress-section {
            margin-bottom: 32px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-label {
            font-size: 0.875em;
            color: var(--text-muted);
        }

        .progress-value {
            font-size: 0.875em;
            color: var(--text-light);
            font-weight: 500;
        }

        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-gold), #d4b16d);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, var(--warning), #f0b589);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, var(--danger), #f87171);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25em;
            font-weight: 600;
        }

        .modal-close {
            padding: 8px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.5em;
            transition: color 0.2s ease;
        }

        .modal-close:hover {
            color: var(--text-light);
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.875em;
            font-weight: 500;
            color: var(--text-light);
            margin-bottom: 8px;
        }

        .form-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-medium);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-light);
            font-size: 0.875em;
            cursor: pointer;
        }

        .modal-footer {
            padding: 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Empty State */
        .empty-state {
            padding: 60px 24px;
            text-align: center;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 3em;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 1.125em;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 8px;
        }

        .empty-desc {
            font-size: 0.875em;
            margin-bottom: 24px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.875em;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .tab:hover {
            color: var(--text-light);
        }

        .tab.active {
            color: var(--accent-gold);
            border-bottom-color: var(--accent-gold);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 80px;
            right: 32px;
            padding: 16px 24px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.875em;
            z-index: 2000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: var(--success);
            color: white;
        }

        .notification.warning {
            background: var(--warning);
            color: var(--bg-dark);
        }

        .notification.danger {
            background: var(--danger);
            color: white;
        }

        .notification.info {
            background: var(--accent-gold);
            color: var(--bg-dark);
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }

        /* Search & Filter Bar */
        .search-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .search-input {
            flex: 1;
            padding: 10px 16px;
            background: var(--bg-medium);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-light);
            font-size: 0.875em;
        }

        .filter-btn {
            padding: 10px 16px;
            background: var(--bg-medium);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.875em;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        /* Variance Indicator */
        .variance {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75em;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .variance.positive {
            color: var(--success);
            background: rgba(82, 193, 134, 0.1);
        }

        .variance.negative {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .variance.neutral {
            color: var(--text-muted);
            background: rgba(138, 127, 115, 0.1);
        }

        /* Supplier Management */
        .supplier-select {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-medium);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-light);
            font-size: 0.875em;
            cursor: pointer;
        }

        /* Notes Field */
        .notes-input {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-medium);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-light);
            font-size: 0.75em;
            resize: vertical;
            min-height: 32px;
        }

        /* Quick Actions Menu */
        .quick-actions {
            position: fixed;
            bottom: 32px;
            right: 32px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent-gold);
            border: none;
            color: var(--bg-dark);
            cursor: pointer;
            font-size: 1.5em;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }

        .fab:hover {
            transform: scale(1.1);
            background: #d4b16d;
        }

        .fab-menu {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 8px;
        }

        .fab-menu.active {
            display: flex;
        }

        .fab-item {
            padding: 8px 16px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-light);
            cursor: pointer;
            font-size: 0.875em;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .fab-item:hover {
            background: var(--bg-medium);
            border-color: var(--accent-gold);
        }

        /* Comparison View */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
        }

        .comparison-table th {
            padding: 12px;
            text-align: left;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            background: rgba(201, 169, 97, 0.05);
            border-bottom: 2px solid var(--border);
        }

        .comparison-table td {
            padding: 12px;
            font-size: 0.875em;
            border-bottom: 1px solid var(--border);
        }

        /* Print Styles */
        @media print {
            .sidebar, .top-bar, .tabs, .btn, .icon-btn, .delete-btn, .fab {
                display: none !important;
            }
            
            .app-layout {
                display: block;
            }
            
            .main-content {
                width: 100%;
            }
            
            .content {
                padding: 20px;
            }
            
            body {
                background: white;
                color: black;
            }
            
            .budget-section, .stat-card {
                border: 1px solid #ddd;
                break-inside: avoid;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .input-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .overview-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading State */
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent-gold);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <a href="#" class="back-btn">‚Üê Back to Dashboard</a>
                <div class="project-info">
                    <h2 id="project-name-display">The Big Race</h2>
                    <div class="project-code" id="project-code-display">HM-2025-001</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Budget Tools</div>
                <div class="nav-item active" onclick="switchTab('overview')">
                    <span class="nav-icon">üí∞</span>
                    Budget Overview
                </div>
                <div class="nav-item" onclick="switchTab('proposal')">
                    <span class="nav-icon">üìù</span>
                    Budget Proposal
                </div>
                <div class="nav-item" onclick="switchTab('tracking')">
                    <span class="nav-icon">üìä</span>
                    Spend Tracking
                </div>
                <div class="nav-item" onclick="switchTab('comparison')">
                    <span class="nav-icon">‚öñÔ∏è</span>
                    Budget vs Actual
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Quick Stats</div>
                <div style="padding: 0 16px; font-size: 0.875em;">
                    <div style="margin-bottom: 12px;">
                        <div style="color: var(--text-muted); margin-bottom: 4px;">Total Budget</div>
                        <div style="color: var(--accent-gold); font-weight: 600;" id="sidebar-total">¬£0.00</div>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <div style="color: var(--text-muted); margin-bottom: 4px;">Items</div>
                        <div style="color: var(--text-light); font-weight: 600;" id="sidebar-items">0</div>
                    </div>
                    <div>
                        <div style="color: var(--text-muted); margin-bottom: 4px;">Last Saved</div>
                        <div style="color: var(--text-light); font-size: 0.875em;" id="sidebar-saved">Never</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="page-title">Budget System Pro</div>
                <div class="top-bar-actions">
                    <button class="btn" onclick="importData()">
                        <span>üì•</span>
                        Import CSV
                    </button>
                    <button class="btn" onclick="exportBudget()">
                        <span>üì§</span>
                        Export
                    </button>
                    <button class="btn" onclick="openTemplateModal()">
                        <span>üìã</span>
                        Templates
                    </button>
                    <button class="btn primary" onclick="saveBudget()">
                        <span>üíæ</span>
                        Save
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="content">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('overview')">Overview</button>
                    <button class="tab" onclick="switchTab('proposal')">Budget Proposal</button>
                    <button class="tab" onclick="switchTab('tracking')">Spend Tracking</button>
                    <button class="tab" onclick="switchTab('comparison')">Budget vs Actual</button>
                </div>

                <!-- Overview Tab -->
                <div id="overview-tab" class="tab-content active">
                    <!-- Stats Grid -->
                    <div class="overview-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Budget</div>
                            <div class="stat-value" id="overview-total-budget">¬£0.00</div>
                            <div class="stat-change positive">
                                <span id="overview-budget-change">Ready to build</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-label">Spent To Date</div>
                            <div class="stat-value" id="overview-spent">¬£0.00</div>
                            <div class="stat-change positive">
                                <span id="overview-spent-percent">0%</span> of budget
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-label">Remaining</div>
                            <div class="stat-value" id="overview-remaining">¬£0.00</div>
                            <div class="stat-change positive">
                                <span id="overview-remaining-percent">100%</span> available
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-label">Cost Variance</div>
                            <div class="stat-value" id="overview-variance">¬£0.00</div>
                            <div class="stat-change" id="overview-variance-status">
                                <span>On budget</span>
                            </div>
                        </div>
                    </div>

                    <!-- Budget Progress -->
                    <div class="progress-section">
                        <div class="progress-header">
                            <span class="progress-label">Budget Utilization</span>
                            <span class="progress-value" id="progress-percent">0% Used</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Category Breakdown -->
                    <div class="budget-section">
                        <div class="budget-section-header">
                            <div class="section-title">
                                <span class="section-icon">üì¶</span>
                                Category Breakdown
                            </div>
                            <div class="section-actions">
                                <button class="icon-btn" onclick="refreshOverview()">üîÑ Refresh</button>
                            </div>
                        </div>
                        <table class="category-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Budgeted</th>
                                    <th>Spent</th>
                                    <th>Remaining</th>
                                    <th>Variance</th>
                                </tr>
                            </thead>
                            <tbody id="overview-categories">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Budget Proposal Tab -->
                <div id="proposal-tab" class="tab-content">
                    <!-- Search Bar -->
                    <div class="search-bar">
                        <input type="text" class="search-input" placeholder="Search items..." id="search-items" onkeyup="searchItems()">
                        <button class="filter-btn" onclick="filterByCategory()">üîΩ Filter Category</button>
                        <button class="filter-btn" onclick="sortItems()">‚ÜïÔ∏è Sort</button>
                    </div>

                    <!-- Project Info -->
                    <div class="budget-section" style="margin-bottom: 24px;">
                        <div class="budget-section-header">
                            <div class="section-title">
                                <span class="section-icon">üìã</span>
                                Project Information
                            </div>
                        </div>
                        <div style="padding: 24px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div class="form-group">
                                    <label class="form-label">Production Name</label>
                                    <input type="text" class="form-input" id="project-name" value="The Big Race" placeholder="Enter production name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Project Code</label>
                                    <input type="text" class="form-input" id="project-code" value="HM-2025-001" placeholder="e.g., HM-2025-001">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Makeup Designer</label>
                                    <input type="text" class="form-input" id="designer-name" placeholder="Enter designer name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Project Type</label>
                                    <select class="form-select" id="project-type">
                                        <option>Feature Film</option>
                                        <option>TV Series</option>
                                        <option>Commercial</option>
                                        <option>Short Film</option>
                                        <option>Documentary</option>
                                        <option>Music Video</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Duration</label>
                                    <input type="text" class="form-input" id="project-duration" value="4 weeks" placeholder="e.g., 4 weeks">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Budget Limit</label>
                                    <input type="number" class="form-input" id="budget-limit" placeholder="Maximum budget (¬£)" step="100">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic Category Sections -->
                    <div id="category-sections">
                        <!-- Categories will be generated here -->
                    </div>

                    <!-- Grand Total -->
                    <div class="grand-total">
                        <div class="grand-total-label">üí∞ TOTAL ESTIMATED BUDGET</div>
                        <div class="grand-total-value" id="grand-total">¬£0.00</div>
                    </div>
                </div>

                <!-- Spend Tracking Tab -->
                <div id="tracking-tab" class="tab-content">
                    <!-- Search Bar -->
                    <div class="search-bar">
                        <input type="text" class="search-input" placeholder="Search expenses..." id="search-expenses" onkeyup="searchExpenses()">
                        <input type="date" class="form-input" id="expense-date-filter" style="width: 200px;">
                        <button class="filter-btn" onclick="filterExpenses()">üîΩ Filter</button>
                    </div>

                    <div class="budget-section">
                        <div class="budget-section-header">
                            <div class="section-title">
                                <span class="section-icon">üìä</span>
                                Expense Tracking
                            </div>
                            <div class="section-actions">
                                <button class="icon-btn" onclick="openExpenseModal()">+ Add Expense</button>
                                <button class="icon-btn" onclick="importReceipts()">üì∑ Import Receipt</button>
                            </div>
                        </div>
                        <table class="category-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Item</th>
                                    <th>Category</th>
                                    <th>Supplier</th>
                                    <th>Receipt</th>
                                    <th>Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="expense-list">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                        <div class="category-total">
                            <span class="total-label">Total Expenses</span>
                            <span class="total-value" id="total-expenses">¬£0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Budget vs Actual Comparison Tab -->
                <div id="comparison-tab" class="tab-content">
                    <div class="budget-section">
                        <div class="budget-section-header">
                            <div class="section-title">
                                <span class="section-icon">‚öñÔ∏è</span>
                                Budget vs Actual Comparison
                            </div>
                            <div class="section-actions">
                                <button class="icon-btn" onclick="exportComparison()">üì§ Export Report</button>
                            </div>
                        </div>
                        <table class="comparison-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Budgeted</th>
                                    <th>Actual Spent</th>
                                    <th>Variance (¬£)</th>
                                    <th>Variance (%)</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="comparison-table-body">
                                <!-- Dynamic content -->
                            </tbody>
                            <tfoot style="background: rgba(201, 169, 97, 0.05); font-weight: 600;">
                                <tr>
                                    <td style="padding: 16px 12px;">TOTAL</td>
                                    <td id="comp-total-budget">¬£0.00</td>
                                    <td id="comp-total-actual">¬£0.00</td>
                                    <td id="comp-total-variance">¬£0.00</td>
                                    <td id="comp-total-variance-percent">0%</td>
                                    <td id="comp-total-status">-</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Variance Analysis -->
                    <div class="budget-section">
                        <div class="budget-section-header">
                            <div class="section-title">
                                <span class="section-icon">üìà</span>
                                Variance Analysis
                            </div>
                        </div>
                        <div style="padding: 24px;">
                            <div id="variance-analysis">
                                <!-- Dynamic analysis content -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Load Budget Template</div>
                <button class="modal-close" onclick="closeModal('templateModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select Template</label>
                    <select class="form-select" id="template-select">
                        <option value="feature">Basic Feature Film (4 weeks)</option>
                        <option value="tv">TV Series Episode Budget</option>
                        <option value="commercial">Commercial Shoot (1-3 days)</option>
                        <option value="period">Period Drama Budget</option>
                        <option value="horror">Horror/SFX Heavy Budget</option>
                        <option value="indie">Low Budget Indie Film</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <p style="color: var(--text-muted); font-size: 0.875em; line-height: 1.5;" id="template-description">
                        Standard feature film budget template for a 4-week shoot. Includes basic disposables, hygiene supplies, and common beauty products. Customize as needed for your specific production requirements.
                    </p>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="merge-template"> Merge with existing budget (don't replace)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('templateModal')">Cancel</button>
                <button class="btn primary" onclick="loadTemplate()">Load Template</button>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add Expense</div>
                <button class="modal-close" onclick="closeModal('expenseModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" id="expense-date" value="">
                </div>
                <div class="form-group">
                    <label class="form-label">Item Description</label>
                    <input type="text" class="form-input" id="expense-item" placeholder="Enter item description">
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="expense-category">
                        <option value="disposables">Disposables</option>
                        <option value="hygiene">Hygiene & Sanitation</option>
                        <option value="consumables">Everyday Consumables</option>
                        <option value="beauty">Beauty Products</option>
                        <option value="sfx">Special Effects</option>
                        <option value="hair">Hair Products</option>
                        <option value="tools">Tools & Equipment</option>
                        <option value="custom">Custom Builds / Fabrication</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Supplier</label>
                    <input type="text" class="form-input" id="expense-supplier" placeholder="Enter supplier name" list="supplier-list">
                    <datalist id="supplier-list">
                        <option value="Amazon">
                        <option value="Boots">
                        <option value="MAC">
                        <option value="Superdrug">
                        <option value="Sally's">
                        <option value="Charles Fox">
                        <option value="Screenface">
                        <option value="Kryolan">
                        <option value="Pharmacy">
                    </datalist>
                </div>
                <div class="form-group">
                    <label class="form-label">Amount (¬£)</label>
                    <input type="number" class="form-input" id="expense-amount" placeholder="0.00" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label">Receipt Number</label>
                    <input type="text" class="form-input" id="expense-receipt" placeholder="Optional receipt/invoice number">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="notes-input" id="expense-notes" placeholder="Additional notes..." rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('expenseModal')">Cancel</button>
                <button class="btn primary" onclick="saveExpense()">Add Expense</button>
            </div>
        </div>
    </div>

    <!-- Quick Actions FAB -->
    <div class="quick-actions">
        <div class="fab-menu" id="fab-menu">
            <div class="fab-item" onclick="quickAddItem()">‚ûï Quick Add Item</div>
            <div class="fab-item" onclick="quickAddExpense()">üí≥ Quick Expense</div>
            <div class="fab-item" onclick="duplicateLastItem()">üìë Duplicate Last</div>
            <div class="fab-item" onclick="clearAll()">üóëÔ∏è Clear All</div>
        </div>
        <button class="fab" onclick="toggleFab()">+</button>
    </div>

    <script>
        // Enhanced Budget Management System
        class BudgetManager {
            constructor() {
                this.data = {
                    projectInfo: {
                        name: 'The Big Race',
                        code: 'HM-2025-001',
                        designer: '',
                        type: 'Feature Film',
                        duration: '4 weeks',
                        budgetLimit: 0
                    },
                    categories: {
                        disposables: { icon: 'üì¶', name: 'Disposables', items: [] },
                        hygiene: { icon: 'üßº', name: 'Hygiene & Sanitation', items: [] },
                        consumables: { icon: 'üõçÔ∏è', name: 'Everyday Consumables', items: [] },
                        beauty: { icon: 'üíÑ', name: 'Beauty Products', items: [] },
                        sfx: { icon: 'üé≠', name: 'Special Effects', items: [] },
                        hair: { icon: '‚úÇÔ∏è', name: 'Hair Products', items: [] },
                        tools: { icon: 'üîß', name: 'Tools & Equipment', items: [] },
                        custom: { icon: 'üõ†Ô∏è', name: 'Custom Builds / Fabrication', items: [] }
                    },
                    expenses: [],
                    templates: {},
                    history: [],
                    lastSaved: null
                };
                
                this.init();
            }

            init() {
                this.loadFromStorage();
                this.setupEventListeners();
                this.renderCategories();
                this.updateAllCalculations();
                this.setTodayDate();
            }

            setupEventListeners() {
                // Project info changes
                ['project-name', 'project-code', 'designer-name', 'project-type', 'project-duration', 'budget-limit'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('change', () => this.saveProjectInfo());
                    }
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case 's':
                                e.preventDefault();
                                this.save();
                                break;
                            case 'z':
                                e.preventDefault();
                                this.undo();
                                break;
                            case 'y':
                                e.preventDefault();
                                this.redo();
                                break;
                        }
                    }
                });

                // Auto-save every 30 seconds
                setInterval(() => this.autoSave(), 30000);
            }

            renderCategories() {
                const container = document.getElementById('category-sections');
                if (!container) return;

                container.innerHTML = '';
                
                Object.keys(this.data.categories).forEach(key => {
                    const category = this.data.categories[key];
                    const section = this.createCategorySection(key, category);
                    container.appendChild(section);
                });
            }

            createCategorySection(key, category) {
                const section = document.createElement('div');
                section.className = 'budget-section';
                section.innerHTML = `
                    <div class="budget-section-header">
                        <div class="section-title">
                            <span class="section-icon">${category.icon}</span>
                            ${category.name}
                        </div>
                        <div class="section-actions">
                            <button class="icon-btn" onclick="budgetManager.addItem('${key}')">+ Add Item</button>
                            <button class="icon-btn" onclick="budgetManager.clearCategory('${key}')">Clear</button>
                        </div>
                    </div>
                    <div id="${key}-items">
                        ${category.items.length === 0 ? this.getEmptyState(category) : ''}
                    </div>
                    <div class="category-total">
                        <span class="total-label">Category Total</span>
                        <span class="total-value" id="${key}-total">¬£0.00</span>
                    </div>
                `;

                // Render existing items
                if (category.items.length > 0) {
                    const itemsContainer = section.querySelector(`#${key}-items`);
                    category.items.forEach((item, index) => {
                        itemsContainer.appendChild(this.createItemRow(key, item, index));
                    });
                }

                return section;
            }

            createItemRow(categoryKey, item = {}, index) {
                const row = document.createElement('div');
                row.className = 'input-row';
                row.dataset.category = categoryKey;
                row.dataset.index = index;
                
                row.innerHTML = `
                    <input type="text" class="form-input item-description" 
                           placeholder="Item description" 
                           value="${item.description || ''}"
                           onchange="budgetManager.updateItem('${categoryKey}', ${index}, 'description', this.value)">
                    <input type="number" class="form-input item-qty" 
                           placeholder="Qty" 
                           value="${item.qty || 1}" 
                           min="0"
                           onchange="budgetManager.updateItem('${categoryKey}', ${index}, 'qty', this.value)">
                    <input type="number" class="form-input item-price" 
                           placeholder="Unit Price" 
                           value="${item.price || 0}" 
                           step="0.01" 
                           min="0"
                           onchange="budgetManager.updateItem('${categoryKey}', ${index}, 'price', this.value)">
                    <input type="number" class="form-input item-markup" 
                           placeholder="Markup %" 
                           value="${item.markup || 0}" 
                           step="1" 
                           min="0"
                           onchange="budgetManager.updateItem('${categoryKey}', ${index}, 'markup', this.value)">
                    <div class="calculated-value">${this.formatCurrency(this.calculateItemTotal(item))}</div>
                    <select class="supplier-select"
                            onchange="budgetManager.updateItem('${categoryKey}', ${index}, 'supplier', this.value)">
                        <option value="">Select Supplier</option>
                        <option value="Amazon" ${item.supplier === 'Amazon' ? 'selected' : ''}>Amazon</option>
                        <option value="Boots" ${item.supplier === 'Boots' ? 'selected' : ''}>Boots</option>
                        <option value="MAC" ${item.supplier === 'MAC' ? 'selected' : ''}>MAC</option>
                        <option value="Superdrug" ${item.supplier === 'Superdrug' ? 'selected' : ''}>Superdrug</option>
                        <option value="Sally's" ${item.supplier === "Sally's" ? 'selected' : ''}>Sally's</option>
                        <option value="Charles Fox" ${item.supplier === 'Charles Fox' ? 'selected' : ''}>Charles Fox</option>
                        <option value="Other" ${item.supplier === 'Other' ? 'selected' : ''}>Other</option>
                    </select>
                    <input type="text" class="notes-input" 
                           placeholder="Notes..." 
                           value="${item.notes || ''}"
                           onchange="budgetManager.updateItem('${categoryKey}', ${index}, 'notes', this.value)">
                    <button class="delete-btn" onclick="budgetManager.removeItem('${categoryKey}', ${index})">√ó</button>
                `;

                return row;
            }

            getEmptyState(category) {
                return `
                    <div class="empty-state">
                        <div class="empty-icon">${category.icon}</div>
                        <div class="empty-title">No items added yet</div>
                        <div class="empty-desc">Click "Add Item" to start building your budget</div>
                    </div>
                `;
            }

            addItem(categoryKey) {
                const category = this.data.categories[categoryKey];
                if (!category) return;

                const newItem = {
                    description: '',
                    qty: 1,
                    price: 0,
                    markup: 0,
                    supplier: '',
                    notes: '',
                    id: Date.now()
                };

                category.items.push(newItem);

                // Remove empty state if exists
                const container = document.getElementById(`${categoryKey}-items`);
                const emptyState = container.querySelector('.empty-state');
                if (emptyState) emptyState.remove();

                // Add new row
                const newRow = this.createItemRow(categoryKey, newItem, category.items.length - 1);
                container.appendChild(newRow);

                // Focus on description
                newRow.querySelector('.item-description').focus();

                this.updateCategoryTotal(categoryKey);
                this.updateGrandTotal();
                this.save();
            }

            updateItem(categoryKey, index, field, value) {
                const category = this.data.categories[categoryKey];
                if (!category || !category.items[index]) return;

                // Convert values to appropriate types
                if (field === 'qty' || field === 'price' || field === 'markup') {
                    value = parseFloat(value) || 0;
                }

                category.items[index][field] = value;

                // Update row total
                const row = document.querySelector(`[data-category="${categoryKey}"][data-index="${index}"]`);
                if (row) {
                    const totalEl = row.querySelector('.calculated-value');
                    if (totalEl) {
                        totalEl.textContent = this.formatCurrency(this.calculateItemTotal(category.items[index]));
                    }
                }

                this.updateCategoryTotal(categoryKey);
                this.updateGrandTotal();
                this.save();
            }

            removeItem(categoryKey, index) {
                const category = this.data.categories[categoryKey];
                if (!category || !category.items[index]) return;

                if (confirm('Are you sure you want to remove this item?')) {
                    category.items.splice(index, 1);
                    this.renderCategories();
                    this.updateAllCalculations();
                    this.save();
                }
            }

            clearCategory(categoryKey) {
                if (confirm(`Clear all items in ${this.data.categories[categoryKey].name}?`)) {
                    this.data.categories[categoryKey].items = [];
                    this.renderCategories();
                    this.updateAllCalculations();
                    this.save();
                }
            }

            calculateItemTotal(item) {
                if (!item) return 0;
                const baseTotal = (item.qty || 0) * (item.price || 0);
                const markupAmount = baseTotal * ((item.markup || 0) / 100);
                return baseTotal + markupAmount;
            }

            updateCategoryTotal(categoryKey) {
                const category = this.data.categories[categoryKey];
                if (!category) return 0;

                const total = category.items.reduce((sum, item) => sum + this.calculateItemTotal(item), 0);
                
                const totalEl = document.getElementById(`${categoryKey}-total`);
                if (totalEl) {
                    totalEl.textContent = this.formatCurrency(total);
                }

                return total;
            }

            updateGrandTotal() {
                let grandTotal = 0;
                Object.keys(this.data.categories).forEach(key => {
                    grandTotal += this.updateCategoryTotal(key);
                });

                document.getElementById('grand-total').textContent = this.formatCurrency(grandTotal);
                document.getElementById('sidebar-total').textContent = this.formatCurrency(grandTotal);
                
                return grandTotal;
            }

            updateAllCalculations() {
                const grandTotal = this.updateGrandTotal();
                const totalExpenses = this.calculateTotalExpenses();
                const remaining = grandTotal - totalExpenses;
                
                // Update overview
                this.updateOverview(grandTotal, totalExpenses, remaining);
                
                // Update comparison
                this.updateComparison();
                
                // Update item count
                let itemCount = 0;
                Object.values(this.data.categories).forEach(cat => {
                    itemCount += cat.items.length;
                });
                document.getElementById('sidebar-items').textContent = itemCount;
            }

            updateOverview(budget, spent, remaining) {
                document.getElementById('overview-total-budget').textContent = this.formatCurrency(budget);
                document.getElementById('overview-spent').textContent = this.formatCurrency(spent);
                document.getElementById('overview-remaining').textContent = this.formatCurrency(remaining);
                
                const spentPercent = budget > 0 ? (spent / budget * 100).toFixed(1) : 0;
                const remainingPercent = budget > 0 ? (remaining / budget * 100).toFixed(1) : 0;
                
                document.getElementById('overview-spent-percent').textContent = spentPercent + '%';
                document.getElementById('overview-remaining-percent').textContent = remainingPercent + '%';
                
                // Update progress bar
                document.getElementById('progress-percent').textContent = spentPercent + '% Used';
                const progressBar = document.getElementById('progress-bar');
                progressBar.style.width = spentPercent + '%';
                
                // Update progress bar color
                progressBar.classList.remove('warning', 'danger');
                if (spentPercent > 90) {
                    progressBar.classList.add('danger');
                } else if (spentPercent > 75) {
                    progressBar.classList.add('warning');
                }

                // Update variance
                const variance = spent - budget;
                document.getElementById('overview-variance').textContent = this.formatCurrency(Math.abs(variance));
                
                const varianceStatus = document.getElementById('overview-variance-status');
                if (variance > 0) {
                    varianceStatus.innerHTML = '<span style="color: var(--danger)">Over budget</span>';
                    varianceStatus.className = 'stat-change negative';
                } else if (variance < 0) {
                    varianceStatus.innerHTML = '<span style="color: var(--success)">Under budget</span>';
                    varianceStatus.className = 'stat-change positive';
                } else {
                    varianceStatus.innerHTML = '<span>On budget</span>';
                    varianceStatus.className = 'stat-change';
                }

                // Update category breakdown
                this.updateCategoryBreakdown();
            }

            updateCategoryBreakdown() {
                const tbody = document.getElementById('overview-categories');
                if (!tbody) return;

                tbody.innerHTML = '';
                
                Object.keys(this.data.categories).forEach(key => {
                    const category = this.data.categories[key];
                    const budgeted = category.items.reduce((sum, item) => sum + this.calculateItemTotal(item), 0);
                    const spent = this.getCategoryExpenses(key);
                    const remaining = budgeted - spent;
                    const variance = spent - budgeted;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span>${category.icon}</span>
                                <span>${category.name}</span>
                            </div>
                        </td>
                        <td>${this.formatCurrency(budgeted)}</td>
                        <td>${this.formatCurrency(spent)}</td>
                        <td>${this.formatCurrency(remaining)}</td>
                        <td>
                            ${this.getVarianceBadge(variance)}
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }

            getCategoryExpenses(categoryKey) {
                return this.data.expenses
                    .filter(exp => exp.category === categoryKey)
                    .reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
            }

            getVarianceBadge(variance) {
                if (variance > 0) {
                    return `<span class="variance negative">+${this.formatCurrency(variance)}</span>`;
                } else if (variance < 0) {
                    return `<span class="variance positive">${this.formatCurrency(variance)}</span>`;
                } else {
                    return `<span class="variance neutral">¬£0.00</span>`;
                }
            }

            updateComparison() {
                const tbody = document.getElementById('comparison-table-body');
                if (!tbody) return;

                tbody.innerHTML = '';
                let totalBudget = 0;
                let totalActual = 0;
                
                Object.keys(this.data.categories).forEach(key => {
                    const category = this.data.categories[key];
                    const budgeted = category.items.reduce((sum, item) => sum + this.calculateItemTotal(item), 0);
                    const actual = this.getCategoryExpenses(key);
                    const variance = actual - budgeted;
                    const variancePercent = budgeted > 0 ? (variance / budgeted * 100) : 0;
                    
                    totalBudget += budgeted;
                    totalActual += actual;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span>${category.icon}</span>
                                <span>${category.name}</span>
                            </div>
                        </td>
                        <td>${this.formatCurrency(budgeted)}</td>
                        <td>${this.formatCurrency(actual)}</td>
                        <td>${this.formatCurrency(variance)}</td>
                        <td>${variancePercent.toFixed(1)}%</td>
                        <td>${this.getStatusBadge(variance, budgeted)}</td>
                    `;
                    
                    tbody.appendChild(row);
                });

                // Update totals
                const totalVariance = totalActual - totalBudget;
                const totalVariancePercent = totalBudget > 0 ? (totalVariance / totalBudget * 100) : 0;
                
                document.getElementById('comp-total-budget').textContent = this.formatCurrency(totalBudget);
                document.getElementById('comp-total-actual').textContent = this.formatCurrency(totalActual);
                document.getElementById('comp-total-variance').textContent = this.formatCurrency(totalVariance);
                document.getElementById('comp-total-variance-percent').textContent = totalVariancePercent.toFixed(1) + '%';
                document.getElementById('comp-total-status').innerHTML = this.getStatusBadge(totalVariance, totalBudget);

                // Update variance analysis
                this.updateVarianceAnalysis(totalBudget, totalActual, totalVariance);
            }

            updateVarianceAnalysis(budget, actual, variance) {
                const container = document.getElementById('variance-analysis');
                if (!container) return;

                const percentSpent = budget > 0 ? (actual / budget * 100).toFixed(1) : 0;
                const status = variance > 0 ? 'over budget' : variance < 0 ? 'under budget' : 'on budget';
                
                container.innerHTML = `
                    <div style="display: grid; gap: 16px;">
                        <div>
                            <strong>Summary:</strong> The project is currently ${status} by ${this.formatCurrency(Math.abs(variance))} 
                            (${Math.abs((variance / budget * 100).toFixed(1))}%).
                        </div>
                        <div>
                            <strong>Budget Utilization:</strong> ${percentSpent}% of the total budget has been spent.
                        </div>
                        <div>
                            <strong>Top Variance Categories:</strong>
                            <ul style="margin-top: 8px; padding-left: 20px;">
                                ${this.getTopVariances()}
                            </ul>
                        </div>
                        <div>
                            <strong>Recommendations:</strong>
                            <ul style="margin-top: 8px; padding-left: 20px;">
                                ${this.getRecommendations(variance, budget)}
                            </ul>
                        </div>
                    </div>
                `;
            }

            getTopVariances() {
                const variances = [];
                Object.keys(this.data.categories).forEach(key => {
                    const category = this.data.categories[key];
                    const budgeted = category.items.reduce((sum, item) => sum + this.calculateItemTotal(item), 0);
                    const actual = this.getCategoryExpenses(key);
                    const variance = actual - budgeted;
                    
                    if (Math.abs(variance) > 0) {
                        variances.push({ name: category.name, variance, budgeted });
                    }
                });

                variances.sort((a, b) => Math.abs(b.variance) - Math.abs(a.variance));
                
                return variances.slice(0, 3)
                    .map(v => `<li>${v.name}: ${v.variance > 0 ? 'Over' : 'Under'} by ${this.formatCurrency(Math.abs(v.variance))}</li>`)
                    .join('');
            }

            getRecommendations(variance, budget) {
                const recommendations = [];
                
                if (variance > budget * 0.1) {
                    recommendations.push('Review and reduce non-essential expenses immediately');
                    recommendations.push('Consider renegotiating supplier contracts');
                } else if (variance > 0) {
                    recommendations.push('Monitor spending closely to prevent further overruns');
                    recommendations.push('Identify areas for cost optimization');
                } else if (variance < -budget * 0.2) {
                    recommendations.push('Consider reallocating unused budget to quality improvements');
                    recommendations.push('Review if all necessary items have been accounted for');
                } else {
                    recommendations.push('Continue current spending patterns');
                    recommendations.push('Maintain regular budget reviews');
                }
                
                return recommendations.map(r => `<li>${r}</li>`).join('');
            }

            getStatusBadge(variance, budget) {
                const percent = budget > 0 ? Math.abs(variance / budget * 100) : 0;
                
                if (variance > budget * 0.1) {
                    return '<span class="variance negative">‚ö†Ô∏è Over</span>';
                } else if (variance > 0) {
                    return '<span class="variance warning">‚ö† Slightly Over</span>';
                } else if (variance < -budget * 0.2) {
                    return '<span class="variance positive">‚úì Under</span>';
                } else {
                    return '<span class="variance neutral">‚úì On Track</span>';
                }
            }

            saveProjectInfo() {
                this.data.projectInfo.name = document.getElementById('project-name').value;
                this.data.projectInfo.code = document.getElementById('project-code').value;
                this.data.projectInfo.designer = document.getElementById('designer-name').value;
                this.data.projectInfo.type = document.getElementById('project-type').value;
                this.data.projectInfo.duration = document.getElementById('project-duration').value;
                this.data.projectInfo.budgetLimit = parseFloat(document.getElementById('budget-limit').value) || 0;

                // Update display
                document.getElementById('project-name-display').textContent = this.data.projectInfo.name;
                document.getElementById('project-code-display').textContent = this.data.projectInfo.code;

                this.save();
            }

            addExpense(expense) {
                expense.id = Date.now();
                expense.date = expense.date || new Date().toISOString().split('T')[0];
                this.data.expenses.push(expense);
                this.renderExpenses();
                this.updateAllCalculations();
                this.save();
            }

            renderExpenses() {
                const tbody = document.getElementById('expense-list');
                if (!tbody) return;

                tbody.innerHTML = '';
                
                const sortedExpenses = [...this.data.expenses].sort((a, b) => 
                    new Date(b.date) - new Date(a.date)
                );

                sortedExpenses.forEach(expense => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${expense.date}</td>
                        <td>
                            <div class="item-name">${expense.item}</div>
                            ${expense.notes ? `<div class="item-desc">${expense.notes}</div>` : ''}
                        </td>
                        <td>${this.data.categories[expense.category]?.name || expense.category}</td>
                        <td><span class="supplier-tag">${expense.supplier || '-'}</span></td>
                        <td>${expense.receipt || '-'}</td>
                        <td>${this.formatCurrency(expense.amount)}</td>
                        <td>
                            <button class="delete-btn" onclick="budgetManager.deleteExpense(${expense.id})">√ó</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                document.getElementById('total-expenses').textContent = 
                    this.formatCurrency(this.calculateTotalExpenses());
            }

            deleteExpense(id) {
                if (confirm('Delete this expense?')) {
                    this.data.expenses = this.data.expenses.filter(e => e.id !== id);
                    this.renderExpenses();
                    this.updateAllCalculations();
                    this.save();
                }
            }

            calculateTotalExpenses() {
                return this.data.expenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
            }

            formatCurrency(amount) {
                return '¬£' + (parseFloat(amount) || 0).toFixed(2);
            }

            save() {
                this.data.lastSaved = new Date().toISOString();
                localStorage.setItem('hmBudgetPro', JSON.stringify(this.data));
                
                // Update last saved display
                const now = new Date();
                document.getElementById('sidebar-saved').textContent = 
                    `${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
                
                this.showNotification('Budget saved', 'success');
            }

            autoSave() {
                if (this.hasChanges()) {
                    this.save();
                }
            }

            hasChanges() {
                const current = JSON.stringify(this.data);
                const saved = localStorage.getItem('hmBudgetPro');
                return current !== saved;
            }

            loadFromStorage() {
                const saved = localStorage.getItem('hmBudgetPro');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        this.data = { ...this.data, ...data };
                        
                        // Restore project info
                        if (this.data.projectInfo) {
                            document.getElementById('project-name').value = this.data.projectInfo.name || '';
                            document.getElementById('project-code').value = this.data.projectInfo.code || '';
                            document.getElementById('designer-name').value = this.data.projectInfo.designer || '';
                            document.getElementById('project-type').value = this.data.projectInfo.type || '';
                            document.getElementById('project-duration').value = this.data.projectInfo.duration || '';
                            document.getElementById('budget-limit').value = this.data.projectInfo.budgetLimit || '';
                            
                            document.getElementById('project-name-display').textContent = this.data.projectInfo.name;
                            document.getElementById('project-code-display').textContent = this.data.projectInfo.code;
                        }

                        // Update last saved
                        if (this.data.lastSaved) {
                            const saved = new Date(this.data.lastSaved);
                            document.getElementById('sidebar-saved').textContent = 
                                `${saved.toLocaleDateString()} ${saved.toLocaleTimeString()}`;
                        }

                        this.renderExpenses();
                    } catch (e) {
                        console.error('Error loading data:', e);
                    }
                }
            }

            exportData(format = 'json') {
                const data = {
                    projectInfo: this.data.projectInfo,
                    categories: this.data.categories,
                    expenses: this.data.expenses,
                    exported: new Date().toISOString()
                };

                if (format === 'json') {
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    this.downloadFile(blob, `budget_${this.data.projectInfo.code}_${Date.now()}.json`);
                } else if (format === 'csv') {
                    const csv = this.convertToCSV(data);
                    const blob = new Blob([csv], { type: 'text/csv' });
                    this.downloadFile(blob, `budget_${this.data.projectInfo.code}_${Date.now()}.csv`);
                }

                this.showNotification('Budget exported successfully', 'success');
            }

            convertToCSV(data) {
                let csv = 'Category,Item,Quantity,Unit Price,Markup %,Total,Supplier,Notes\n';
                
                Object.keys(data.categories).forEach(key => {
                    const category = data.categories[key];
                    category.items.forEach(item => {
                        csv += `"${category.name}","${item.description}",${item.qty},${item.price},${item.markup},${this.calculateItemTotal(item)},"${item.supplier || ''}","${item.notes || ''}"\n`;
                    });
                });

                return csv;
            }

            downloadFile(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            setTodayDate() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('expense-date').value = today;
            }
        }

        // Initialize Budget Manager
        const budgetManager = new BudgetManager();

        // Global functions
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');

            // Update calculations when switching tabs
            budgetManager.updateAllCalculations();
        }

        function saveBudget() {
            budgetManager.save();
        }

        function exportBudget() {
            const format = prompt('Export format: json or csv?', 'json');
            if (format) {
                budgetManager.exportData(format.toLowerCase());
            }
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,.csv';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (confirm('This will replace your current budget. Continue?')) {
                            budgetManager.data = { ...budgetManager.data, ...data };
                            budgetManager.renderCategories();
                            budgetManager.renderExpenses();
                            budgetManager.updateAllCalculations();
                            budgetManager.save();
                            budgetManager.showNotification('Data imported successfully', 'success');
                        }
                    } catch (e) {
                        budgetManager.showNotification('Error importing data', 'danger');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function openTemplateModal() {
            document.getElementById('templateModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function loadTemplate() {
            const templateType = document.getElementById('template-select').value;
            const merge = document.getElementById('merge-template').checked;

            const templates = {
                feature: {
                    disposables: [
                        { description: 'Mascara Wands (Pack of 100)', qty: 3, price: 8.00, supplier: 'Amazon' },
                        { description: 'Cotton Pads (Pack of 200)', qty: 4, price: 4.50, supplier: 'Boots' },
                        { description: 'Cotton Buds (Pack of 200)', qty: 3, price: 3.00, supplier: 'Boots' },
                        { description: 'Tissues (Box)', qty: 5, price: 2.50, supplier: 'Superdrug' }
                    ],
                    hygiene: [
                        { description: 'Isopropyl Alcohol 99% (1L)', qty: 3, price: 12.00, supplier: 'Pharmacy' },
                        { description: 'Brush Cleaner (250ml)', qty: 2, price: 15.00, supplier: 'MAC' }
                    ],
                    beauty: [
                        { description: 'Foundation Set (Various Shades)', qty: 1, price: 250.00, supplier: 'MAC' },
                        { description: 'Concealer Palette', qty: 2, price: 45.00, supplier: 'Charles Fox' },
                        { description: 'Powder Set', qty: 1, price: 85.00, supplier: 'Kryolan' }
                    ]
                },
                horror: {
                    sfx: [
                        { description: 'Liquid Latex (1L)', qty: 3, price: 25.00, supplier: 'Screenface' },
                        { description: 'Scar Wax', qty: 5, price: 12.00, supplier: 'Kryolan' },
                        { description: 'Stage Blood (1L)', qty: 2, price: 18.00, supplier: 'Charles Fox' },
                        { description: 'Gelatin (1kg)', qty: 2, price: 35.00, supplier: 'Screenface' }
                    ]
                }
            };

            const selectedTemplate = templates[templateType] || templates.feature;

            if (!merge) {
                // Clear existing items
                Object.keys(budgetManager.data.categories).forEach(key => {
                    budgetManager.data.categories[key].items = [];
                });
            }

            // Add template items
            Object.keys(selectedTemplate).forEach(categoryKey => {
                if (budgetManager.data.categories[categoryKey]) {
                    selectedTemplate[categoryKey].forEach(item => {
                        budgetManager.data.categories[categoryKey].items.push({
                            ...item,
                            markup: 0,
                            notes: '',
                            id: Date.now() + Math.random()
                        });
                    });
                }
            });

            budgetManager.renderCategories();
            budgetManager.updateAllCalculations();
            budgetManager.save();
            closeModal('templateModal');
            budgetManager.showNotification('Template loaded successfully', 'success');
        }

        function openExpenseModal() {
            document.getElementById('expenseModal').classList.add('active');
        }

        function saveExpense() {
            const expense = {
                date: document.getElementById('expense-date').value,
                item: document.getElementById('expense-item').value,
                category: document.getElementById('expense-category').value,
                supplier: document.getElementById('expense-supplier').value,
                amount: parseFloat(document.getElementById('expense-amount').value) || 0,
                receipt: document.getElementById('expense-receipt').value,
                notes: document.getElementById('expense-notes').value
            };

            if (!expense.item || !expense.amount) {
                budgetManager.showNotification('Please fill in required fields', 'warning');
                return;
            }

            budgetManager.addExpense(expense);
            closeModal('expenseModal');

            // Clear form
            document.getElementById('expense-item').value = '';
            document.getElementById('expense-amount').value = '';
            document.getElementById('expense-supplier').value = '';
            document.getElementById('expense-receipt').value = '';
            document.getElementById('expense-notes').value = '';
        }

        function searchItems() {
            const query = document.getElementById('search-items').value.toLowerCase();
            
            document.querySelectorAll('.input-row').forEach(row => {
                const description = row.querySelector('.item-description')?.value.toLowerCase() || '';
                const notes = row.querySelector('.notes-input')?.value.toLowerCase() || '';
                
                if (description.includes(query) || notes.includes(query)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function searchExpenses() {
            const query = document.getElementById('search-expenses').value.toLowerCase();
            
            document.querySelectorAll('#expense-list tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        }

        function toggleFab() {
            document.getElementById('fab-menu').classList.toggle('active');
        }

        function quickAddItem() {
            const category = prompt('Enter category key (disposables, hygiene, consumables, beauty, sfx, hair, tools, custom):');
            if (category && budgetManager.data.categories[category]) {
                budgetManager.addItem(category);
                toggleFab();
            }
        }

        function quickAddExpense() {
            openExpenseModal();
            toggleFab();
        }

        function duplicateLastItem() {
            // Find the last added item
            let lastItem = null;
            let lastCategory = null;
            
            Object.keys(budgetManager.data.categories).forEach(key => {
                const items = budgetManager.data.categories[key].items;
                if (items.length > 0) {
                    lastItem = items[items.length - 1];
                    lastCategory = key;
                }
            });

            if (lastItem && lastCategory) {
                const duplicate = { ...lastItem, id: Date.now() };
                budgetManager.data.categories[lastCategory].items.push(duplicate);
                budgetManager.renderCategories();
                budgetManager.updateAllCalculations();
                budgetManager.save();
                budgetManager.showNotification('Item duplicated', 'success');
            }
            
            toggleFab();
        }

        function clearAll() {
            if (confirm('This will clear ALL budget data. Are you sure?')) {
                Object.keys(budgetManager.data.categories).forEach(key => {
                    budgetManager.data.categories[key].items = [];
                });
                budgetManager.data.expenses = [];
                budgetManager.renderCategories();
                budgetManager.renderExpenses();
                budgetManager.updateAllCalculations();
                budgetManager.save();
                budgetManager.showNotification('All data cleared', 'info');
            }
            toggleFab();
        }

        function refreshOverview() {
            budgetManager.updateAllCalculations();
            budgetManager.showNotification('Overview refreshed', 'success');
        }

        function exportComparison() {
            budgetManager.exportData('csv');
        }

        function importReceipts() {
            budgetManager.showNotification('Receipt import feature coming soon!', 'info');
        }

        function filterExpenses() {
            const dateFilter = document.getElementById('expense-date-filter').value;
            
            document.querySelectorAll('#expense-list tr').forEach(row => {
                const date = row.cells[0].textContent;
                if (!dateFilter || date === dateFilter) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function filterByCategory() {
            budgetManager.showNotification('Category filter coming soon!', 'info');
        }

        function sortItems() {
            budgetManager.showNotification('Sort feature coming soon!', 'info');
        }
    </script>
</body>
</html>
