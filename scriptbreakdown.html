<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Script Breakdown - AI Enhanced</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="script-processor-enhanced.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-dark: #0a0908;
            --bg-medium: rgba(18, 16, 14, 0.85);
            --card-bg: rgba(28, 25, 22, 0.5);
            --text-light: #e8e6e3;
            --text-muted: #9a8f7f;
            --accent-gold: #d4af7a;
            --accent-gold-hover: #e0c08f;
            --glass-border: rgba(255, 255, 255, 0.06);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --success: #52c186;
            --error: #ff6b6b;
            --tag-makeup: #ff6b9d;
            --tag-hair: #c084fc;
            --tag-sfx: #38bdf8;
            --tag-cast: #fbbf24;
            --tag-wardrobe: #34d399;
            --tag-props: #fb923c;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(13, 11, 10, 0.4); }
        ::-webkit-scrollbar-thumb { background: rgba(138, 127, 115, 0.3); border-radius: 4px; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #050404 0%, #0f0d0c 50%, #050404 100%);
            color: var(--text-light);
            height: 100vh;
            overflow: hidden;
        }
        .app-layout { display: flex; height: 100vh; flex-direction: column; }
        
        /* Top Bar */
        .top-bar {
            height: 60px;
            background: linear-gradient(135deg, rgba(212, 175, 122, 0.08) 0%, rgba(18, 16, 14, 0.85) 50%, rgba(212, 175, 122, 0.05) 100%);
            backdrop-filter: blur(24px);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }
        .back-link { display: flex; align-items: center; gap: 8px; color: var(--text-muted); cursor: pointer; font-size: 0.875em; }
        .back-link:hover { color: var(--accent-gold); }
        .page-title { font-size: 1.125em; font-weight: 600; }
        .toolbar-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8125em;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .toolbar-btn:hover { border-color: var(--accent-gold); color: var(--accent-gold); }
        .toolbar-btn.primary { background: var(--accent-gold); border-color: var(--accent-gold); color: #0a0908; font-weight: 600; }
        .toolbar-btn.ai { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-color: #667eea; color: white; font-weight: 600; }
        
        /* Layout */
        .main-content { display: flex; flex: 1; overflow: hidden; }
        .left-sidebar, .right-sidebar {
            width: 300px;
            background: linear-gradient(135deg, rgba(212, 175, 122, 0.06) 0%, rgba(18, 16, 14, 0.85) 50%, rgba(212, 175, 122, 0.03) 100%);
            backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .right-sidebar { width: 380px; }
        
        /* Sidebar Elements */
        .sidebar-header { padding: 16px 20px; border-bottom: 1px solid var(--glass-border); }
        .sidebar-title { font-size: 0.875em; font-weight: 600; text-transform: uppercase; color: var(--text-muted); margin-bottom: 12px; }
        .scene-search {
            width: 100%;
            padding: 10px 14px;
            background: rgba(10, 9, 8, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 0.8125em;
        }
        .scene-search:focus { outline: none; border-color: var(--accent-gold); }
        .scene-list { flex: 1; overflow-y: auto; padding: 12px; }
        .scene-item {
            background: rgba(28, 25, 22, 0.5);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .scene-item:hover { border-color: var(--accent-gold); transform: translateX(4px); }
        .scene-item.active { border-color: var(--accent-gold); background: rgba(201, 169, 97, 0.15); }
        .scene-number {
            width: 28px;
            height: 28px;
            background: var(--accent-gold);
            color: #0a0908;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.8125em;
            margin-bottom: 8px;
        }
        .scene-heading { font-size: 0.8125em; font-weight: 600; line-height: 1.3; }
        
        /* Center Panel */
        .center-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .script-toolbar {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 20px;
            background: var(--bg-medium);
            border-bottom: 1px solid var(--glass-border);
        }
        .tag-legend { display: flex; gap: 16px; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.75em; color: var(--text-muted); }
        .legend-color { width: 12px; height: 12px; border-radius: 3px; }
        .script-viewer { flex: 1; overflow-y: auto; padding: 40px; background: rgba(232, 230, 227, 0.03); }
        .script-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(248, 246, 240, 0.98);
            padding: 60px 80px;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }
        .script-content { font-family: 'Courier Prime', monospace; font-size: 12pt; line-height: 1.5; color: #000; user-select: text; }
        .script-scene { margin-bottom: 24px; page-break-inside: avoid; }
        .script-scene-heading { font-weight: 700; text-transform: uppercase; margin-bottom: 12px; color: #000; }
        .script-action { margin-bottom: 12px; color: #000; }
        .script-character { margin: 12px 0 4px; text-align: center; text-transform: uppercase; color: #000; }
        .script-dialogue { margin-bottom: 12px; width: 70%; margin-left: 15%; color: #000; }
        .script-parenthetical { margin-bottom: 4px; width: 60%; margin-left: 20%; color: #000; }
        .script-transition { text-align: right; margin: 20px 0; font-weight: 600; color: #000; }
        
        /* Right Sidebar - Tags Panel */
        .sidebar-tabs { display: flex; border-bottom: 1px solid var(--glass-border); }
        .sidebar-tab {
            flex: 1;
            padding: 16px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8125em;
            border-bottom: 2px solid transparent;
        }
        .sidebar-tab.active { color: var(--accent-gold); border-bottom-color: var(--accent-gold); }
        .tab-content { display: none; flex: 1; flex-direction: column; overflow: hidden; }
        .tab-content.active { display: flex; }
        
        /* Tagging Panel */
        .tagging-panel { flex: 1; overflow-y: auto; padding: 20px; }
        .ai-banner {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 0.8125em;
        }
        .tag-section { margin-bottom: 24px; }
        .tag-section-title {
            font-size: 0.875em;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tag-count { 
            background: rgba(201, 169, 97, 0.2); 
            padding: 2px 8px; 
            border-radius: 10px; 
            font-size: 0.75em; 
        }
        .tag-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
        .tag-item {
            background: rgba(28, 25, 22, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8125em;
        }
        .tag-item.ai-suggested { 
            border-color: rgba(102, 126, 234, 0.5); 
            background: rgba(102, 126, 234, 0.1); 
        }
        .tag-badge { 
            font-size: 0.65em; 
            padding: 3px 8px; 
            border-radius: 4px; 
            background: rgba(102, 126, 234, 0.2); 
            color: #667eea; 
            margin-right: 8px; 
        }
        .tag-actions { display: flex; gap: 4px; }
        .tag-action-btn {
            width: 24px;
            height: 24px;
            background: transparent;
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tag-action-btn.accept { border-color: var(--success); color: var(--success); }
        .tag-action-btn.reject { border-color: var(--error); color: var(--error); }
        .add-tag-btn {
            width: 100%;
            padding: 10px;
            background: rgba(28, 25, 22, 0.4);
            border: 1px dashed var(--glass-border);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8125em;
        }
        
        /* Notes Tab */
        .notes-content { flex: 1; padding: 20px; overflow-y: auto; }
        .notes-textarea {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            background: rgba(10, 9, 8, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 0.875em;
            font-family: 'Inter', sans-serif;
            resize: vertical;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 9, 8, 0.85);
            backdrop-filter: blur(12px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: rgba(18, 16, 14, 0.95);
            backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
        }
        .modal-title { font-size: 1.25em; font-weight: 600; margin-bottom: 8px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 0.875em; color: var(--text-muted); margin-bottom: 8px; }
        .form-input, .form-select {
            width: 100%;
            padding: 10px 14px;
            background: rgba(10, 9, 8, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 0.875em;
        }
        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }
        .modal-btn { 
            padding: 10px 20px; 
            border: 1px solid var(--glass-border); 
            border-radius: 8px; 
            cursor: pointer; 
            background: transparent; 
            color: var(--text-light); 
        }
        .modal-btn.primary { 
            background: var(--accent-gold); 
            border-color: var(--accent-gold); 
            color: #0a0908; 
            font-weight: 600; 
        }
        
        /* Debug Panel */
        .debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 16px;
            max-width: 400px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }
        .debug-panel.active { display: block; }
        .debug-title { font-weight: 600; margin-bottom: 8px; color: var(--accent-gold); }
        .debug-info { font-size: 0.75em; font-family: monospace; color: var(--text-muted); }
        
        /* Loading */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 9, 8, 0.9);
            backdrop-filter: blur(12px);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }
        .loading-overlay.active { display: flex; }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(212, 175, 122, 0.2);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            color: var(--text-muted);
            padding: 40px;
            font-size: 0.875em;
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <div class="top-bar">
            <div style="display: flex; align-items: center; gap: 24px;">
                <div onclick="goBack()" class="back-link">‚Üê Dashboard</div>
                <h1 class="page-title" id="projectTitle">Script Breakdown</h1>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="toolbar-btn" onclick="toggleDebug()">üêõ Debug</button>
                <button class="toolbar-btn" onclick="reprocessScript()">üîÑ Reload Script</button>
                <button class="toolbar-btn" onclick="openSettings()">‚öôÔ∏è Upload Script</button>
                <button class="toolbar-btn ai" onclick="runAIAnalysis()">ü§ñ AI Auto-Tag</button>
                <button class="toolbar-btn primary" onclick="generateBreakdown()">‚ú® Generate</button>
            </div>
        </div>
        <div class="main-content">
            <div class="left-sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">SCENES (<span id="sceneCount">1</span>)</div>
                    <input type="text" class="scene-search" placeholder="Search scenes..." id="sceneSearch">
                </div>
                <div class="scene-list" id="sceneList">
                    <!-- Scenes will be populated here -->
                </div>
            </div>
            <div class="center-panel">
                <div class="script-toolbar">
                    <div class="tag-legend">
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-makeup)"></div>Makeup</div>
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-hair)"></div>Hair</div>
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-sfx)"></div>SFX</div>
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-cast)"></div>Cast</div>
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-wardrobe)"></div>Wardrobe</div>
                        <div class="legend-item"><div class="legend-color" style="background: var(--tag-props)"></div>Props</div>
                    </div>
                </div>
                <div class="script-viewer">
                    <div class="script-container">
                        <div class="script-content" id="scriptContent">
                            <!-- Script content will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="right-sidebar">
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" onclick="switchTab('tags')">üè∑Ô∏è Tags</button>
                    <button class="sidebar-tab" onclick="switchTab('notes')">üìù Notes</button>
                </div>
                <div class="tab-content active" id="tagsTab">
                    <div class="tagging-panel" id="taggingPanel">
                        <div class="empty-state">Select a scene to view tags</div>
                    </div>
                </div>
                <div class="tab-content" id="notesTab">
                    <div class="notes-content">
                        <textarea class="notes-textarea" id="notesTextarea" placeholder="Enter scene notes..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-title">AI Settings</div>
            <div class="form-group">
                <label class="form-label">AI Provider</label>
                <select class="form-select" id="aiProvider">
                    <option value="openai">OpenAI (GPT-4)</option>
                    <option value="anthropic">Anthropic (Claude)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">API Key</label>
                <input type="password" class="form-input" id="apiKey" placeholder="Enter your API key">
            </div>
            <div class="modal-actions">
                <button class="modal-btn" onclick="closeSettings()">Cancel</button>
                <button class="modal-btn primary" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Debug Panel -->
    <div class="debug-panel" id="debugPanel">
        <div class="debug-title">üêõ Debug Info</div>
        <div class="debug-info" id="debugInfo"></div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div style="color: var(--text-light); font-weight: 600;" id="loadingText">Processing...</div>
    </div>

    <script>
        // Initialize PDF.js
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        // Global variables
        let currentProject = null;
        let scriptProcessor = null;
        let parsedScript = null;
        let currentScene = 0;
        let sceneTags = {};
        let sceneNotes = {};
        let apiKey = '';
        let aiProvider = 'openai';

        // Initialize
        async function init() {
            console.log('üöÄ Initializing Script Breakdown...');
            
            // Load API settings
            apiKey = localStorage.getItem('aiApiKey') || '';
            aiProvider = localStorage.getItem('aiProvider') || 'openai';
            
            // Initialize processor
            scriptProcessor = new ScriptProcessor();
            
            // Load current project
            currentProject = JSON.parse(localStorage.getItem('currentProject') || 'null');
            
            if (!currentProject) {
                console.error('‚ùå No project found');
                showError('No project selected', 'Please return to the projects page and select a project');
                return;
            }
            
            console.log('‚úÖ Project loaded:', currentProject.title);
            document.getElementById('projectTitle').textContent = currentProject.title + ' - Script Breakdown';
            
            // Load tags and notes if they exist
            sceneTags = currentProject.sceneTags || {};
            sceneNotes = currentProject.sceneNotes || {};
            
            // Try to load processed script first
            const projectId = currentProject.title.replace(/\s+/g, '_').toLowerCase();
            const processedScript = scriptProcessor.loadScriptData(projectId);
            
            if (processedScript) {
                console.log('‚úÖ Found processed script in storage');
                parsedScript = processedScript;
                displayScript();
            } else if (currentProject.scriptContent) {
                console.log('üìÑ Found raw script content, processing...');
                processScript(currentProject.scriptContent);
            } else {
                console.log('‚ö†Ô∏è No script content found');
                showError('No script found', 'Please upload a script from the projects page');
            }
            
            // Setup event listeners
            document.getElementById('sceneSearch').addEventListener('input', handleSceneSearch);
        }

        // Process script text
        function processScript(scriptText) {
            showLoading('Parsing screenplay...');
            updateDebug(`Processing ${scriptText.length} characters...`);
            
            try {
                // Parse the script
                parsedScript = scriptProcessor.parseScreenplay(scriptText);
                
                updateDebug(`Found ${parsedScript.scenes.length} scenes`);
                
                if (parsedScript.scenes.length === 0) {
                    hideLoading();
                    showError('No scenes detected', 'The script parser couldn\'t find any scene headings.');
                    return;
                }
                
                // Save processed script
                const projectId = currentProject.title.replace(/\s+/g, '_').toLowerCase();
                scriptProcessor.saveScriptData(projectId, parsedScript);
                
                // Display the script
                displayScript();
                hideLoading();
                
            } catch (error) {
                console.error('Processing error:', error);
                hideLoading();
                showError('Processing Error', error.message);
            }
        }

        // Reprocess script from scratch
        function reprocessScript() {
            if (currentProject && currentProject.scriptContent) {
                console.log('üîÑ Reprocessing script...');
                processScript(currentProject.scriptContent);
            } else {
                alert('No script to reprocess');
            }
        }

        // Display parsed script
        function displayScript() {
            if (!parsedScript || !parsedScript.scenes) return;
            
            // Update scene count
            document.getElementById('sceneCount').textContent = parsedScript.scenes.length;
            
            // Generate scene list
            const sceneList = document.getElementById('sceneList');
            sceneList.innerHTML = '';
            
            parsedScript.scenes.forEach((scene, index) => {
                const sceneItem = document.createElement('div');
                sceneItem.className = 'scene-item';
                if (index === 0) sceneItem.classList.add('active');
                sceneItem.onclick = () => scrollToScene(index);
                
                sceneItem.innerHTML = `
                    <div class="scene-number">${index + 1}</div>
                    <div class="scene-heading">${scene.text}</div>
                `;
                
                sceneList.appendChild(sceneItem);
            });
            
            // Generate script HTML
            const scriptHTML = scriptProcessor.formatScriptHTML(parsedScript);
            document.getElementById('scriptContent').innerHTML = scriptHTML;
            
            // Load tags for first scene
            if (parsedScript.scenes.length > 0) {
                displayTagsForScene(0);
            }
            
            updateDebug(`Displayed ${parsedScript.scenes.length} scenes, ${parsedScript.metadata.characters.length} characters`);
        }

        // Display tags for a specific scene
        function displayTagsForScene(sceneIndex) {
            const tags = sceneTags[sceneIndex + 1] || [];
            const panel = document.getElementById('taggingPanel');
            
            const categories = [
                { id: 'makeup', name: 'Makeup', color: 'var(--tag-makeup)' },
                { id: 'hair', name: 'Hair', color: 'var(--tag-hair)' },
                { id: 'sfx', name: 'SFX', color: 'var(--tag-sfx)' },
                { id: 'cast', name: 'Cast', color: 'var(--tag-cast)' },
                { id: 'wardrobe', name: 'Wardrobe', color: 'var(--tag-wardrobe)' },
                { id: 'props', name: 'Props', color: 'var(--tag-props)' }
            ];
            
            let html = '';
            
            // AI suggestions banner
            const aiSuggestions = tags.filter(t => t.aiSuggested && !t.accepted);
            if (aiSuggestions.length > 0) {
                html += `<div class="ai-banner">ü§ñ ${aiSuggestions.length} AI suggestions pending review</div>`;
            }
            
            // Category sections
            categories.forEach(category => {
                const categoryTags = tags.filter(t => t.category === category.id);
                const aiTags = categoryTags.filter(t => t.aiSuggested && !t.accepted);
                const confirmedTags = categoryTags.filter(t => t.accepted || !t.aiSuggested);
                
                html += `<div class="tag-section">`;
                html += `<div class="tag-section-title">
                    ${category.name} 
                    ${categoryTags.length > 0 ? `<span class="tag-count">${categoryTags.length}</span>` : ''}
                </div>`;
                
                // AI suggested tags
                if (aiTags.length > 0) {
                    html += '<div class="tag-list">';
                    aiTags.forEach((tag, i) => {
                        const tagId = `${sceneIndex + 1}_${category.id}_${i}`;
                        html += `<div class="tag-item ai-suggested">
                            <div><span class="tag-badge">AI</span>${tag.description}</div>
                            <div class="tag-actions">
                                <button class="tag-action-btn accept" onclick="acceptTag(${sceneIndex + 1}, '${category.id}', ${i})">‚úì</button>
                                <button class="tag-action-btn reject" onclick="rejectTag(${sceneIndex + 1}, '${category.id}', ${i})">‚úï</button>
                            </div>
                        </div>`;
                    });
                    html += '</div>';
                }
                
                // Confirmed tags
                if (confirmedTags.length > 0) {
                    html += '<div class="tag-list">';
                    confirmedTags.forEach((tag, i) => {
                        html += `<div class="tag-item">
                            <div>${tag.description}</div>
                            <button class="tag-action-btn reject" onclick="removeTag(${sceneIndex + 1}, '${category.id}', ${i})">‚úï</button>
                        </div>`;
                    });
                    html += '</div>';
                }
                
                html += `<button class="add-tag-btn" onclick="addManualTag(${sceneIndex + 1}, '${category.id}')">+ Add ${category.name}</button>`;
                html += '</div>';
            });
            
            panel.innerHTML = html;
        }

        // AI Analysis
        async function runAIAnalysis() {
            if (!apiKey) {
                openSettings();
                alert('Please configure your API key first');
                return;
            }
            
            if (!parsedScript || parsedScript.scenes.length === 0) {
                alert('No scenes to analyze');
                return;
            }
            
            const numScenes = parsedScript.scenes.length;
            if (!confirm(`Analyze ${numScenes} scene${numScenes > 1 ? 's' : ''} with AI? This will use your API credits.`)) {
                return;
            }
            
            showLoading(`Analyzing scene 1 of ${numScenes}...`);
            
            try {
                for (let i = 0; i < parsedScript.scenes.length; i++) {
                    const scene = parsedScript.scenes[i];
                    document.getElementById('loadingText').textContent = `Analyzing scene ${i + 1} of ${numScenes}...`;
                    
                    // Get scene text
                    const sceneText = scene.rawText || scene.elements.map(e => e.text).join('\n');
                    
                    // Call AI API
                    const suggestions = await scriptProcessor.analyzeSceneForTags(sceneText, apiKey, aiProvider);
                    
                    // Add suggestions to tags
                    if (!sceneTags[i + 1]) {
                        sceneTags[i + 1] = [];
                    }
                    
                    suggestions.forEach(s => {
                        // Check if tag already exists
                        const exists = sceneTags[i + 1].some(t => 
                            t.category === s.category && 
                            t.description.toLowerCase() === s.description.toLowerCase()
                        );
                        
                        if (!exists) {
                            sceneTags[i + 1].push({
                                category: s.category,
                                description: s.description,
                                aiSuggested: true,
                                accepted: false
                            });
                        }
                    });
                    
                    // Small delay between API calls
                    if (i < parsedScript.scenes.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
                
                // Save and update display
                saveProjectData();
                displayTagsForScene(currentScene);
                
                hideLoading();
                alert(`AI analysis complete! Found tags for ${numScenes} scenes.`);
                
            } catch (error) {
                console.error('AI analysis error:', error);
                hideLoading();
                alert('Error during AI analysis: ' + error.message);
            }
        }

        // Tag management functions
        function acceptTag(sceneNumber, category, tagIndex) {
            const categoryTags = (sceneTags[sceneNumber] || []).filter(t => 
                t.category === category && t.aiSuggested && !t.accepted
            );
            
            if (categoryTags[tagIndex]) {
                categoryTags[tagIndex].accepted = true;
                saveProjectData();
                displayTagsForScene(currentScene);
            }
        }

        function rejectTag(sceneNumber, category, tagIndex) {
            const aiTags = (sceneTags[sceneNumber] || []).filter(t => 
                t.category === category && t.aiSuggested && !t.accepted
            );
            
            if (aiTags[tagIndex]) {
                sceneTags[sceneNumber] = sceneTags[sceneNumber].filter(t => t !== aiTags[tagIndex]);
                saveProjectData();
                displayTagsForScene(currentScene);
            }
        }

        function removeTag(sceneNumber, category, tagIndex) {
            const confirmedTags = (sceneTags[sceneNumber] || []).filter(t => 
                t.category === category && (t.accepted || !t.aiSuggested)
            );
            
            if (confirmedTags[tagIndex]) {
                sceneTags[sceneNumber] = sceneTags[sceneNumber].filter(t => t !== confirmedTags[tagIndex]);
                saveProjectData();
                displayTagsForScene(currentScene);
            }
        }

        function addManualTag(sceneNumber, category) {
            const description = prompt(`Add ${category} tag:`);
            if (!description) return;
            
            if (!sceneTags[sceneNumber]) {
                sceneTags[sceneNumber] = [];
            }
            
            sceneTags[sceneNumber].push({
                category: category,
                description: description,
                aiSuggested: false,
                accepted: true
            });
            
            saveProjectData();
            displayTagsForScene(currentScene);
        }

        // Save project data
        function saveProjectData() {
            if (currentProject) {
                currentProject.sceneTags = sceneTags;
                currentProject.sceneNotes = sceneNotes;
                currentProject.scenes = parsedScript ? parsedScript.scenes.length : 0;
                currentProject.characters = parsedScript ? parsedScript.metadata.characters.length : 0;
                
                localStorage.setItem('currentProject', JSON.stringify(currentProject));
                
                // Also update in projects list
                const projects = JSON.parse(localStorage.getItem('checksHappyProjects') || '[]');
                const projectIndex = projects.findIndex(p => p.title === currentProject.title);
                if (projectIndex !== -1) {
                    projects[projectIndex] = currentProject;
                    localStorage.setItem('checksHappyProjects', JSON.stringify(projects));
                }
            }
        }

        // Navigation functions
        function scrollToScene(sceneIndex) {
            currentScene = sceneIndex;
            
            // Update active state
            document.querySelectorAll('.scene-item').forEach((item, index) => {
                item.classList.toggle('active', index === sceneIndex);
            });
            
            // Scroll to scene
            const sceneElement = document.getElementById(`scene-${sceneIndex + 1}`);
            if (sceneElement) {
                sceneElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            // Update tags panel
            displayTagsForScene(sceneIndex);
            
            // Load notes
            document.getElementById('notesTextarea').value = sceneNotes[sceneIndex + 1] || '';
        }

        function handleSceneSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            const sceneItems = document.querySelectorAll('.scene-item');
            
            sceneItems.forEach((item, index) => {
                const heading = parsedScript.scenes[index].text.toLowerCase();
                item.style.display = heading.includes(searchTerm) ? 'block' : 'none';
            });
        }

        function switchTab(tab) {
            document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'tags') {
                document.querySelector('.sidebar-tab:nth-child(1)').classList.add('active');
                document.getElementById('tagsTab').classList.add('active');
            } else {
                document.querySelector('.sidebar-tab:nth-child(2)').classList.add('active');
                document.getElementById('notesTab').classList.add('active');
            }
        }

        // Settings modal
        function openSettings() {
            document.getElementById('aiProvider').value = aiProvider;
            document.getElementById('apiKey').value = apiKey;
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function saveSettings() {
            apiKey = document.getElementById('apiKey').value.trim();
            aiProvider = document.getElementById('aiProvider').value;
            
            localStorage.setItem('aiApiKey', apiKey);
            localStorage.setItem('aiProvider', aiProvider);
            
            closeSettings();
            alert('Settings saved!');
        }

        // Debug functions
        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            panel.classList.toggle('active');
        }

        function updateDebug(info) {
            const debugInfo = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.innerHTML = `[${timestamp}] ${info}<br>` + debugInfo.innerHTML;
        }

        // UI Helper functions
        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function showError(title, message) {
            document.getElementById('scriptContent').innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 3em; margin-bottom: 20px;">‚ö†Ô∏è</div>
                    <div style="font-size: 1.25em; font-weight: 600; margin-bottom: 10px;">${title}</div>
                    <div style="font-size: 0.875em;">${message}</div>
                </div>
            `;
        }

        function goBack() {
            window.location.href = 'dashboard.html';
        }

        function generateBreakdown() {
            if (!parsedScript) {
                alert('Please load a script first');
                return;
            }
            
            // Count total tags
            let totalTags = 0;
            Object.values(sceneTags).forEach(tags => {
                totalTags += tags.filter(t => t.accepted || !t.aiSuggested).length;
            });
            
            alert(`Ready to generate breakdown!\n\nScenes: ${parsedScript.scenes.length}\nCharacters: ${parsedScript.metadata.characters.length}\nTags: ${totalTags}`);
        }

        // Modal outside click
        document.getElementById('settingsModal').addEventListener('click', function(e) {
            if (e.target === this) closeSettings();
        });

        // Save notes on change
        document.getElementById('notesTextarea').addEventListener('change', function() {
            sceneNotes[currentScene + 1] = this.value;
            saveProjectData();
        });

        // Initialize on page load
        init();
    </script>
</body>
</html>
