# Character Profile Debug Guide

This guide helps troubleshoot issues with character profile data not displaying properly.

## Quick Fix Commands

Open the browser console (F12) and run these commands:

### 1. Check All Data
```javascript
window.debugAllData()
```
Shows complete report of all data sources and what's available.

### 2. Sync Contexts
```javascript
window.syncMasterContexts()
```
Synchronizes `masterContext` and `scriptMasterContext` (sometimes they get out of sync).

### 3. Fix Missing Character Data
```javascript
window.fixCharacterData()
```
Attempts to automatically fix missing character profile data.

### 4. Debug Specific Character
```javascript
window.debugCharacterProfile('CHARACTER_NAME')
```
Shows all available data for a specific character (e.g., `window.debugCharacterProfile('EINAR')`).

### 5. Test with Sample Script
```javascript
window.testAnalysis()
```
Loads a sample script and runs analysis to verify the system is working.

## Common Issues and Solutions

### Issue 1: Characters appear in tabs but profiles are empty

**Symptoms:**
- Character tabs show in the center panel
- Clicking on a character shows "No Character Profile Data"
- Profile tab is empty

**Solution:**
```javascript
// Step 1: Check what data exists
window.debugAllData()

// Step 2: Sync contexts if they're out of sync
window.syncMasterContexts()

// Step 3: Refresh the page
location.reload()
```

### Issue 2: No characters detected after script import

**Symptoms:**
- Script imported successfully
- No character tabs appear
- No character data in profiles

**Solution:**
```javascript
// Run comprehensive analysis manually
await window.debugProcessScript()

// Or test with sample script first
await window.testAnalysis()
```

### Issue 3: Data exists but doesn't display

**Symptoms:**
- `window.debugAllData()` shows character data exists
- Character tabs don't show it

**Solution:**
```javascript
// Extract character list from context
if (window.masterContext?.characters) {
    window.confirmedCharacters = Object.keys(window.masterContext.characters);
    createCharacterTabs(); // Rebuild character tabs
}
```

## Data Flow Explanation

The application uses multiple data stores:

1. **window.scriptMasterContext** - Primary comprehensive analysis (NEW)
   - Generated by `performComprehensiveAnalysis()`
   - Stored in `localStorage.scriptMasterContext`
   - Contains rich character profiles with all analysis data

2. **window.masterContext** - Legacy context (OLD)
   - Used by some older functions
   - Should be synced with scriptMasterContext
   - Stored in `localStorage.masterContext`

3. **window.scriptNarrativeContext** - Narrative analysis
   - Story structure, character importance
   - Additional analysis layer

4. **state object** - Runtime application state
   - Scene data, breakdowns, UI state
   - Not persisted directly (reconstructed from localStorage)

### How Character Profiles Work

1. **Import Script** → Parses screenplay into scenes
2. **Run Analysis** → AI analyzes characters, creates comprehensive profiles
3. **Store Context** → Saves to `window.scriptMasterContext` and localStorage
4. **Extract Characters** → Populates `window.confirmedCharacters` array
5. **Create Tabs** → Generates character tabs in UI
6. **Display Profile** → `renderProfileView()` reads from `scriptMasterContext`

## Step-by-Step Debug Process

### When character profiles are empty:

1. **Check if analysis was run:**
   ```javascript
   window.debugAllData()
   // Look for: ✅ window.scriptMasterContext: EXISTS
   ```

2. **If NO data exists:**
   ```javascript
   // Re-run analysis
   await window.debugProcessScript()
   ```

3. **If data exists in one context but not the other:**
   ```javascript
   // Sync contexts
   window.syncMasterContexts()
   // Reload page
   location.reload()
   ```

4. **If data exists but characters list is empty:**
   ```javascript
   // Extract character list
   window.confirmedCharacters = Object.keys(window.scriptMasterContext.characters);
   // Rebuild tabs
   createCharacterTabs()
   ```

5. **Verify specific character:**
   ```javascript
   window.debugCharacterProfile('EINAR')
   // Should show: ✅ Found in Master Context
   ```

## Running Manual Analysis

If AI analysis fails, you can run manual character extraction:

```javascript
// The debug system will automatically fall back to manual extraction
// It finds character names from dialogue and creates basic profiles
await window.debugProcessScript()
```

This creates basic profiles with:
- Character name
- Script descriptions (if found)
- Placeholder physical profile
- Placeholder character analysis
- Placeholder visual profile

You can then enhance these manually or re-run with AI when API is configured.

## Checking API Configuration

```javascript
// Check if API key is configured
const hasOpenAI = !!localStorage.getItem('openai-api-key');
const hasAnthropic = !!localStorage.getItem('anthropic-api-key');

console.log('OpenAI configured:', hasOpenAI);
console.log('Anthropic configured:', hasAnthropic);
```

If no API key:
1. Click gear icon (⚙️) in top-right
2. Click "AI Settings"
3. Enter your API key
4. Save settings

## Advanced Debugging

### View raw context data:
```javascript
console.log(window.scriptMasterContext)
console.log(window.masterContext)
console.log(window.scriptNarrativeContext)
```

### View localStorage:
```javascript
const lsMaster = localStorage.getItem('scriptMasterContext');
console.log(JSON.parse(lsMaster));
```

### Clear all data and start fresh:
```javascript
// WARNING: This deletes all character analysis data!
localStorage.removeItem('masterContext');
localStorage.removeItem('scriptMasterContext');
window.masterContext = null;
window.scriptMasterContext = null;
window.confirmedCharacters = [];
location.reload();
```

## Testing the System

Run this to verify everything works:

```javascript
// Run complete test
await window.testAnalysis()

// Check results
window.debugAllData()

// View character profile
// Click on "EINAR" tab in the UI, or:
window.debugCharacterProfile('EINAR')
```

Expected output:
```
✅ TEST SUCCESSFUL!
   Characters created: EINAR, PETER LAWSON, GWEN LAWSON
```

## Getting Help

If issues persist after trying these solutions:

1. **Collect debug info:**
   ```javascript
   window.debugAllData()
   ```

2. **Check console for errors:**
   - Open browser console (F12)
   - Look for red error messages
   - Note the file and line number

3. **Report with this info:**
   - What command you ran
   - What the console output showed
   - Any error messages
   - What you expected vs. what happened

## Summary of Available Debug Commands

| Command | Purpose |
|---------|---------|
| `window.debugAllData()` | Complete data report |
| `window.debugProcessScript()` | Debug script import process |
| `window.testAnalysis()` | Test with sample script |
| `window.syncMasterContexts()` | Sync data contexts |
| `window.fixCharacterData()` | Auto-fix missing data |
| `window.debugCharacterProfile(name)` | Debug specific character |
| `window.getMasterContext()` | Get master context object |
| `window.getAllCharacterNames()` | Get list of all characters |
| `window.logMasterContextSummary()` | Log context summary |
